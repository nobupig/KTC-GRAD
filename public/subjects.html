<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="kindai.png">
  <title>è¿‘å¤§é«˜å°‚ æˆç¸¾ã‚·ã‚¹ãƒ†ãƒ  | ç§‘ç›®ç™»éŒ²</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¹ã‚¿ã‚¤ãƒ« -->
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: #f3f4f6;
      color: #111827;
    }
    header {
      background: #004A99; /* è¿‘å¤§ãƒ–ãƒ«ãƒ¼ */
      color: #fff;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      font-size: 18px;
      margin: 0;
    }
    header .user-info {
      font-size: 12px;
      text-align: right;
    }
    header button {
      border: none;
      padding: 6px 12px;
      margin-top: 4px;
      border-radius: 999px;
      cursor: pointer;
    }
    main {
      max-width: 1100px;
      margin: 20px auto;
      background: #fff;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.06);
    }
    h2 {
      margin-top: 0;
      font-size: 20px;
      border-left: 4px solid #004A99;
      padding-left: 10px;
    }
    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
      align-items: end;
    }
    .field label {
      font-size: 12px;
      color: #4b5563;
      display: block;
      margin-bottom: 4px;
    }
    select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      background: #fff;
    }
    .btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .btn-primary {
      background: #004A99;
      color: #fff;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .status {
      font-size: 13px;
      color: #6b7280;
      margin: 4px 0 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 13px;
    }
    thead {
      background: #f9fafb;
    }
    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 6px 8px;
      text-align: left;
      white-space: nowrap;
    }
    th:first-child, td:first-child {
      text-align: center;
      width: 40px;
    }
    tbody tr:hover {
      background: #f3f4f6;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      background: #eff6ff;
      color: #1d4ed8;
    }
    .footer-actions {
      margin-top: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 13px;
    }
    .error {
      color: #b91c1c;
      font-size: 13px;
      margin-top: 4px;
    }
    dialog {
      border: none;
      border-radius: 16px;
      padding: 20px;
      max-width: 420px;
      width: 100%;
    }
    dialog::backdrop {
      background: rgba(0,0,0,0.25);
    }
    dialog h3 {
      margin-top: 0;
      font-size: 18px;
    }
    .modal-actions {
      margin-top: 16px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    .selected-list {
      max-height: 200px;
      overflow-y: auto;
      margin-top: 8px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 8px;
      background: #f9fafb;
      font-size: 13px;
    }
    .no-data {
      padding: 16px;
      text-align: center;
      font-size: 13px;
      color: #6b7280;
      background: #f9fafb;
      border-radius: 12px;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <header>
    <img src="kindai.png" alt="æ ¡ç« " style="width:32px; height:32px; margin-right:12px;">
    <h1>è¿‘å¤§é«˜å°‚ æˆç¸¾ã‚·ã‚¹ãƒ†ãƒ ï½œç§‘ç›®ç™»éŒ²</h1>
    <div class="user-info">
      <div id="userEmail">ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±å–å¾—ä¸­...</div>
      <button id="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </header>

  <div style="max-width:1100px; margin: 10px auto; text-align:right;">
  <button id="viewModeBtn" class="btn btn-secondary"
    onclick="location.href='view.html'">
    ğŸ“„ é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹ã
  </button>
</div>

<div id="periodBlock" style="
  display:none;
  max-width:650px;
  margin:40px auto;
  background:white;
  padding:30px;
  border-radius:16px;
  box-shadow:0 8px 25px rgba(0,0,0,0.1);
  text-align:center;
">
  <h2 style="margin-top:0;color:#b91c1c;">ç¾åœ¨ã¯æˆç¸¾å…¥åŠ›æœŸé–“å¤–ã§ã™</h2>
  <p style="font-size:14px;color:#374151;margin-top:10px;">
    æˆç¸¾ã®ä¿®æ­£ãƒ»å¤‰æ›´ã¯è¡Œãˆã¾ã›ã‚“ãŒã€å…¥åŠ›æ¸ˆã¿ã®æˆç¸¾ã¯é–²è¦§ã§ãã¾ã™ã€‚
  </p>

  <button class="btn btn-primary" style="margin-top:20px;"
    onclick="location.href='view.html'">
    ğŸ“„ é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹ã
  </button>
</div>

  <main>
    <h2>æ‹…å½“ç§‘ç›®ã®é¸æŠ</h2>
    <p class="status">
      å­¦å¹´ãƒ»ã‚³ãƒ¼ã‚¹ãƒ»é–‹è¬›æœŸã‚’é¸ã‚“ã§ã€Œç§‘ç›®ã‚’èª­ã¿è¾¼ã‚€ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚<br>
      éƒ½å¸‚ç’°å¢ƒã¯ <strong>C / CC / CA ã‚’ã¾ã¨ã‚ã¦è¡¨ç¤º</strong> ã—ã¾ã™ã€‚
    </p>

    <!-- ãƒ•ã‚£ãƒ«ã‚¿ã‚¨ãƒªã‚¢ -->
    <div class="filters">
      <div class="field">
        <label for="gradeSelect">å­¦å¹´</label>
        <select id="gradeSelect">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="1">1å¹´</option>
          <option value="2">2å¹´</option>
          <option value="3">3å¹´</option>
          <option value="4">4å¹´</option>
          <option value="5">5å¹´</option>
        </select>
      </div>

      <div class="field">
        <label for="courseSelect">ã‚³ãƒ¼ã‚¹</label>
        <select id="courseSelect">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="G">ä¸€èˆ¬ï¼ˆGï¼‰</option>
          <option value="M">æ©Ÿæ¢°ã‚·ã‚¹ãƒ†ãƒ ï¼ˆMï¼‰</option>
          <option value="E">é›»æ°—é›»å­ï¼ˆEï¼‰</option>
          <option value="I">åˆ¶å¾¡æƒ…å ±ï¼ˆIï¼‰</option>
          <!-- â˜… C/CC/CA ã‚’çµ±åˆè¡¨ç¤º -->
          <option value="C_ALL">éƒ½å¸‚ç’°å¢ƒï¼ˆC / CC / CAï¼‰</option>
          <!-- å¿…è¦ãªã‚‰ S2 ãªã©ã‚’è¿½åŠ  -->
        </select>
      </div>

         <div class="field">
        <label>&nbsp;</label>
        <button id="loadBtn" class="btn btn-secondary">ç§‘ç›®ã‚’èª­ã¿è¾¼ã‚€</button>
      </div>
    </div>

    <div id="loadStatus" class="status"></div>
    <div id="loadError" class="error"></div>

    <!-- ç§‘ç›®ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« -->
    <div id="tableContainer">
      <table id="subjectsTable" hidden>
        <thead>
          <tr>
            <th>é¸æŠ</th>
            <th>ç§‘ç›®å</th>
            <th>å­¦å¹´</th>
            <th>ã‚³ãƒ¼ã‚¹</th>
            <th>é–‹è¬›æœŸ</th>
            <th>å±¥ä¿®åŒºåˆ†</th>
          </tr>
        </thead>
        <tbody id="subjectsTbody"></tbody>
      </table>
   
    </div>

    <div class="footer-actions">
      <div>
        <span id="selectedCount">é¸æŠä¸­ï¼š0ä»¶</span>
      </div>
      <div>
        <button id="saveBtn" class="btn btn-primary" disabled>é¸æŠã—ãŸç§‘ç›®ã‚’ç™»éŒ²</button>
      </div>
    </div>

    <div id="saveStatus" class="status"></div>
    <div id="saveError" class="error"></div>

    <!-- è‡ªåˆ†ãŒæ‹…å½“ã™ã‚‹ã¯ãšã®ç§‘ç›®ãŒä¸€è¦§ã«ç„¡ã„ã¨ãç”¨ã®é€£çµ¡ãƒœã‚¿ãƒ³ -->
<div id="contactOfficeAnytimeArea"
     style="margin:12px 0 0; font-size:13px; color:#374151;">
  æ‹…å½“ã—ã¦ã„ã‚‹ã¯ãšã®ç§‘ç›®ãŒä¸€è¦§ã«ãªã„å ´åˆã¯ã€æ•™å‹™ã¸é€£çµ¡ã—ã¦ãã ã•ã„ã€‚
  <button id="contactOfficeAnytimeBtn"
          class="btn btn-secondary"
          style="margin-left:8px; padding:5px 12px; font-size:12px;">
    æ•™å‹™ã¸é€£çµ¡ã™ã‚‹
  </button>
</div>

  </main>

  <!-- ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <dialog id="confirmDialog">
    <h3>æ‹…å½“ç§‘ç›®ã¨ã—ã¦ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ</h3>
    <p style="font-size:13px;">
      ä»¥ä¸‹ã®ç§‘ç›®ã‚’ <strong>æ‹…å½“ç§‘ç›®</strong> ã¨ã—ã¦ç™»éŒ²ã—ã¾ã™ã€‚å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
      ï¼ˆç™»éŒ²æ¸ˆã¿ã®ç§‘ç›®ã¯ã“ã®ãƒªã‚¹ãƒˆã«ç½®ãæ›ãˆã‚‰ã‚Œã¾ã™ï¼‰
    </p>
    <div id="selectedList" class="selected-list"></div>
    <div class="modal-actions">
      <button id="cancelConfirmBtn" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button id="okConfirmBtn" class="btn btn-primary">ç™»éŒ²ã™ã‚‹</button>
    </div>
  </dialog>

  <!-- Firebase & ãƒ­ã‚¸ãƒƒã‚¯ -->
  <script type="module">
    // ===== Firebase åˆæœŸåŒ– =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      getDocs,
      doc,
      setDoc,
      serverTimestamp,
      getDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

//----------------------------------------------------------
// æˆç¸¾å…¥åŠ›æœŸé–“ãƒã‚§ãƒƒã‚¯ï¼šå‰æœŸ/å¾ŒæœŸ/æœŸé–“å¤–ã‚’åˆ¤å®š
//----------------------------------------------------------
async function checkInputPeriod() {
  // UI ã®ä¸»è¦éƒ¨åˆ†
  const mainArea = document.querySelector("main");
  const periodBlock = document.getElementById("periodBlock");

  // Firestore ã® period è¨­å®šã‚’å–å¾—
  const ref = doc(db, "settings", "period");
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    // æœŸé–“ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã‚‚ã€ŒæœŸé–“å¤–ã€ã¨æ‰±ã†
    periodBlock.style.display = "block";
    mainArea.style.display = "none";
    return { mode: "none" };
  }

  const p = snap.data();

  const now = new Date();
  const firstStart  = new Date(p.firstStart);
  const firstEnd    = new Date(p.firstEnd);
  const secondStart = new Date(p.secondStart);
  const secondEnd   = new Date(p.secondEnd);

  let mode = "none";  // åˆæœŸå€¤ï¼šæœŸé–“å¤–

  if (now >= firstStart && now <= firstEnd) {
    mode = "first";   // å‰æœŸ
  } else if (now >= secondStart && now <= secondEnd) {
    mode = "second";  // å¾ŒæœŸ
  }

  // æœŸé–“å¤–ã®å ´åˆã¯UIãƒ–ãƒ­ãƒƒã‚¯
  if (mode === "none") {
    periodBlock.style.display = "block";
    mainArea.style.display = "none";
  } else {
    // æœŸé–“ä¸­ â†’ main ã¯è¡¨ç¤ºã€ãƒ–ãƒ­ãƒƒã‚¯éè¡¨ç¤º
    periodBlock.style.display = "none";
    mainArea.style.display = "block";
  }

  return { mode };
}

let periodMode = "none";


    // â˜…ã“ã“ã¯ã”è‡ªèº«ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®šã«å·®ã—æ›¿ãˆ
    const firebaseConfig = {
      apiKey: "AIzaSyB-ykIzRvYbc5osV6WATu6BSOJt_zlHkgM",
      authDomain: "ktc-grade-system.firebaseapp.com",
      projectId: "ktc-grade-system",
      storageBucket: "ktc-grade-system.appspot.com",
      messagingSenderId: "490169300362",
      appId: "1:490169300362:web:7c6e7b47a394d68d514473"
    };


    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== DOM å–å¾— =====
    const userEmailEl = document.getElementById("userEmail");
    const logoutBtn = document.getElementById("logoutBtn");

    const gradeSelect = document.getElementById("gradeSelect");
    const courseSelect = document.getElementById("courseSelect");
    const loadBtn = document.getElementById("loadBtn");

    // â˜… å­¦å¹´å¤‰æ›´æ™‚ã«ã‚³ãƒ¼ã‚¹è‡ªå‹•åˆ¶å¾¡ï¼ˆ1ãƒ»2å¹´ã¯Gå›ºå®šï¼‰
gradeSelect.addEventListener("change", () => {
  const grade = gradeSelect.value;

  if (grade === "1" || grade === "2") {
    courseSelect.value = "G";
    courseSelect.disabled = true;
  } else {
    courseSelect.disabled = false;
  }
});


    const loadStatus = document.getElementById("loadStatus");
    const loadError = document.getElementById("loadError");

    const subjectsTable = document.getElementById("subjectsTable");
    const subjectsTbody = document.getElementById("subjectsTbody");
       const selectedCount = document.getElementById("selectedCount");
    const saveBtn = document.getElementById("saveBtn");
    const saveStatus = document.getElementById("saveStatus");
    const saveError = document.getElementById("saveError");

    const confirmDialog = document.getElementById("confirmDialog");
    const selectedList = document.getElementById("selectedList");
    const cancelConfirmBtn = document.getElementById("cancelConfirmBtn");
    const okConfirmBtn = document.getElementById("okConfirmBtn");

    const noSubjectDialog = document.getElementById("noSubjectDialog");
    const mailFromDialogBtn = document.getElementById("mailFromDialogBtn");
    const closeNoSubjectDialogBtn = document.getElementById("closeNoSubjectDialogBtn");

    // ==== ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ç›£è¦– ====
    let currentUser = null;

  onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }
  currentUser = user;
  userEmailEl.textContent = `${user.email}`;

  // â˜…â˜…â˜… ã“ã“ã§æˆç¸¾å…¥åŠ›æœŸé–“ã‚’åˆ¤å®š â˜…â˜…â˜…
  const period = await checkInputPeriod();
  periodMode = period.mode;

  // æœŸé–“å¤–ãªã‚‰ã“ã®å¾Œã® UI å…¨ã¦éè¡¨ç¤º
  if (periodMode === "none") return;
});

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "login.html";
    });

    // ===== ç§‘ç›®èª­ã¿è¾¼ã¿å‡¦ç† =====
    loadBtn.addEventListener("click", () => {
      loadSubjects();
    });

    async function loadSubjects() {
      saveStatus.textContent = "";
      saveError.textContent = "";

      const grade = gradeSelect.value;
      const courseKey = courseSelect.value;
      
      if (!grade || !courseKey) {
        loadError.textContent = "å­¦å¹´ã¨ã‚³ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚";
        return;
      }
      loadError.textContent = "";

      // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
      subjectsTbody.innerHTML = "";
      subjectsTable.hidden = true;
      updateSelectedCount();
      saveBtn.disabled = true;

      // ã‚³ãƒ¼ã‚¹æ¡ä»¶ï¼šC_ALL ã¯ C/CC/CA ã‚’ã¾ã¨ã‚ã¦æ¤œç´¢
      let courseValues;
      if (courseKey === "C_ALL") {
        courseValues = ["C", "CC", "CA"];
      } else {
        courseValues = [courseKey];
      }

      loadStatus.textContent = "ç§‘ç›®ã‚’èª­ã¿è¾¼ã¿ä¸­...";
      try {
        const constraints = [
          where("grade", "==", grade)
        ];

        // course: in æ¤œç´¢
        if (courseValues.length === 1) {
          constraints.push(where("course", "==", courseValues[0]));
        } else {
          constraints.push(where("course", "in", courseValues));
        }

        // é–‹è¬›æœŸãƒ•ã‚£ãƒ«ã‚¿
      // â˜… æˆç¸¾å…¥åŠ›æœŸé–“ã«å¿œã˜ãŸå›ºå®šã‚»ãƒ¡ã‚¹ã‚¿ãƒ¼
if (periodMode === "first") {
  constraints.push(where("semester", "==", "å‰æœŸ"));
} else if (periodMode === "second") {
  constraints.push(where("semester", "in", ["å¾ŒæœŸ", "é€šå¹´"]));
} else {
}


        const q = query(collection(db, "subjects"), ...constraints);
        const snap = await getDocs(q);

        const rows = [];
        snap.forEach((docSnap) => {
          const data = docSnap.data();
          rows.push({
            id: docSnap.id,
            name: data.name ?? "",
            grade: data.grade ?? "",
            course: data.course ?? "",
            semester: data.semester ?? "",
            required: data.required === true,
            specialType: data.specialType ?? 0,
            isSkillLevel: data.isSkillLevel === true,
            passRule: data.passRule ?? "fixed60",
            fixedPassLine: data.fixedPassLine ?? 60,
            useAdjustment: data.useAdjustment ?? false
          });
        });

        // è¡¨ã«åæ˜ 
        for (const s of rows) {
          const tr = document.createElement("tr");
          tr.dataset.id = s.id;

          const tdCheck = document.createElement("td");
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.addEventListener("change", updateSelectedCount);
          tdCheck.appendChild(checkbox);

          const tdName = document.createElement("td");
          tdName.textContent = s.name;

          const tdGrade = document.createElement("td");
          tdGrade.textContent = s.grade + "å¹´";

          const tdCourse = document.createElement("td");
          tdCourse.textContent = s.course;

          const tdSemester = document.createElement("td");
          tdSemester.textContent = s.semester;

          const tdRequired = document.createElement("td");
          tdRequired.innerHTML = s.required
            ? '<span class="badge">å¿…ä¿®</span>'
            : '<span class="badge" style="background:#fef3c7;color:#92400e;">é¸æŠ</span>';

          tr.appendChild(tdCheck);
          tr.appendChild(tdName);
          tr.appendChild(tdGrade);
          tr.appendChild(tdCourse);
          tr.appendChild(tdSemester);
          tr.appendChild(tdRequired);
        
          subjectsTbody.appendChild(tr);
        }

        subjectsTable.hidden = false;
        loadStatus.textContent = `ç§‘ç›®ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ${rows.length}ä»¶ï¼‰ã€‚ãƒã‚§ãƒƒã‚¯ã‚’ä»˜ã‘ã¦ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚`;
      } catch (err) {
        console.error(err);
        loadStatus.textContent = "";
        loadError.textContent = "ç§‘ç›®ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Firestoreã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­å®šã‚‚å«ã‚ã¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
      }
    }

    function getSelectedSubjects() {
      const result = [];
      const trs = subjectsTbody.querySelectorAll("tr");
      trs.forEach((tr) => {
        const check = tr.querySelector("input[type='checkbox']");
        if (check && check.checked) {
          const tds = tr.querySelectorAll("td");
          result.push({
            id: tr.dataset.id,
            name: tds[1].textContent,
            grade: tds[2].textContent.replace("å¹´", ""),
            course: tds[3].textContent,
            semester: tds[4].textContent
          });
        }
      });
      return result;
    }

    function updateSelectedCount() {
      const selected = getSelectedSubjects();
      selectedCount.textContent = `é¸æŠä¸­ï¼š${selected.length}ä»¶`;
      saveBtn.disabled = selected.length === 0;
    }

    // ===== ä¿å­˜å‡¦ç†ï¼ˆteacherSubjects ã¸ç™»éŒ²ï¼‰ =====
    saveBtn.addEventListener("click", () => {
      const selected = getSelectedSubjects();
      if (!selected.length) return;

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ä¸€è¦§ã‚’è¡¨ç¤º
      selectedList.innerHTML = "";
      selected.forEach((s) => {
        const div = document.createElement("div");
        div.textContent = `${s.grade}å¹´ / ${s.course} / ${s.semester} / ${s.name}`;
        selectedList.appendChild(div);
      });

      confirmDialog.showModal();
    });

    cancelConfirmBtn.addEventListener("click", () => {
      confirmDialog.close();
    });

    okConfirmBtn.addEventListener("click", async () => {
      saveStatus.textContent = "";
      saveError.textContent = "";

      const selected = getSelectedSubjects();
      if (!selected.length) {
        confirmDialog.close();
        return;
      }
      if (!currentUser) {
        saveError.textContent = "ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚ã„ã£ãŸã‚“ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚";
        confirmDialog.close();
        return;
      }

      saveStatus.textContent = "æ‹…å½“ç§‘ç›®ã‚’ç™»éŒ²ä¸­...";
      try {
        // teacherSubjects ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
        // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã¯ user.email ã‚’æ¡ç”¨ï¼ˆteachers ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¨åŒã˜ã‚­ãƒ¼æ€æƒ³ï¼‰
        const ref = doc(db, "teacherSubjects", currentUser.email);

        const payload = {
          teacherEmail: currentUser.email,
          teacherUid: currentUser.uid,
          subjects: selected.map((s) => ({
            subjectId: s.id,
            name: s.name,
            grade: s.grade,
            course: s.course,
            semester: s.semester
          })),
          updatedAt: serverTimestamp()
        };

        // æ—¢å­˜ subjects ã¯ã“ã®ãƒªã‚¹ãƒˆã«ã€Œç½®ãæ›ãˆã€ã‚‹é‹ç”¨
        await setDoc(ref, payload, { merge: true });

        saveStatus.textContent = "æ‹…å½“ç§‘ç›®ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚";
        saveError.textContent = "";
      } catch (err) {
        console.error(err);
        saveError.textContent = "æ‹…å½“ç§‘ç›®ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¾ãŸã¯ Firestore æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
      } finally {
        confirmDialog.close();
      }
    });

    // ===== ç§‘ç›®ãªã—æ™‚ï¼šæ•™å‹™ã¸ãƒ¡ãƒ¼ãƒ« =====
    function buildMailToLink() {
      const grade = gradeSelect.value || "";
      const courseKey = courseSelect.value || "";
      
      let courseLabel = courseKey;
      if (courseKey === "C_ALL") {
        courseLabel = "éƒ½å¸‚ç’°å¢ƒï¼ˆC/CC/CAï¼‰";
      }

      // â˜…æ•™å‹™ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã“ã“ã«è¨­å®š
      const officeMail = "nyasui@ktc.ac.jp";

      const subject = encodeURIComponent("ã€ç§‘ç›®ãƒã‚¹ã‚¿ç¢ºèªä¾é ¼ã€‘ç§‘ç›®ä¸€è¦§ã«è¡¨ç¤ºã•ã‚Œãªã„ç§‘ç›®ã«ã¤ã„ã¦");
      const bodyLines = [
        "æ•™å‹™ã”æ‹…å½“è€…æ§˜",
        "",
        "æˆç¸¾ã‚·ã‚¹ãƒ†ãƒ ï¼ˆFirebaseç‰ˆï¼‰ã®ç§‘ç›®ç™»éŒ²ç”»é¢ã§ã€è©²å½“ã™ã‚‹ç§‘ç›®ãŒè¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚",
        "ç§‘ç›®ãƒã‚¹ã‚¿ã®å†…å®¹ã‚’ã”ç¢ºèªã„ãŸã ã‘ã¾ã™ã§ã—ã‚‡ã†ã‹ã€‚",
        "",
        `å­¦å¹´ï¼š${grade ? grade + "å¹´" : "-"}`,
        `ã‚³ãƒ¼ã‚¹ï¼š${courseLabel || "-"}`,
         "",
        `æ•™å“¡ãƒ¡ãƒ¼ãƒ«ï¼š${currentUser ? currentUser.email : ""}`,
        "",
        "ãŠæ‰‹æ•°ã‚’ãŠã‹ã‘ã—ã¾ã™ãŒã€ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚"
      ];
      const body = encodeURIComponent(bodyLines.join("\n"));
      return `mailto:${officeMail}?subject=${subject}&body=${body}`;
    }
const contactOfficeAnytimeBtn =
  document.getElementById("contactOfficeAnytimeBtn");

if (contactOfficeAnytimeBtn) {
  contactOfficeAnytimeBtn.addEventListener("click", () => {
    window.location.href = buildMailToLink();
  });
}

  </script>
</body>
</html>
