<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="kindai.png">
  <title>è¿‘å¤§é«˜å°‚ æˆç¸¾ã‚·ã‚¹ãƒ†ãƒ  | ç§‘ç›®ç™»éŒ²</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: #f3f4f6;
      color: #111827;
    }
    header {
      background: #004A99;
      color: #fff;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 { font-size: 18px; margin: 0; }
    header .user-info { font-size: 12px; text-align: right; }
    header button {
      border: none; padding: 6px 12px;
      border-radius: 999px; cursor: pointer;
    }

    main {
      max-width: 1100px;
      margin: 20px auto;
      background: #fff;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.06);
    }
    h2 {
      font-size: 20px;
      border-left: 4px solid #004A99;
      padding-left: 10px;
      margin-top: 0;
    }

    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px; margin-bottom: 16px;
    }
    .field label {
      font-size: 12px; color: #4b5563;
      margin-bottom: 4px; display: block;
    }
    select, input, textarea {
      width: 100%; padding: 6px 8px;
      border-radius: 8px; border: 1px solid #d1d5db;
      font-size: 14px;
      box-sizing: border-box;
    }

    .btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-primary { background: #004A99; color: white; }
    .btn-secondary { background: #e5e7eb; color: #111; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .status { font-size: 13px; color: #6b7280; margin: 4px 0 10px; }
    .error { color: #b91c1c; font-size: 13px; margin-top: 4px; }

    table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 13px; }
    thead { background: #f9fafb; }
    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 6px 8px; white-space: nowrap;
    }
    th:first-child, td:first-child {
      text-align: center;
      width: 40px;
    }
    tbody tr:hover { background: #f3f4f6; }

    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      background: #eff6ff;
      color: #1d4ed8;
    }

    .footer-actions {
      margin-top: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 13px;
    }

    dialog {
      border: none; padding: 20px;
      border-radius: 16px; width: 100%;
      max-width: 420px;
    }
    dialog::backdrop { background: rgba(0,0,0,0.25); }
    .modal-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 20px; }
  </style>
</head>
<body>
 <header>
  <img src="kindai.png" alt="æ ¡ç« " style="width:32px; height:32px; margin-right:12px;">

  <h1>è¿‘å¤§é«˜å°‚ æˆç¸¾ã‚·ã‚¹ãƒ†ãƒ ï½œç§‘ç›®ç™»éŒ²</h1>

  <div class="user-info" style="display:flex; align-items:center; gap:10px;">
    <button id="viewModeBtn" class="btn btn-secondary" style="font-size:12px;"
      onclick="location.href='view.html'">
      ğŸ“„ é–²è¦§ãƒ¢ãƒ¼ãƒ‰
    </button>

    <button id="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
</header>

<!-- â˜… ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ï¼ˆå¸¯ã®ä¸‹ã«é…ç½®ï¼‰ -->
<div id="userInfoDisplay"
     style="font-size:14px; padding:10px 20px; color:#111827;">
</div>


  <!-- æˆç¸¾å…¥åŠ›æœŸé–“å¤–ãƒ–ãƒ­ãƒƒã‚¯ -->
  <div id="periodBlock" style="
    display:none;
    max-width:650px;
    margin:40px auto;
    background:white;
    padding:30px;
    border-radius:16px;
    box-shadow:0 8px 25px rgba(0,0,0,0.1);
    text-align:center;
  ">
    <h2 style="margin-top:0;color:#b91c1c;">ç¾åœ¨ã¯æˆç¸¾å…¥åŠ›æœŸé–“å¤–ã§ã™</h2>
    <p style="font-size:14px;color:#374151;margin-top:10px;">
      æˆç¸¾ã®ä¿®æ­£ãƒ»å¤‰æ›´ã¯è¡Œãˆã¾ã›ã‚“ãŒã€å…¥åŠ›æ¸ˆã¿ã®æˆç¸¾ã¯é–²è¦§ã§ãã¾ã™ã€‚
    </p>

    <button class="btn btn-primary" style="margin-top:20px;"
      onclick="location.href='view.html'">
      ğŸ“„ é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹ã
    </button>
  </div>

  <main>
    <h2>æ‹…å½“ç§‘ç›®ã®é¸æŠ</h2>
    <p class="status">
      å­¦å¹´ãƒ»ã‚³ãƒ¼ã‚¹ã‚’é¸ã‚“ã§ã€Œç§‘ç›®ã‚’èª­ã¿è¾¼ã‚€ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚<br>
      éƒ½å¸‚ç’°å¢ƒã¯ <strong>C / CC / CA ã‚’ã¾ã¨ã‚ã¦è¡¨ç¤º</strong> ã—ã¾ã™ã€‚
    </p>

    <!-- ãƒ•ã‚£ãƒ«ã‚¿ã‚¨ãƒªã‚¢ -->
    <div class="filters">
      <div class="field">
        <label for="gradeSelect">å­¦å¹´</label>
        <select id="gradeSelect">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="1">1å¹´</option>
          <option value="2">2å¹´</option>
          <option value="3">3å¹´</option>
          <option value="4">4å¹´</option>
          <option value="5">5å¹´</option>
        </select>
      </div>

      <div class="field">
        <label for="courseSelect">ã‚³ãƒ¼ã‚¹</label>
        <select id="courseSelect">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="G">ä¸€èˆ¬ï¼ˆGï¼‰</option>
          <option value="M">æ©Ÿæ¢°ã‚·ã‚¹ãƒ†ãƒ ï¼ˆMï¼‰</option>
          <option value="E">é›»æ°—é›»å­ï¼ˆEï¼‰</option>
          <option value="I">åˆ¶å¾¡æƒ…å ±ï¼ˆIï¼‰</option>
          <!-- â˜… C/CC/CA ã‚’çµ±åˆè¡¨ç¤º -->
          <option value="C_ALL">éƒ½å¸‚ç’°å¢ƒï¼ˆC / CC / CAï¼‰</option>
        </select>
      </div>

      <div class="field">
        <label>&nbsp;</label>
        <button id="loadBtn" class="btn btn-secondary">ç§‘ç›®ã‚’èª­ã¿è¾¼ã‚€</button>
        <button id="evalBtn" class="btn btn-secondary" style="margin-left:8px;">
          ğŸ“ è©•ä¾¡åŸºæº–å…¥åŠ›
        </button>
      </div>
    </div>

    <div id="loadStatus" class="status"></div>
    <div id="loadError" class="error"></div>

    <!-- ç§‘ç›®ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« -->
    <div id="tableContainer">
      <table id="subjectsTable" hidden>
        <thead>
          <tr>
            <th>é¸æŠ</th>
            <th>ç§‘ç›®å</th>
            <th>å­¦å¹´</th>
            <th>ã‚³ãƒ¼ã‚¹</th>
            <th>é–‹è¬›æœŸ</th>
            <th>å±¥ä¿®åŒºåˆ†</th>
          </tr>
        </thead>
        <tbody id="subjectsTbody"></tbody>
      </table>
    </div>

    <div class="footer-actions">
      <div>
        <span id="selectedCount">é¸æŠä¸­ï¼š0ä»¶</span>
      </div>
      <div>
        <button id="saveBtn" class="btn btn-primary" disabled>é¸æŠã—ãŸç§‘ç›®ã‚’ç™»éŒ²</button>
      </div>
    </div>

    <div id="saveStatus" class="status"></div>
    <div id="saveError" class="error"></div>

    <!-- è‡ªåˆ†ãŒæ‹…å½“ã™ã‚‹ã¯ãšã®ç§‘ç›®ãŒä¸€è¦§ã«ç„¡ã„ã¨ãç”¨ã®é€£çµ¡ãƒœã‚¿ãƒ³ -->
    <div id="contactOfficeAnytimeArea"
         style="margin:12px 0 0; font-size:13px; color:#374151;">
      æ‹…å½“ã—ã¦ã„ã‚‹ã¯ãšã®ç§‘ç›®ãŒä¸€è¦§ã«ãªã„å ´åˆã¯ã€æ•™å‹™ã¸é€£çµ¡ã—ã¦ãã ã•ã„ã€‚
      <button id="contactOfficeAnytimeBtn"
              class="btn btn-secondary"
              style="margin-left:8px; padding:5px 12px; font-size:12px;">
        æ•™å‹™ã¸é€£çµ¡ã™ã‚‹
      </button>
    </div>

  </main>

  <!-- æ‹…å½“ç§‘ç›®ç™»éŒ² ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <dialog id="confirmDialog">
    <h3>æ‹…å½“ç§‘ç›®ã¨ã—ã¦ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ</h3>
    <p style="font-size:13px;">
      ä»¥ä¸‹ã®ç§‘ç›®ã‚’ <strong>æ‹…å½“ç§‘ç›®</strong> ã¨ã—ã¦ç™»éŒ²ã—ã¾ã™ã€‚å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
      ï¼ˆç™»éŒ²æ¸ˆã¿ã®ç§‘ç›®ã¯ã“ã®ãƒªã‚¹ãƒˆã«ç½®ãæ›ãˆã‚‰ã‚Œã¾ã™ï¼‰
    </p>
    <div id="selectedList" class="selected-list"></div>
    <div class="modal-actions">
      <button id="cancelConfirmBtn" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button id="okConfirmBtn" class="btn btn-primary">ç™»éŒ²ã™ã‚‹</button>
    </div>
  </dialog>

  <dialog id="evalConfirmDialog">
    <h3>è©•ä¾¡åŸºæº–å…¥åŠ›ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ</h3>
    <p style="font-size:13px;">
      ä»¥ä¸‹ã®æ‹…å½“ç§‘ç›®ã«å¯¾ã—ã¦è©•ä¾¡åŸºæº–ã‚’è¨­å®šã§ãã¾ã™ã€‚
    </p>
    <div id="evalRegisteredList" style="margin:10px 0;"></div>

    <div class="modal-actions">
      <button id="evalCancelBtn" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button id="evalOkBtn" class="btn btn-primary">è©•ä¾¡åŸºæº–å…¥åŠ›ã¸</button>
    </div>
  </dialog>

  <!-- æ•™å‹™é€£çµ¡ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæ–°ä»•æ§˜ï¼‰ -->
  <dialog id="officeContactDialog">
    <h3>æ•™å‹™ã¸é€£çµ¡</h3>
    <p style="font-size:13px;">
      ç§‘ç›®ä¸€è¦§ã«è‡ªèº«ãŒæ‹…å½“ã™ã‚‹ã¯ãšã®ç§‘ç›®ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã«ã€æ•™å‹™ã¸é€£çµ¡ã§ãã¾ã™ã€‚
    </p>

    <div class="field">
      <label>å­¦å¹´</label>
      <select id="contactGradeSelect">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        <option value="1">1å¹´</option>
        <option value="2">2å¹´</option>
        <option value="3">3å¹´</option>
        <option value="4">4å¹´</option>
        <option value="5">5å¹´</option>
      </select>
    </div>

    <div class="field">
      <label>ã‚³ãƒ¼ã‚¹</label>
      <select id="contactCourseSelect">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        <option value="G">ä¸€èˆ¬ï¼ˆGï¼‰</option>
        <option value="M">æ©Ÿæ¢°ã‚·ã‚¹ãƒ†ãƒ ï¼ˆMï¼‰</option>
        <option value="E">é›»æ°—é›»å­ï¼ˆEï¼‰</option>
        <option value="I">åˆ¶å¾¡æƒ…å ±ï¼ˆIï¼‰</option>
        <option value="C_ALL">éƒ½å¸‚ç’°å¢ƒï¼ˆC/CC/CAï¼‰</option>
      </select>
    </div>

    <div class="field">
      <label>ç§‘ç›®åï¼ˆæ‰‹å…¥åŠ›ï¼‰</label>
      <input id="contactSubjectName" type="text" placeholder="ä¾‹ï¼šæ•°å­¦â… ">
    </div>

    <div class="field">
      <label>æ•™å“¡åï¼ˆè‡ªå‹•å…¥åŠ›ï¼‰</label>
      <input id="contactTeacherName" type="text" readonly style="background:#f3f4f6;">
    </div>

    <div class="field">
      <label>è¿½åŠ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ï¼‰</label>
      <textarea id="contactMessage" rows="3"
        placeholder="ç§‘ç›®ã‚³ãƒ¼ãƒ‰ã‚„è£œè¶³ãŒã‚ã‚Œã°è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚"></textarea>
    </div>

    <p style="font-size:12px; color:#6b7280;">
      â€»é€ä¿¡å†…å®¹ã¯æˆç¸¾ç®¡ç†ç”»é¢ã®ãŠçŸ¥ã‚‰ã›ã¨ã—ã¦æ•™å‹™ãŒç¢ºèªã—ã¾ã™ã€‚<br>
      â€»å¿…è¦ã«å¿œã˜ã¦ã€Slackã§ã‚‚ä½µã›ã¦æ•™å‹™éƒ¨ã¸é€£çµ¡ã—ã¦ãã ã•ã„ã€‚
    </p>

    <div class="modal-actions">
      <button id="officeContactCancel" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button id="officeContactSend" class="btn btn-primary">é€ä¿¡</button>
    </div>
  </dialog>

  <!-- Firebase & ãƒ­ã‚¸ãƒƒã‚¯ -->
  <script type="module">
    // ===== Firebase åˆæœŸåŒ– =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      getDocs,
      doc,
      setDoc,
      serverTimestamp,
      getDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // â˜…ã“ã“ã¯ã”è‡ªèº«ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyB-ykIzRvYbc5osV6WATu6BSOJt_zlHkgM",
      authDomain: "ktc-grade-system.firebaseapp.com",
      projectId: "ktc-grade-system",
      storageBucket: "ktc-grade-system.appspot.com",
      messagingSenderId: "490169300362",
      appId: "1:490169300362:web:7c6e7b47a394d68d514473"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== DOM å–å¾— =====
    const userInfoDisplay = document.getElementById("userInfoDisplay");
    const logoutBtn = document.getElementById("logoutBtn");

    const gradeSelect = document.getElementById("gradeSelect");
    const courseSelect = document.getElementById("courseSelect");
    const loadBtn = document.getElementById("loadBtn");

    const loadStatus = document.getElementById("loadStatus");
    const loadError = document.getElementById("loadError");

    const subjectsTable = document.getElementById("subjectsTable");
    const subjectsTbody = document.getElementById("subjectsTbody");
    const selectedCount = document.getElementById("selectedCount");
    const saveBtn = document.getElementById("saveBtn");
    const saveStatus = document.getElementById("saveStatus");
    const saveError = document.getElementById("saveError");

    const confirmDialog = document.getElementById("confirmDialog");
    const selectedList = document.getElementById("selectedList");
    const cancelConfirmBtn = document.getElementById("cancelConfirmBtn");
    const okConfirmBtn = document.getElementById("okConfirmBtn");

    const periodBlock = document.getElementById("periodBlock");
    const mainArea = document.querySelector("main");

    // æ•™å‹™é€£çµ¡ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
    const contactOfficeAnytimeBtn = document.getElementById("contactOfficeAnytimeBtn");
    const officeContactDialog = document.getElementById("officeContactDialog");
    const contactGradeSelect = document.getElementById("contactGradeSelect");
    const contactCourseSelect = document.getElementById("contactCourseSelect");
    const contactSubjectName = document.getElementById("contactSubjectName");
    const contactTeacherName = document.getElementById("contactTeacherName");
    const contactMessage = document.getElementById("contactMessage");
    const officeContactCancel = document.getElementById("officeContactCancel");
    const officeContactSend = document.getElementById("officeContactSend");

    // ===== çŠ¶æ…‹ =====
    let currentUser = null;
    let currentTeacherName = "";
    let periodMode = "none";

    //----------------------------------------------------------
    // æˆç¸¾å…¥åŠ›æœŸé–“ãƒã‚§ãƒƒã‚¯ï¼šå‰æœŸ/å¾ŒæœŸ/æœŸé–“å¤–ã‚’åˆ¤å®š
    //----------------------------------------------------------
    async function checkInputPeriod() {
      const ref = doc(db, "settings", "period");
      const snap = await getDoc(ref);

      if (!snap.exists()) {
        periodBlock.style.display = "block";
        mainArea.style.display = "none";
        return { mode: "none" };
      }

      const p = snap.data();
      const now = new Date();
      const firstStart  = new Date(p.firstStart);
      const firstEnd    = new Date(p.firstEnd);
      const secondStart = new Date(p.secondStart);
      const secondEnd   = new Date(p.secondEnd);

      let mode = "none";

      if (now >= firstStart && now <= firstEnd) {
        mode = "first";   // å‰æœŸ
      } else if (now >= secondStart && now <= secondEnd) {
        mode = "second";  // å¾ŒæœŸ
      }

      if (mode === "none") {
        periodBlock.style.display = "block";
        mainArea.style.display = "none";
      } else {
        periodBlock.style.display = "none";
        mainArea.style.display = "block";
      }

      return { mode };
    }

    // ===== æ•™å“¡åã®èª­ã¿è¾¼ã¿ï¼ˆteachers ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ =====
    async function loadTeacherName() {
      if (!currentUser) return;

      const ref = doc(db, "teachers", currentUser.email);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        currentTeacherName = snap.data().name || "";
      } else {
        currentTeacherName = "";
      }
    }

    // ==== ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ç›£è¦– ====
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      currentUser = user;
      await loadTeacherName();
      userInfoDisplay.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${currentTeacherName}ï¼ˆ${user.email}ï¼‰`;

      // æˆç¸¾å…¥åŠ›æœŸé–“ãƒã‚§ãƒƒã‚¯
      const period = await checkInputPeriod();
      periodMode = period.mode;

      if (periodMode === "none") {
        // æœŸé–“å¤–ï¼šç§‘ç›®ç™»éŒ²UIã¯è¡¨ç¤ºã—ãªã„ï¼ˆperiodBlock ãŒå‡ºã¦ã„ã‚‹ï¼‰
        return;
      }
    });

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "login.html";
    });

    // â˜… å­¦å¹´å¤‰æ›´æ™‚ã«ã‚³ãƒ¼ã‚¹è‡ªå‹•åˆ¶å¾¡ï¼ˆ1ãƒ»2å¹´ã¯Gå›ºå®šï¼‰
    gradeSelect.addEventListener("change", () => {
      const grade = gradeSelect.value;
      if (grade === "1" || grade === "2") {
        courseSelect.value = "G";
        courseSelect.disabled = true;
      } else {
        courseSelect.disabled = false;
      }
    });

    // ===== ç§‘ç›®èª­ã¿è¾¼ã¿å‡¦ç† =====
    loadBtn.addEventListener("click", () => {
      loadSubjects();
    });

    async function loadSubjects() {
      saveStatus.textContent = "";
      saveError.textContent = "";

      const grade = gradeSelect.value;
      const courseKey = courseSelect.value;
      
      if (!grade || !courseKey) {
        loadError.textContent = "å­¦å¹´ã¨ã‚³ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚";
        return;
      }
      loadError.textContent = "";

      // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
      subjectsTbody.innerHTML = "";
      subjectsTable.hidden = true;
      updateSelectedCount();
      saveBtn.disabled = true;

      // ã‚³ãƒ¼ã‚¹æ¡ä»¶ï¼šC_ALL ã¯ C/CC/CA ã‚’ã¾ã¨ã‚ã¦æ¤œç´¢
      let courseValues;
      if (courseKey === "C_ALL") {
        courseValues = ["C", "CC", "CA"];
      } else {
        courseValues = [courseKey];
      }

      loadStatus.textContent = "ç§‘ç›®ã‚’èª­ã¿è¾¼ã¿ä¸­...";
      try {
        const constraints = [
          where("grade", "==", grade)
        ];

        // course æ¡ä»¶
        if (courseValues.length === 1) {
          constraints.push(where("course", "==", courseValues[0]));
        } else {
          constraints.push(where("course", "in", courseValues));
        }

        // æˆç¸¾å…¥åŠ›æœŸé–“ã«å¿œã˜ã¦é–‹è¬›æœŸã‚’åˆ¶å¾¡
        if (periodMode === "first") {
          constraints.push(where("semester", "==", "å‰æœŸ"));
        } else if (periodMode === "second") {
          constraints.push(where("semester", "in", ["å¾ŒæœŸ", "é€šå¹´"]));
        }

        const q = query(collection(db, "subjects"), ...constraints);
        const snap = await getDocs(q);

        const rows = [];
        snap.forEach((docSnap) => {
          const data = docSnap.data();
          rows.push({
            id: docSnap.id,
            name: data.name ?? "",
            grade: data.grade ?? "",
            course: data.course ?? "",
            semester: data.semester ?? "",
            required: data.required === true,
            // â˜… ç‰¹åˆ¥ç§‘ç›®ãƒ•ãƒ©ã‚°ï¼ˆæœªè¨­å®šã¯ falseï¼‰
            specialType: data.specialType === true
          });
        });

        // è¡¨ã«åæ˜ 
        for (const s of rows) {
          const tr = document.createElement("tr");
          tr.dataset.id = s.id;
          tr.dataset.specialType = s.specialType ? "1" : "0";

          const tdCheck = document.createElement("td");
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.addEventListener("change", updateSelectedCount);
          tdCheck.appendChild(checkbox);

          const tdName = document.createElement("td");
          tdName.textContent = s.name;

          const tdGrade = document.createElement("td");
          tdGrade.textContent = s.grade + "å¹´";

          const tdCourse = document.createElement("td");
          tdCourse.textContent = s.course;

          const tdSemester = document.createElement("td");
          tdSemester.textContent = s.semester;

          const tdRequired = document.createElement("td");
          tdRequired.innerHTML = s.required
            ? '<span class="badge">å¿…ä¿®</span>'
            : '<span class="badge" style="background:#fef3c7;color:#92400e;">é¸æŠ</span>';

          tr.appendChild(tdCheck);
          tr.appendChild(tdName);
          tr.appendChild(tdGrade);
          tr.appendChild(tdCourse);
          tr.appendChild(tdSemester);
          tr.appendChild(tdRequired);
        
          subjectsTbody.appendChild(tr);
        }

        subjectsTable.hidden = false;
        loadStatus.textContent = `ç§‘ç›®ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ${rows.length}ä»¶ï¼‰ã€‚ãƒã‚§ãƒƒã‚¯ã‚’ä»˜ã‘ã¦ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚`;
      } catch (err) {
        console.error(err);
        loadStatus.textContent = "";
        loadError.textContent = "ç§‘ç›®ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Firestoreã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­å®šã‚‚å«ã‚ã¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
      }
    }

    function getSelectedSubjects() {
      const result = [];
      const trs = subjectsTbody.querySelectorAll("tr");
      trs.forEach((tr) => {
        const check = tr.querySelector("input[type='checkbox']");
        if (check && check.checked) {
          const tds = tr.querySelectorAll("td");
          result.push({
            id: tr.dataset.id,
            name: tds[1].textContent,
            grade: tds[2].textContent.replace("å¹´", ""),
            course: tds[3].textContent,
            semester: tds[4].textContent,
            // â˜… data-special-type ã‚’ boolean ã«å¤‰æ›
            specialType: tr.dataset.specialType === "1"
          });
        }
      });
      return result;
    }

    function updateSelectedCount() {
      const selected = getSelectedSubjects();
      selectedCount.textContent = `é¸æŠä¸­ï¼š${selected.length}ä»¶`;
      saveBtn.disabled = selected.length === 0;
    }

    // ===== ä¿å­˜å‡¦ç†ï¼ˆteacherSubjects ã¸ç™»éŒ²ï¼‰ =====
    saveBtn.addEventListener("click", () => {
      const selected = getSelectedSubjects();
      if (!selected.length) return;

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ä¸€è¦§ã‚’è¡¨ç¤º
      selectedList.innerHTML = "";
      selected.forEach((s) => {
        const div = document.createElement("div");
        div.textContent = `${s.grade}å¹´ / ${s.course} / ${s.semester} / ${s.name}`;
        selectedList.appendChild(div);
      });

      confirmDialog.showModal();
    });

    cancelConfirmBtn.addEventListener("click", () => {
      confirmDialog.close();
    });

    okConfirmBtn.addEventListener("click", async () => {
  saveStatus.textContent = "";
  saveError.textContent = "";

  const selected = getSelectedSubjects();
  if (!selected.length) {
    confirmDialog.close();
    return;
  }
  if (!currentUser) {
    saveError.textContent = "ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚ã„ã£ãŸã‚“ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚";
    confirmDialog.close();
    return;
  }

  saveStatus.textContent = "æ‹…å½“ç§‘ç›®ã‚’ç™»éŒ²ä¸­...";

    try {
      // â˜… è¿½åŠ ï¼šå¹´åº¦ã‚’å–å¾—
      const currentYear = new Date().getFullYear();

      // â˜… teacherSubjects_2025 / teacherSubjects_2026 â€¦ã¸æ›¸ãè¾¼ã¿
      const ref = doc(db, `teacherSubjects_${currentYear}`, currentUser.email);

      const existingSnap = await getDoc(ref);
      let oldSubjects = [];
      if (existingSnap.exists()) {
        oldSubjects = existingSnap.data().subjects || [];
      }

      const newSubjects = selected.map((s) => ({
        subjectId: s.id,
        name: s.name,
        grade: s.grade,
        course: s.course,
        semester: s.semester,
        // â˜… è¿½åŠ ï¼šç‰¹åˆ¥ç§‘ç›®ãƒ•ãƒ©ã‚°
        specialType: s.specialType === true
      }));

      const merged = [...oldSubjects, ...newSubjects];
      const unique = merged.filter(
        (item, index, self) =>
          index === self.findIndex((t) => t.subjectId === item.subjectId)
      );

      await setDoc(ref, {
        teacherEmail: currentUser.email,
        teacherUid: currentUser.uid,
        subjects: unique,
        updatedAt: serverTimestamp()
      }, { merge: true });

    saveStatus.textContent = "æ‹…å½“ç§‘ç›®ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚";
    saveError.textContent = "";

  } catch (err) {
    console.error(err);
    saveError.textContent =
      "æ‹…å½“ç§‘ç›®ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¾ãŸã¯ Firestore æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
  } finally {
    confirmDialog.close();
  }
});


    // ============================
    // æ•™å‹™é€£çµ¡ãƒ¢ãƒ¼ãƒ€ãƒ«å‡¦ç†
    // ============================
    // å­¦å¹´å¤‰æ›´æ™‚ï¼š1ãƒ»2å¹´ãªã‚‰ã‚³ãƒ¼ã‚¹ã‚’Gå›ºå®šï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«å´ï¼‰
    contactGradeSelect.addEventListener("change", () => {
      const g = contactGradeSelect.value;
      if (g === "1" || g === "2") {
        contactCourseSelect.value = "G";
        contactCourseSelect.disabled = true;
      } else {
        contactCourseSelect.disabled = false;
      }
    });

    // ã€Œæ•™å‹™ã¸é€£çµ¡ã€ãƒœã‚¿ãƒ³ â†’ ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    if (contactOfficeAnytimeBtn) {
      contactOfficeAnytimeBtn.addEventListener("click", () => {
        if (!currentUser) {
          alert("ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚ã„ã£ãŸã‚“ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„ã€‚");
          return;
        }

        // åˆæœŸå€¤ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ ï¼ˆã‚ã‚Œã°ï¼‰
        contactGradeSelect.value = gradeSelect.value || "";
        contactCourseSelect.value = courseSelect.value || "";
        if (contactGradeSelect.value === "1" || contactGradeSelect.value === "2") {
          contactCourseSelect.value = "G";
          contactCourseSelect.disabled = true;
        } else {
          contactCourseSelect.disabled = false;
        }

        contactSubjectName.value = "";
        contactTeacherName.value = currentTeacherName || "";
        contactMessage.value = "";

        officeContactDialog.showModal();
      });
    }

    officeContactCancel.addEventListener("click", () => {
      officeContactDialog.close();
    });

    // Firestore notifications ã«ä¿å­˜
    async function sendOfficeContact() {
      if (!currentUser) {
        alert("ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚");
        return;
      }

      const grade = contactGradeSelect.value;
      const course = contactCourseSelect.value;
      const subjectName = contactSubjectName.value.trim();
      const teacherName = contactTeacherName.value.trim();
      const msg = contactMessage.value.trim() || "(ãªã—)";

      if (!grade || !course || !subjectName) {
        alert("å­¦å¹´ãƒ»ã‚³ãƒ¼ã‚¹ãƒ»ç§‘ç›®åã¯å¿…é ˆã§ã™ã€‚");
        return;
      }

      try {
        const notificationsCol = collection(db, "notifications");
        // doc(collectionRef) ã§è‡ªå‹•IDã®DocumentReferenceã‚’ä½œæˆ
        const notifRef = doc(notificationsCol);

        await setDoc(notifRef, {
          grade,
          course,
          subjectName,
          teacherName,
          teacherEmail: currentUser.email,
          message: msg,
          createdAt: serverTimestamp()
        });

        officeContactDialog.close();

        alert(
          "æ•™å‹™ã¸ã®é€£çµ¡ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚\n" +
          "æˆç¸¾ç®¡ç†ç”»é¢ã®ãŠçŸ¥ã‚‰ã›ã‹ã‚‰æ•™å‹™ãŒç¢ºèªã§ãã¾ã™ã€‚\n" +
          "å¿…è¦ã«å¿œã˜ã¦ã€Slackç­‰ã§ã‚‚ä½µã›ã¦é€£çµ¡ã—ã¦ãã ã•ã„ã€‚"
        );

      } catch (e) {
        console.error(e);
        alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¾ãŸã¯æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      }
    }

    officeContactSend.addEventListener("click", sendOfficeContact);

    // =====================================
    // è©•ä¾¡åŸºæº–å…¥åŠ›ãƒœã‚¿ãƒ³å‹•ä½œ
    // =====================================
    const evalBtn = document.getElementById("evalBtn");
    const evalDialog = document.getElementById("evalConfirmDialog");
    const evalList = document.getElementById("evalRegisteredList");
    const evalCancelBtn = document.getElementById("evalCancelBtn");
    const evalOkBtn = document.getElementById("evalOkBtn");

    evalBtn.addEventListener("click", async () => {
      if (!currentUser) {
        alert("ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const year = new Date().getFullYear();
      const ref = doc(db, `teacherSubjects_${year}`, currentUser.email);
      const snap = await getDoc(ref);

      if (!snap.exists() || !snap.data().subjects || snap.data().subjects.length === 0) {
        alert("ç™»éŒ²ã•ã‚ŒãŸæ‹…å½“ç§‘ç›®ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\nç§‘ç›®ç™»éŒ²ã‚’å®Œäº†ã—ã¦ã‹ã‚‰è©•ä¾¡åŸºæº–ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const subjects = snap.data().subjects;
      evalList.innerHTML = "";
      subjects.forEach(s => {
        const div = document.createElement("div");
        div.textContent = `${s.grade}å¹´ / ${s.course} / ${s.semester} / ${s.name}`;
        evalList.appendChild(div);
      });

      evalDialog.showModal();
    });

    evalCancelBtn.addEventListener("click", () => {
      evalDialog.close();
    });

    evalOkBtn.addEventListener("click", () => {
      location.href = "evaluation.html";
    });

  </script>
</body>
</html>
