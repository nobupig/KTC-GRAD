<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" href="kindai.png">
  <title>è¿‘å¤§é«˜å°‚ æˆç¸¾ã‚·ã‚¹ãƒ†ãƒ ï½œãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: #f3f4f6;
      color: #111827;
    }
    header {
      background: #004A99;
      color: #fff;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      font-size: 28px;
      margin: 0;
    }
    header .user-info {
      font-size: 22px;
      text-align: right;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    header button {
      border: none;
      padding: 6px 12px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 12px;
    }
    header button#logoutBtn {
      background: #ffffff;
      color: #004A99;
    }

    #userInfoArea {
      max-width: 1100px;
      margin: 4px auto 0;
      padding: 0 20px;
    }
    #userInfoDisplay {
      font-size: 14px;
      font-weight: 600;
      color: #1e3a8a;
      text-align: right;
    }

    main {
      max-width: 1100px;
      margin: 20px auto;
      background: #fff;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.06);
    }

    h2 {
      font-size: 20px;
      border-left: 4px solid #004A99;
      padding-left: 10px;
      margin-top: 0;
      margin-bottom: 12px;
    }

    p.description {
      font-size: 22px;
      color: #000000;
      margin-top: 0;
      margin-bottom: 16px;
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .card {
      background: #f9fafb;
      border-radius: 14px;
      padding: 16px;
      border: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .card h3 {
      margin: 0 0 8px;
      font-size: 24px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card p {
      font-size: 16px;
      color: #4b5563;
      margin: 0 0 12px;
    }

    .card button {
      align-self: flex-start;
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 16px;
      cursor: pointer;
    }

    .btn-primary {
      background: #004A99;
      color: #fff;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    /* ä¸€æ™‚ç„¡åŠ¹åŒ–ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆå†åˆ©ç”¨å¯èƒ½ï¼‰ */
    .is-disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }

    #statusMessage {
      margin-top: 12px;
      font-size: 13px;
      color: #4b5563;
    }
    #statusMessage strong {
      color: #111827;
    }
  </style>
</head>
<body>
  <header>
    <div style="display:flex; align-items:center; gap:12px;">
      <img src="kindai.png" alt="æ ¡ç« " style="width:32px; height:32px;">
      <h1>è¿‘å¤§é«˜å°‚ æˆç¸¾ã‚·ã‚¹ãƒ†ãƒ ï½œãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h1>
    </div>
    <div class="user-info">
      <div id="headerUserDisplay">ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š-</div>
      <button id="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </header>

  <main>
    <h2>ä½œæ¥­ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
    <p class="description">
      å‰å›ã®ç¶šãã‹ã‚‰å†é–‹ã™ã‚‹ã‹ã€æ–°ã—ã„å¹´åº¦ãƒ»ç§‘ç›®ã®å…¥åŠ›ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚<br>
      è©•ä¾¡åŸºæº–ãŒæœªå…¥åŠ›ã®ç§‘ç›®ãŒã‚ã‚‹å ´åˆã¯ã€é€”ä¸­å†é–‹ã‹ã‚‰è©•ä¾¡åŸºæº–å…¥åŠ›ç”»é¢ã«é·ç§»ã—ã¾ã™ã€‚
    </p>

    <h3 style="margin-top:20px; font-size:20px;">
  ğŸ“Š æå‡ºçŠ¶æ³ã‚µãƒãƒªãƒ¼
</h3>

<div class="unit-status-area" id="unitStatusArea">
  <!-- JSã§å‹•çš„ã«æŒ¿å…¥ -->
</div>

    <div class="cards">
      <!-- é€”ä¸­å†é–‹ -->
      <div class="card">
        <h3>ğŸ”µ é€”ä¸­å†é–‹</h3>
        <p>
          å‰å›ã®ç¶šãã‹ã‚‰å†é–‹ã—ã¾ã™ã€‚<br>
          è©•ä¾¡åŸºæº–ãŒæœªå…¥åŠ›ã®ç§‘ç›®ãŒã‚ã‚‹å ´åˆã¯ã€è©•ä¾¡åŸºæº–å…¥åŠ›ç”»é¢ã‹ã‚‰å†é–‹ã—ã¾ã™ã€‚<br>
          ã™ã¹ã¦ã®ç§‘ç›®ã®è©•ä¾¡åŸºæº–ãŒç¢ºå®šæ¸ˆã¿ã®å ´åˆã¯ã€æˆç¸¾å…¥åŠ›ç”»é¢ã«é·ç§»ã—ã¾ã™ã€‚
        </p>

  
        <button id="continueBtn" class="btn-primary">é€”ä¸­å†é–‹ã™ã‚‹</button>
      </div>

      <!-- æ–°è¦å…¥åŠ› -->
      <div class="card">
        <h3>ğŸŸ¢ æ–°è¦å…¥åŠ›ï¼ˆç§‘ç›®ç™»éŒ²ã‹ã‚‰ï¼‰</h3>
        <p>
          æ–°å¹´åº¦ã®å…¥åŠ›ã‚„ã€æ–°ãŸã«æ‹…å½“ã™ã‚‹ç§‘ç›®ãŒå¢—ãˆãŸå ´åˆã¯ã“ã¡ã‚‰ã‹ã‚‰é–‹å§‹ã—ã¾ã™ã€‚<br>
          ç§‘ç›®ç™»éŒ² â†’ è©•ä¾¡åŸºæº–å…¥åŠ› â†’ æˆç¸¾å…¥åŠ›ã®é †ã«é€²ã¿ã¾ã™ã€‚
        </p>
        <button id="newEntryBtn" class="btn-secondary">æ–°è¦å…¥åŠ›ã‚’é–‹å§‹</button>
      </div>

      <!-- é–²è¦§ãƒ¢ãƒ¼ãƒ‰ -->
      <div class="card">
        <h3>ğŸ“„ é–²è¦§ãƒ¢ãƒ¼ãƒ‰</h3>
        <p>
          ç™»éŒ²æ¸ˆã¿ã®è©•ä¾¡åŸºæº–ã‚„æˆç¸¾ã‚’ç¢ºèªã™ã‚‹ãƒ¢ãƒ¼ãƒ‰ã§ã™ã€‚<br>
          å…¥åŠ›æ“ä½œã¯è¡Œã‚ãšã€é–²è¦§ã®ã¿ã‚’è¡Œã„ãŸã„å ´åˆã«åˆ©ç”¨ã—ã¾ã™ã€‚
        </p>
        <button id="viewModeBtn" class="btn-secondary">é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹ã</button>
      </div>
    </div>

    <div id="statusMessage"></div>

<!-- ================================ -->
<!-- å…±é€šç§‘ç›® ä¿®æ­£ãƒ¦ãƒ‹ãƒƒãƒˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒ•ã‚§ãƒ¼ã‚º2ï¼‰ -->
<!-- ================================ -->
<div id="editUnitModal" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.4);
  align-items:center;
  justify-content:center;
  z-index:1000;
">
  <div style="
    background:#fff;
    padding:20px;
    border-radius:12px;
    min-width:280px;
  ">
    <h3 style="margin-top:0;">ä¿®æ­£ã™ã‚‹ãƒ¦ãƒ‹ãƒƒãƒˆã‚’é¸æŠ</h3>
    <div id="editUnitButtons" style="display:flex; gap:8px; flex-wrap:wrap;"></div>

    <div style="margin-top:16px; text-align:right;">
      <button id="editUnitCancelBtn" class="btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>


  </main>

  <script type="module">
  import { initSchoolYear } from "./js/schoolYear.js";

  // å¹´åº¦ã‚’æœ€åˆã«ç¢ºå®šï¼ˆå…¨ãƒšãƒ¼ã‚¸å…±é€šï¼‰
  initSchoolYear();

import { auth, db } from "/js/firebase_init.js";
import {
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const headerUserDisplay = document.getElementById("headerUserDisplay");
    const userInfoDisplay = document.getElementById("userInfoDisplay");

    const logoutBtn = document.getElementById("logoutBtn");
    const continueBtn = document.getElementById("continueBtn");
    const newEntryBtn = document.getElementById("newEntryBtn");
    const viewModeBtn = document.getElementById("viewModeBtn");
    const statusMessage = document.getElementById("statusMessage");

    // â˜… teacherSubjects ã« completionSummary ãŒç„¡ã„å ´åˆã®ä¿é™º

    /**
 * å…±é€šç§‘ç›®ã® unit æå‡ºçŠ¶æ³ã‚’è¡¨ç¤ºã™ã‚‹ï¼ˆãƒ•ã‚§ãƒ¼ã‚º1ï¼šè¡¨ç¤ºã®ã¿ï¼‰
 *
 * @param {HTMLElement|null} area
 * @param {object|null} completionSummary
 * @param {string} currentUserEmail
 */

// ================================
// Step.0: ãƒˆãƒƒãƒ—ç”»é¢ã«æå‡ºçŠ¶æ³ã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º
// ================================

// è¡¨ç¤ºãƒ©ãƒ™ãƒ«ç”Ÿæˆï¼ˆä¾‹ï¼š1å¹´ / G / å¾ŒæœŸ / åŸºç¤ç‰©ç†bï¼‰
function buildSubjectLabel(subj) {
  const grade = subj?.grade != null ? String(subj.grade) : "-";
  const course = subj?.course != null ? String(subj.course) : "-";
  const sem = subj?.semester != null ? String(subj.semester) : "-";
  const name = subj?.name != null ? String(subj.name) : "-";
  return grade + "å¹´ / " + course + " / " + sem + " / " + name;
}

// unit è¡¨è¨˜ï¼ˆä¾‹ï¼š["1","2"] â†’ "1ãƒ»2çµ„"ï¼‰
function formatUnits(units) {
  if (!Array.isArray(units) || units.length === 0) return "";
  return units.map(function(u){ return String(u); }).join("ãƒ»") + "çµ„";
}

function isSingleLikeCompletion(cs) {
  if (!cs) return false;
  const req = cs.requiredUnits;
  if (!Array.isArray(req) || req.length === 0) return true;
  if (req.length === 1 && (req[0] === "__SINGLE__" || req[0] === "SINGLE")) return true;
  return false;
}

function goEditMode(subj, unitKey, completionSummary) {
  const ctx = {
    editMode: true,
    year: CURRENT_YEAR,
    subjectId: subj.subjectId,
    unitKey: String(unitKey),
    requiredUnits: completionSummary?.requiredUnits ?? [],
  };

  sessionStorage.setItem("editContext", JSON.stringify(ctx));
  console.log("ğŸ›  set editContext =", ctx);

  // â˜… ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ã§ã¯ URL ã¯æ±šã•ãªã„
  location.href = "score_edit.html";
}

// subjectsï¼ˆteacherSubjectsï¼‰ã‹ã‚‰æå‡ºçŠ¶æ³ã‚’åˆ†é¡ã—ã¦æç”»
function renderStartMenuOverview(area, subjects) {
  if (!area) return;
  area.innerHTML = "";

  if (!Array.isArray(subjects) || subjects.length === 0) {
    const p = document.createElement("div");
    p.textContent = "æ‹…å½“ç§‘ç›®ãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
    p.style.fontSize = "20px";
    p.style.color = "#b22222";
    area.appendChild(p);
    return;
  }

  // Step.0 å¯¾è±¡ï¼šé€šå¸¸ç§‘ç›®ï¼ˆspecialType=0ï¼‰ã®ã¿ï¼ˆæ—¢å­˜ã® handleContinue ã¨æ•´åˆï¼‰
  const normalSubjects = subjects;

  const completed = [];
  const partial = [];
  const notSubmitted = [];
  const unknown = [];

  normalSubjects.forEach(function(subj){
    const cs = subj && subj.completionSummary ? subj.completionSummary : null;

    if (!cs) {
      unknown.push({ subj: subj, cs: null });
      return;
    }

    // å˜ä¸€ç§‘ç›®ï¼ˆrequiredUnits ãŒ SINGLE ç³»ï¼‰ or å…±é€šç§‘ç›®
    if (cs.isCompleted === true) {
      completed.push({ subj: subj, cs: cs });
      return;
    }

    // æœªå®Œäº†ï¼šå…±é€šã§ completedUnits ãŒã‚ã‚‹ãªã‚‰ã€Œä¸€éƒ¨æå‡ºã€
    const req = Array.isArray(cs.requiredUnits) ? cs.requiredUnits : [];
    const done = Array.isArray(cs.completedUnits) ? cs.completedUnits : [];

    if (!isSingleLikeCompletion(cs) && req.length > 1 && done.length > 0) {
      partial.push({ subj: subj, cs: cs });
      return;
    }

    notSubmitted.push({ subj: subj, cs: cs });
  });

  function addSection(title, items, type) {
    if (!items || items.length === 0) return;

    const h = document.createElement("div");
    h.textContent = title;
    h.style.fontSize = "13px";
    h.style.fontWeight = "700";
    h.style.margin = "10px 0 6px";
    h.style.color = "#111827";
    area.appendChild(h);

    const ul = document.createElement("ul");
    ul.style.margin = "0";
    ul.style.paddingLeft = "18px";
    ul.style.fontSize = "15px";
ul.style.lineHeight = "1.6";

items.forEach(function(it){
  const li = document.createElement("li");
  li.style.display = "flex";
  li.style.alignItems = "center";
  li.style.gap = "8px";

  const labelSpan = document.createElement("span");
  const label = buildSubjectLabel(it.subj);

  let showEdit = false;

  if (type === "completed") {
    labelSpan.textContent = "âœ” " + label;
    labelSpan.style.fontWeight = "500";
    showEdit = true;
  } else if (type === "partial") {
    const u = formatUnits(it.cs && it.cs.completedUnits ? it.cs.completedUnits : []);
    labelSpan.textContent = "â— " + label + "ï¼ˆ" + u + " æå‡ºæ¸ˆï¼‰";
    labelSpan.style.fontWeight = "500";
    showEdit = true;
  } else if (type === "not") {
    labelSpan.textContent = "ãƒ» " + label + "ï¼ˆæœªæå‡ºï¼‰";
  } else {
    labelSpan.textContent = "ãƒ» " + label + "ï¼ˆçŠ¶æ³ä¸æ˜ï¼‰";
  }

  li.appendChild(labelSpan);

// â˜… ä¿®æ­£ãƒªãƒ³ã‚¯ï¼ˆæå‡ºæ¸ˆã®ã¿ï¼‰
if (showEdit) {
  const editLink = document.createElement("a");
  editLink.textContent = "ä¿®æ­£";
  editLink.href = "#";
editLink.addEventListener("click", (e) => {
  e.preventDefault();
  startEditMode(it.subj, it.cs);
});

  editLink.style.fontSize = "12px";
  editLink.style.color = "#2563eb";
  editLink.style.textDecoration = "underline";
  editLink.style.cursor = "pointer";

  li.appendChild(editLink);
}

  ul.appendChild(li);
});


    area.appendChild(ul);
  }

  addSection("æå‡ºæ¸ˆã¿", completed, "completed");
  addSection("ä¸€éƒ¨æå‡ºï¼ˆå…±é€šç§‘ç›®ï¼‰", partial, "partial");
  addSection("æœªæå‡º", notSubmitted, "not");
  addSection("çŠ¶æ³ä¸æ˜ï¼ˆæ—§ãƒ‡ãƒ¼ã‚¿ç­‰ï¼‰", unknown, "unknown");

  // è£œè¶³
  const note = document.createElement("div");
  note.style.marginTop = "10px";
  note.style.fontSize = "14px";
  note.style.color = "#00008B";
  note.textContent =
    "â€»æ‹…å½“ã—ã¦ã„ã‚‹ã™ã¹ã¦ã®ç§‘ç›®ã®æå‡ºçŠ¶æ³ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™";
  area.appendChild(note);
}

// ================================
// â˜… ãƒ•ã‚§ãƒ¼ã‚º1ï¼šä¿®æ­£å°ç·šã®å…¥å£ã®ã¿å®Ÿè£…
// ãƒ»ä¿®æ­£ç”»é¢ã¸ã®é·ç§»ã¯ã¾ã è¡Œã‚ãªã„
// ãƒ»å…±é€šç§‘ç›®ã®ãƒ¦ãƒ‹ãƒƒãƒˆé¸æŠã¯æ¬¡ãƒ•ã‚§ãƒ¼ã‚º
// ================================
function startEditFlow(subj, completionSummary) {
 if (isSingleSubject(completionSummary)) {
  // â˜… Firestore ã« units ãŒã‚ã‚‹å ´åˆã¯ãã®ã‚­ãƒ¼ã‚’ä½¿ã†
  const units =
    Array.isArray(completionSummary.completedUnits) &&
    completionSummary.completedUnits.length > 0
      ? completionSummary.completedUnits
      : [];

  const fixedUnitKey =
    units.length === 1
      ? String(units[0])   // â† "C" ãŒå…¥ã‚‹
      : "__SINGLE__";      // æœ¬å½“ã«å˜ä¸€ã®ã¨ãã ã‘

  const ctx = {
    editMode: true,
    year: CURRENT_YEAR,
    subjectId: subj.subjectId,
    unitKey: fixedUnitKey,
    requiredUnits: completionSummary?.requiredUnits ?? [],
  };

sessionStorage.setItem("editContext", JSON.stringify(ctx));

// â˜… ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ã§ã¯ URL ã« subjectId ã‚’ä»˜ã‘ãªã„
location.href = "score_edit.html";
return;
}


  openUnitSelectModal(subj, completionSummary.completedUnits);
}




function isSingleSubject(completionSummary) {
  if (!completionSummary) return true;

  const req = completionSummary.requiredUnits;
  if (!Array.isArray(req) || req.length === 0) return true;

  if (
    req.length === 1 &&
    (req[0] === "__SINGLE__" || req[0] === "SINGLE")
  ) {
    return true;
  }

  return false;
  }

  function openUnitSelectModal(subj, units) {
  const modal = document.getElementById("editUnitModal");
  const btnArea = document.getElementById("editUnitButtons");
  const cancelBtn = document.getElementById("editUnitCancelBtn");

  btnArea.innerHTML = "";

  units.forEach(unit => {
    const btn = document.createElement("button");
    btn.textContent = unit + "çµ„";
    btn.className = "btn-primary";
    btn.addEventListener("click", () => {
      modal.style.display = "none";
      onEditUnitSelected(subj, unit);
    });
    btnArea.appendChild(btn);
  });

  cancelBtn.onclick = () => {
    modal.style.display = "none";
  };

  modal.style.display = "flex";
}

function onEditUnitSelected(subj, unitKey) {
  // â˜… å…±é€šé–¢æ•°ã«å§”è­²
  goEditMode(subj, unitKey, completionSummary);
}



    const currentYear = window.CURRENT_YEAR;
    const teacherSubjectsCol = `teacherSubjects_${currentYear}`;

    let currentUser = null;
    let currentTeacherName = "";

    // æ•™å“¡åå–å¾—
    async function loadTeacherName() {
      if (!currentUser) return;
      const ref = doc(db, "teachers", currentUser.email);
      const snap = await getDoc(ref);
      currentTeacherName = snap.exists() ? snap.data().name || "" : "";
    }

    // è©•ä¾¡åŸºæº–ã®å®Œäº†åˆ¤å®š
    async function isCriteriaCompleted(subjectId) {
      const ref = doc(db, `evaluationCriteria_${currentYear}`, subjectId);
      const snap = await getDoc(ref);
      if (!snap.exists()) return false;

      const data = snap.data();
      if (!data.items || data.items.length === 0) return false;

      const total = data.totalPercent ??
        data.items.reduce((sum, i) => sum + (i.percent || 0), 0);

      return (total >= 99 && total <= 101);
    }

    // é€”ä¸­å†é–‹å‡¦ç†
    async function handleContinue() {
      if (!currentUser) {
        alert("ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
        window.location.href = "index.html";
        return;
      }

      statusMessage.textContent = "ç¾åœ¨ã®ç™»éŒ²çŠ¶æ³ã‚’ç¢ºèªã—ã¦ã„ã¾ã™â€¦";

      const tsRef = doc(db, teacherSubjectsCol, currentUser.email);
      const tsSnap = await getDoc(tsRef);

      if (!tsSnap.exists() || !tsSnap.data().subjects || tsSnap.data().subjects.length === 0) {
        statusMessage.innerHTML =
          "<strong>ã¾ã æ‹…å½“ç§‘ç›®ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</strong> ç§‘ç›®ç™»éŒ²ç”»é¢ã¸ç§»å‹•ã—ã¾ã™ã€‚";
        setTimeout(() => {
          window.location.href = "subjects.html";
        }, 800);
        return;
      }

const subjects = tsSnap.data().subjects;

// â˜… é€šå¸¸ç§‘ç›®ï¼ˆspecialType=0ï¼‰ã®ã¿ã‚’å¯¾è±¡ã«ã™ã‚‹
const normalSubjects = subjects.filter(
  s => Number(s.specialType ?? 0) === 0
);

const notCompleted = [];

for (const subj of normalSubjects) {
  let cs = subj.completionSummary || null;



  console.log(
    "[START MENU SUBJECT]",
    subj.subjectId,
    cs?.isCompleted ?? null,
    cs?.completedUnits ?? null,
    cs?.requiredUnits ?? null
  );

const isSingle =
  Array.isArray(cs?.requiredUnits) &&
  cs.requiredUnits.length === 1 &&
  (cs.requiredUnits[0] === "__SINGLE__" || cs.requiredUnits[0] === "SINGLE");

if (!cs) {
   // completionSummary ãŒç„¡ã„ï¼æ—§ãƒ‡ãƒ¼ã‚¿
  // evaluation ã‹ã‚‰å†æ§‹ç¯‰ã•ã›ã‚‹
  notCompleted.push(subj.subjectId);
} else if (isSingle && cs.isCompleted === true) {
  // OK
} else if (cs.isCompleted !== true) {
  notCompleted.push(subj.subjectId);
}
}


      if (notCompleted.length === 0) {
        const sid = encodeURIComponent(subjects[0].subjectId);
        window.location.href = `score_input.html?subjectId=${sid}`;
      } else {
        const sid = encodeURIComponent(notCompleted[0]);
        window.location.href = `evaluation.html?subjectId=${sid}`;
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
    newEntryBtn.addEventListener("click", () => {
      window.location.href = "subjects.html";
    });

    viewModeBtn.addEventListener("click", () => {
      window.location.href = "view.html";
    });

    continueBtn.addEventListener("click", async () => {
      try {
        await handleContinue();
      } catch (e) {
        console.error("é€”ä¸­å†é–‹å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼:", e);
        alert("é€”ä¸­å†é–‹å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
        statusMessage.textContent = "";
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "index.html";
    });

// ===============================
// èªè¨¼ç›£è¦–ï¼ˆç¢ºå®šç‰ˆï¼‰
// ===============================
let authChecked = false;

onAuthStateChanged(auth, async (user) => {
  // åˆå›ã¯å¿…ãšé€šã™ï¼ˆå¾©å…ƒå¾…ã¡ï¼‰
  if (!user && !authChecked) {
    authChecked = true;
    console.log("[START] auth restoring... wait");
    return;
  }

  // å¾©å…ƒå¾Œã‚‚ user ãŒã„ãªã‘ã‚Œã°æœ¬å½“ã«æœªãƒ­ã‚°ã‚¤ãƒ³
  if (!user) {
    console.warn("[START] auth missing â†’ redirect");
    window.location.href = "index.html";
    return;
  }

  console.log("[START] auth ready:", user.email);

  currentUser = user;
  await loadTeacherName();

  const displayName = currentTeacherName || user.email;

  if (headerUserDisplay) {
    headerUserDisplay.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${displayName}`;
  }
  if (userInfoDisplay) {
    userInfoDisplay.textContent =
      `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${displayName}ï¼ˆ${user.email}ï¼‰`;
  }

  // ===== ãƒˆãƒƒãƒ—ç”»é¢ã‚µãƒãƒªãƒ¼æç”» =====
  try {
    const tsRef = doc(db, teacherSubjectsCol, user.email);
    const tsSnap = await getDoc(tsRef);

    const area = document.getElementById("unitStatusArea");
    if (!tsSnap.exists()) {
      renderStartMenuOverview(area, []);
    } else {
      const subjects = tsSnap.data()?.subjects || [];
      renderStartMenuOverview(area, subjects);
    }
  } catch (e) {
    console.error("[Start] failed to load teacherSubjects:", e);
  }
});

    // ===============================
// ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰é–‹å§‹ï¼ˆstart.htmlï¼‰
// ===============================
window.startEditMode = function (subj, completionSummary) {
  const units = Array.isArray(completionSummary?.completedUnits)
    ? completionSummary.completedUnits
    : [];

  const unitKey =
    units.length === 1
      ? String(units[0])
      : "__SINGLE__";

  const ctx = {
    editMode: true,
    year: CURRENT_YEAR,
    subjectId: subj.subjectId,
    unitKey,
    requiredUnits: completionSummary?.requiredUnits ?? [],
  };

  sessionStorage.setItem("editContext", JSON.stringify(ctx));

  console.log("âœ… set editContext =", ctx);

  location.href = "./score_edit.html";
};
  </script>
</body>
</html>
