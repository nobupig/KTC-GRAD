<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" href="kindai.png">
  <title>è¿‘å¤§é«˜å°‚ æˆç¸¾ã‚·ã‚¹ãƒ†ãƒ ï½œãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: #f3f4f6;
      color: #111827;
    }
    header {
      background: #004A99;
      color: #fff;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      font-size: 18px;
      margin: 0;
    }
    header .user-info {
      font-size: 12px;
      text-align: right;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    header button {
      border: none;
      padding: 6px 12px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 12px;
    }
    header button#logoutBtn {
      background: #ffffff;
      color: #004A99;
    }

    #userInfoArea {
      max-width: 1100px;
      margin: 4px auto 0;
      padding: 0 20px;
    }
    #userInfoDisplay {
      font-size: 14px;
      font-weight: 600;
      color: #1e3a8a;
      text-align: right;
    }

    main {
      max-width: 1100px;
      margin: 20px auto;
      background: #fff;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.06);
    }

    h2 {
      font-size: 20px;
      border-left: 4px solid #004A99;
      padding-left: 10px;
      margin-top: 0;
      margin-bottom: 12px;
    }

    p.description {
      font-size: 13px;
      color: #4b5563;
      margin-top: 0;
      margin-bottom: 16px;
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
      margin-top: 12px;
    }

    .card {
      background: #f9fafb;
      border-radius: 14px;
      padding: 16px;
      border: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .card h3 {
      margin: 0 0 8px;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card p {
      font-size: 13px;
      color: #4b5563;
      margin: 0 0 12px;
    }

    .card button {
      align-self: flex-start;
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 13px;
      cursor: pointer;
    }

    .btn-primary {
      background: #004A99;
      color: #fff;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    #statusMessage {
      margin-top: 12px;
      font-size: 13px;
      color: #4b5563;
    }
    #statusMessage strong {
      color: #111827;
    }
  </style>
</head>
<body>
  <header>
    <div style="display:flex; align-items:center; gap:12px;">
      <img src="kindai.png" alt="æ ¡ç« " style="width:32px; height:32px;">
      <h1>è¿‘å¤§é«˜å°‚ æˆç¸¾ã‚·ã‚¹ãƒ†ãƒ ï½œãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h1>
    </div>
    <div class="user-info">
      <div id="headerUserDisplay">ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š-</div>
      <button id="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </header>

  
  <main>
    <h2>ä½œæ¥­ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
    <p class="description">
      å‰å›ã®ç¶šãã‹ã‚‰å†é–‹ã™ã‚‹ã‹ã€æ–°ã—ã„å¹´åº¦ãƒ»ç§‘ç›®ã®å…¥åŠ›ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚<br>
      è©•ä¾¡åŸºæº–ãŒæœªå…¥åŠ›ã®ç§‘ç›®ãŒã‚ã‚‹å ´åˆã¯ã€é€”ä¸­å†é–‹ã‹ã‚‰è©•ä¾¡åŸºæº–å…¥åŠ›ç”»é¢ã«é·ç§»ã—ã¾ã™ã€‚
    </p>

    <div class="cards">
      <!-- é€”ä¸­å†é–‹ -->
      <div class="card">
        <h3>ğŸ”µ é€”ä¸­å†é–‹</h3>
        <p>
          å‰å›ã®ç¶šãã‹ã‚‰å†é–‹ã—ã¾ã™ã€‚<br>
          è©•ä¾¡åŸºæº–ãŒæœªå…¥åŠ›ã®ç§‘ç›®ãŒã‚ã‚‹å ´åˆã¯ã€è©•ä¾¡åŸºæº–å…¥åŠ›ç”»é¢ã‹ã‚‰å†é–‹ã—ã¾ã™ã€‚<br>
          ã™ã¹ã¦ã®ç§‘ç›®ã®è©•ä¾¡åŸºæº–ãŒç¢ºå®šæ¸ˆã¿ã®å ´åˆã¯ã€æˆç¸¾å…¥åŠ›ç”»é¢ã«é·ç§»ã—ã¾ã™ã€‚
        </p>
        <button id="continueBtn" class="btn-primary">é€”ä¸­å†é–‹ã™ã‚‹</button>
      </div>

      <!-- æ–°è¦å…¥åŠ› -->
      <div class="card">
        <h3>ğŸŸ¢ æ–°è¦å…¥åŠ›ï¼ˆç§‘ç›®ç™»éŒ²ã‹ã‚‰ï¼‰</h3>
        <p>
          æ–°å¹´åº¦ã®å…¥åŠ›ã‚„ã€æ–°ãŸã«æ‹…å½“ã™ã‚‹ç§‘ç›®ãŒå¢—ãˆãŸå ´åˆã¯ã“ã¡ã‚‰ã‹ã‚‰é–‹å§‹ã—ã¾ã™ã€‚<br>
          ç§‘ç›®ç™»éŒ² â†’ è©•ä¾¡åŸºæº–å…¥åŠ› â†’ æˆç¸¾å…¥åŠ›ã®é †ã«é€²ã¿ã¾ã™ã€‚
        </p>
        <button id="newEntryBtn" class="btn-secondary">æ–°è¦å…¥åŠ›ã‚’é–‹å§‹</button>
      </div>

      <!-- é–²è¦§ãƒ¢ãƒ¼ãƒ‰ -->
      <div class="card">
        <h3>ğŸ“„ é–²è¦§ãƒ¢ãƒ¼ãƒ‰</h3>
        <p>
          ç™»éŒ²æ¸ˆã¿ã®è©•ä¾¡åŸºæº–ã‚„æˆç¸¾ã‚’ç¢ºèªã™ã‚‹ãƒ¢ãƒ¼ãƒ‰ã§ã™ã€‚<br>
          å…¥åŠ›æ“ä½œã¯è¡Œã‚ãšã€é–²è¦§ã®ã¿ã‚’è¡Œã„ãŸã„å ´åˆã«åˆ©ç”¨ã—ã¾ã™ã€‚
        </p>
        <button id="viewModeBtn" class="btn-secondary">é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹ã</button>
      </div>
    </div>

    <div id="statusMessage"></div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      getDocs,
      query,
      where
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // â˜… æ—¢å­˜ã®è¨­å®šã¨åŒã˜ Firebase è¨­å®šã‚’ä½¿ç”¨
    const firebaseConfig = {
      apiKey: "AIzaSyB-ykIzRvYbc5osV6WATu6BSOJt_zlHkgM",
      authDomain: "ktc-grade-system.firebaseapp.com",
      projectId: "ktc-grade-system",
      storageBucket: "ktc-grade-system.appspot.com",
      messagingSenderId: "490169300362",
      appId: "1:490169300362:web:7c6e7b47a394d68d514473"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const headerUserDisplay = document.getElementById("headerUserDisplay");
    const userInfoDisplay = document.getElementById("userInfoDisplay");
    const logoutBtn = document.getElementById("logoutBtn");

    const continueBtn = document.getElementById("continueBtn");
    const newEntryBtn = document.getElementById("newEntryBtn");
    const viewModeBtn = document.getElementById("viewModeBtn");
    const statusMessage = document.getElementById("statusMessage");

    const currentYear = new Date().getFullYear();
    const teacherSubjectsCol = `teacherSubjects_${currentYear}`;
    const evalCriteriaCol = `evaluationCriteria_${currentYear}`;

    let currentUser = null;
    let currentTeacherName = "";

    // ---------------------------
    // æ•™å“¡åã‚’å–å¾—ï¼ˆteachers ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
    // ---------------------------
    async function loadTeacherName() {
      if (!currentUser) return;
      const ref = doc(db, "teachers", currentUser.email);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        currentTeacherName = snap.data().name || "";
      } else {
        currentTeacherName = "";
      }
    }

    // ---------------------------
    // é€”ä¸­å†é–‹ãƒ­ã‚¸ãƒƒã‚¯
    //
    // 1. ç§‘ç›®ç™»éŒ²æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
    // 2. è©•ä¾¡åŸºæº–ãŒæœªå…¥åŠ›ã®ç§‘ç›®ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    // 3. æˆç¸¾å…¥åŠ›ã«é€²ã‚€ã‹ã©ã†ã‹ã‚’æ±ºå®š
    // ---------------------------
    async function handleContinue() {
      if (!currentUser) {
        alert("ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
        window.location.href = "index.html";
        return;
      }

      statusMessage.textContent = "ç¾åœ¨ã®ç™»éŒ²çŠ¶æ³ã‚’ç¢ºèªã—ã¦ã„ã¾ã™â€¦";

      // 1. ç§‘ç›®ç™»éŒ²ã®æœ‰ç„¡ã‚’ç¢ºèª
      const tsRef = doc(db, teacherSubjectsCol, currentUser.email);
      const tsSnap = await getDoc(tsRef);

      if (!tsSnap.exists() || !tsSnap.data().subjects || tsSnap.data().subjects.length === 0) {
        statusMessage.innerHTML = "<strong>ã¾ã æ‹…å½“ç§‘ç›®ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</strong> ç§‘ç›®ç™»éŒ²ç”»é¢ã¸ç§»å‹•ã—ã¾ã™ã€‚";
        setTimeout(() => {
          window.location.href = "subjects.html";
        }, 800);
        return;
      }

      const subjects = tsSnap.data().subjects; // [{ subjectId, ... }, ...]
      const subjectIds = subjects
        .map(s => s.subjectId)
        .filter(id => !!id);

      if (subjectIds.length === 0) {
        statusMessage.innerHTML = "<strong>æ‹…å½“ç§‘ç›®ã®æƒ…å ±ã«ä¸å‚™ãŒã‚ã‚Šã¾ã™ã€‚</strong> ç§‘ç›®ç™»éŒ²ç”»é¢ã§å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
        setTimeout(() => {
          window.location.href = "subjects.html";
        }, 1000);
        return;
      }

      // 2. è©•ä¾¡åŸºæº–ã®ç™»éŒ²çŠ¶æ³ã‚’ç¢ºèª
      const evalRef = collection(db, evalCriteriaCol);
      const q = query(evalRef, where("teacherEmail", "==", currentUser.email));
      const evalSnap = await getDocs(q);

      const evaluatedSubjectIds = [];
      evalSnap.forEach(docSnap => {
        const data = docSnap.data();
        if (data && data.subjectId) {
          evaluatedSubjectIds.push(data.subjectId);
        }
      });

      // è©•ä¾¡åŸºæº–æœªå…¥åŠ›ã®ç§‘ç›®ã‚’æŠ½å‡º
      const notEvaluated = subjectIds.filter(id => !evaluatedSubjectIds.includes(id));

      if (notEvaluated.length > 0) {
        // ã¾ã è©•ä¾¡åŸºæº–ãŒæœªå…¥åŠ›ã®ç§‘ç›®ãŒã‚ã‚‹ â†’ è©•ä¾¡åŸºæº–å…¥åŠ›ã¸
        statusMessage.innerHTML = "è©•ä¾¡åŸºæº–ãŒæœªå…¥åŠ›ã®ç§‘ç›®ãŒã‚ã‚Šã¾ã™ã€‚<strong>è©•ä¾¡åŸºæº–å…¥åŠ›ç”»é¢</strong>ã«ç§»å‹•ã—ã¾ã™ã€‚";
        setTimeout(() => {
          window.location.href = "evaluation.html";
        }, 800);
        return;
      }

      // 3. è©•ä¾¡åŸºæº–ã¯å…¨ã¦å…¥åŠ›æ¸ˆã¿ â†’ æˆç¸¾å…¥åŠ›ã¸
      statusMessage.innerHTML = "ã™ã¹ã¦ã®æ‹…å½“ç§‘ç›®ã®è©•ä¾¡åŸºæº–ãŒå…¥åŠ›æ¸ˆã¿ã§ã™ã€‚<strong>æˆç¸¾å…¥åŠ›ç”»é¢</strong>ã«ç§»å‹•ã—ã¾ã™ã€‚";
      setTimeout(() => {
        window.location.href = "grades.html"; // ä»Šå¾Œå®Ÿè£…äºˆå®šã®æˆç¸¾å…¥åŠ›ç”»é¢
      }, 800);
    }

    // ---------------------------
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©è¨­å®š
    // ---------------------------
    newEntryBtn.addEventListener("click", () => {
      window.location.href = "subjects.html";
    });

    viewModeBtn.addEventListener("click", () => {
      window.location.href = "view.html";
    });

    continueBtn.addEventListener("click", async () => {
      try {
        await handleContinue();
      } catch (e) {
        console.error("é€”ä¸­å†é–‹å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼:", e);
        alert("é€”ä¸­å†é–‹å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
        statusMessage.textContent = "";
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "index.html";
    });

    // ---------------------------
    // èªè¨¼çŠ¶æ…‹ç›£è¦–
    // ---------------------------
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // æœªãƒ­ã‚°ã‚¤ãƒ³ â†’ ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸
        window.location.href = "index.html";
        return;
      }

      currentUser = user;
      await loadTeacherName();

      const displayName = currentTeacherName || user.email;
      headerUserDisplay.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${displayName}`;
      userInfoDisplay.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${displayName}ï¼ˆ${user.email}ï¼‰`;
    });
  </script>
</body>
</html>
