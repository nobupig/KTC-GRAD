<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" href="kindai.png">
  <title>è¿‘å¤§é«˜å°‚ æˆç¸¾ã‚·ã‚¹ãƒ†ãƒ ï½œè©•ä¾¡åŸºæº–å…¥åŠ›</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: #f3f4f6;
      color: #111827;
    }
    header {
      background: #004A99;
      color: #fff;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 { font-size: 18px; margin: 0; }
    header .user-info { font-size: 12px; text-align: right; }
    header button {
      border: none; padding: 6px 12px;
      border-radius: 999px; cursor: pointer;
    }

    main {
      max-width: 1100px;
      margin: 20px auto;
      background: #fff;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.06);
    }
    h2 {
      font-size: 20px;
      border-left: 4px solid #004A99;
      padding-left: 10px;
      margin-top: 0;
    }

    .btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-primary { background: #004A99; color: white; }
    .btn-secondary { background: #e5e7eb; color: #111; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 13px; }
    thead { background: #f9fafb; }
    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 6px 8px; white-space: nowrap;
    }
    th:first-child, td:first-child { text-align: left; }
    tbody tr:hover { background: #f3f4f6; }

    .field { margin-bottom: 12px; }
    select, input {
      width: 100%; padding: 6px 8px;
      border-radius: 8px; border: 1px solid #d1d5db;
      font-size: 14px;
      box-sizing: border-box;
    }

    .total-area { margin-top: 12px; font-size: 14px; }

    .actions { margin-top: 16px; display: flex; gap: 8px; }

    /* â˜… è©•ä¾¡æ–¹å¼ã‚«ãƒ¼ãƒ‰UIï¼ˆæ¨ªä¸¦ã³ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰ */
    #schemeBlock {
      margin-top: 20px;
      margin-bottom: 20px;
      padding: 16px;
      background: #f8fafc;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
    }

    /* è©•ä¾¡æ–¹å¼ï¼šæ¨ªä¸¦ã³ã®æœ€çµ‚èª¿æ•´ */
    .scheme-row {
      display: flex;
      align-items: center;
      gap: 24px;
      margin-top: 10px;
    }

    .scheme-item {
      display: flex;
      align-items: center;
      gap: 8px;            /* ãƒ©ã‚¸ã‚ªã¨æ–‡å­—ã®è·é›¢æœ€é©åŒ– */
      font-size: 13px;     /* ãƒ†ã‚­ã‚¹ãƒˆã‚µã‚¤ã‚ºèª¿æ•´ */
      white-space: nowrap; 
      min-width: 180px;    /* å¹…ã‚’æƒãˆã‚‹ */
      cursor: pointer;
    }

    .scheme-item .icon {
      font-size: 16px;
      position: relative;
      top: 1px;
    }

    .scheme-item input[type="radio"] {
      transform: scale(1.1);
    }

    .scheme-item input[type="radio"]:checked + .icon + .text {
      font-weight: 600;
      color: #1e3a8a;
    }

    /* â–¼ ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š ã®è¡¨ç¤º */
    #userInfoArea {
      max-width: 1100px;
      margin: 4px auto 0;
      padding: 0 20px;
    }
  #userInfoDisplay {
  font-size: 14px;
  font-weight: 600;
  color: #1e3a8a;   /* æ¿ƒã„é’ã§å¼·èª¿ */
  text-align: right;
}
  </style>
</head>
<body>
  <header>
    <img src="kindai.png" alt="æ ¡ç« " style="width:32px; height:32px; margin-right:12px;">

    <h1>è¿‘å¤§é«˜å°‚ æˆç¸¾ã‚·ã‚¹ãƒ†ãƒ ï½œè©•ä¾¡åŸºæº–å…¥åŠ›</h1>

    <div class="user-info" style="display:flex; align-items:center; gap:10px;">
      <button id="viewModeBtn" class="btn btn-secondary" style="font-size:12px;"
        onclick="location.href='view.html'">
        ğŸ“„ é–²è¦§ãƒ¢ãƒ¼ãƒ‰
      </button>
      <button id="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </header>

  <div id="backArea"
    style="max-width:1100px; margin:10px auto 0; padding:0 20px;">
    <button id="backToSubjectsBtn" class="btn btn-secondary" style="font-size:12px;">
      â—€ ç§‘ç›®ç™»éŒ²ã«æˆ»ã‚‹
    </button>
  </div>

  <!-- â˜… ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼šè¡¨ç¤ºï¼ˆå¸¯ã®å¤–ãƒ»ã‚«ãƒ¼ãƒ‰ã¨åŒã˜å¹…ï¼å³å¯„ã›ï¼‰ -->
  <div id="userInfoArea">
    <div id="userInfoDisplay"></div>
  </div>

  <main>
    <div id="multiTeacherWarning" 
         style="display:none; 
                background:#fff3cd; 
                color:#856404; 
                padding:10px 14px; 
                border-radius:8px; 
                margin-bottom:12px;
                border:1px solid #ffeeba;">
      â€» ã“ã®ç§‘ç›®ã¯è¤‡æ•°ã®æ•™å“¡ãŒæ‹…å½“ç§‘ç›®ã«ç™»éŒ²ã—ã¦ã„ã¾ã™ã€‚èª¤ç™»éŒ²ã®å¯èƒ½æ€§ãŒã‚ã‚‹å ´åˆã€æ•™å‹™ã¸ã”é€£çµ¡ãã ã•ã„ã€‚
    </div>

    <h2>è©•ä¾¡åŸºæº–ã®è¨­å®š</h2>

    <div class="field" id="subjectSelectorArea">
      <label for="subjectSelect" style="font-size:13px; color:#4b5563;">æ‹…å½“ç§‘ç›®ã‚’é¸æŠ</label>
      <select id="subjectSelect">
        <option value="">ç§‘ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
      </select>
      <div id="subjectStatus" style="margin-top:6px; font-size:12px; color:#6b7280;"></div>
    </div>

    <div id="schemeBlock">
      <!-- â˜… è©•ä¾¡æ–¹å¼ã®é¸æŠ -->
      <div class="field" id="schemeSelectorArea" style="margin-bottom:16px;">
        <div style="font-size:13px; color:#4b5563; margin-bottom:4px;">è©•ä¾¡æ–¹å¼ã‚’é¸æŠ</div>
        <div class="scheme-row">
          <label class="scheme-item">
            <input type="radio" name="schemeType" value="exam_only" checked>
            <span class="icon">ğŸ“</span>
            <span class="text">è€ƒæŸ»ã®ã¿ã§è©•ä¾¡ï¼ˆæœŸæœ«è€ƒæŸ»100%ï¼‰</span>
          </label>
          <label class="scheme-item">
            <input type="radio" name="schemeType" value="exam_plus_assignments">
            <span class="icon">ğŸ“š</span>
            <span class="text">è€ƒæŸ»ï¼‹èª²é¡Œç­‰ã§è©•ä¾¡</span>
          </label>
          <label class="scheme-item">
            <input type="radio" name="schemeType" value="practice_only">
            <span class="icon">ğŸ§ª</span>
            <span class="text">å®Ÿé¨“ãƒ»å®Ÿç¿’ç³»ã®èª²é¡Œä½œå“ã§è©•ä¾¡</span>
          </label>
        </div>
      </div>
    </div>

    <table id="criteriaTable">
      <thead>
        <tr>
          <th>è©•ä¾¡é …ç›®</th>
          <th>å‰²åˆ (%)</th>
          <th>å‰Šé™¤</th>
        </tr>
      </thead>
      <tbody id="criteriaTbody"></tbody>
    </table>

    <div class="actions">
      <button id="addRowBtn" class="btn btn-secondary">+ è¡Œè¿½åŠ </button>
    </div>

    <div id="totalArea" class="total-area">åˆè¨ˆï¼š0%</div>

    <div class="actions" style="margin-top:20px;">
      <button id="saveBtn" class="btn btn-primary">ä¿å­˜ã™ã‚‹ï¼ˆæœªå®Ÿè£…ï¼‰</button>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      getDocs,
      setDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB-ykIzRvYbc5osV6WATu6BSOJt_zlHkgM",
      authDomain: "ktc-grade-system.firebaseapp.com",
      projectId: "ktc-grade-system",
      storageBucket: "ktc-grade-system.appspot.com",
      messagingSenderId: "490169300362",
      appId: "1:490169300362:web:7c6e7b47a394d68d514473"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const userInfoDisplay = document.getElementById("userInfoDisplay");
    const logoutBtn = document.getElementById("logoutBtn");
    const subjectSelect = document.getElementById("subjectSelect");
    const backToSubjectsBtn = document.getElementById("backToSubjectsBtn");
    const subjectStatus = document.getElementById("subjectStatus");
    const addRowBtn = document.getElementById("addRowBtn");
    const criteriaTbody = document.getElementById("criteriaTbody");
    const totalArea = document.getElementById("totalArea");
    const saveBtn = document.getElementById("saveBtn");
    const schemeRadios = document.querySelectorAll('input[name="schemeType"]');

    // â˜… ç§‘ç›®ç™»éŒ²ã¸æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼ˆsubjects.html ã¸é·ç§»ï¼‰
    const backBtn = document.getElementById("backToSubjectsBtn");
    if (backBtn) {
      backBtn.addEventListener("click", () => {
        window.location.href = "subjects.html";
      });
    }

    const currentYear = new Date().getFullYear();
    const evalColName = `evaluationCriteria_${currentYear}`;

    let currentUser = null;
    let currentTeacherName = "";
    let currentScheme = "exam_only";

    async function loadTeacherName() {
      if (!currentUser) return;
      const ref = doc(db, "teachers", currentUser.email);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        currentTeacherName = snap.data().name || "";
      } else {
        currentTeacherName = "";
      }
    }

    async function loadTeacherSubjects() {
      if (!currentUser) return;
      subjectSelect.innerHTML = '<option value="">ç§‘ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
      subjectStatus.textContent = "";

      const year = new Date().getFullYear();
      const ref = doc(db, `teacherSubjects_${year}`, currentUser.email);
      const snap = await getDoc(ref);

      if (!snap.exists() || !snap.data().subjects || !snap.data().subjects.length) {
        subjectStatus.textContent = "æ‹…å½“ç§‘ç›®ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã¾ãšç§‘ç›®ç™»éŒ²ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚";
        return;
      }

      const subjects = snap.data().subjects;
      let hasNormal = false;
      subjects.forEach((s) => {
        const opt = document.createElement("option");
        opt.value = s.subjectId || "";

        const baseLabel = `${s.grade}å¹´ / ${s.course} / ${s.semester} / ${s.name}`;

        if (s.specialType === true) {
          opt.textContent = `${baseLabel}ï¼ˆè©•ä¾¡åŸºæº–å…¥åŠ›ä¸è¦ï¼‰`;
          opt.disabled = true;
        } else {
          opt.textContent = baseLabel;
          hasNormal = true;
        }

        subjectSelect.appendChild(opt);
      });

      if (!hasNormal) {
        subjectStatus.textContent = "ã“ã®æ•™å“¡ãŒæ‹…å½“ã™ã‚‹ç§‘ç›®ã¯ã€ã™ã¹ã¦ã€è©•ä¾¡åŸºæº–å…¥åŠ›ä¸è¦ã®ç‰¹åˆ¥ç§‘ç›®ã€ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚æˆç¸¾å…¥åŠ›ç”»é¢ã‹ã‚‰ç›´æ¥å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
      }
    }

    async function loadCriteria(subjectId) {
      if (!currentUser || !subjectId) {
        applyCurrentScheme();
        return;
      }

      const docId = `${currentUser.email}_${subjectId}`;
      const ref = doc(db, evalColName, docId);
      const snap = await getDoc(ref);

      if (!snap.exists()) {
        applyCurrentScheme();
        return;
      }

      const data = snap.data();
      const scheme = data.schemeType || "exam_only";
      const radio = document.querySelector(`input[name="schemeType"][value="${scheme}"]`);
      if (radio) radio.checked = true;

      criteriaTbody.innerHTML = "";

      if (scheme === "exam_only") {
        setupSchemeExamOnly();
        return;
      }

      if (scheme === "exam_plus_assignments") {
        setupSchemeExamPlusAssignments();
      } else if (scheme === "practice_only") {
        setupSchemePracticeOnly();
      }

      (data.criteria || []).forEach((item) => {
        addCriteriaRow(item.name, item.percent, {
          fixedName: item.fixedName || false,
          fixedPercent: item.fixedPercent || false,
          allowDelete: !item.fixedName
        });
      });

      updateTotal();
    }

    function addCriteriaRow(itemName = "", percent = "", options = {}) {
      const { fixedName = false, fixedPercent = false, allowDelete = true } = options;

      const tr = document.createElement("tr");

      const tdName = document.createElement("td");
      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.placeholder = "ä¾‹ï¼šãƒ¬ãƒãƒ¼ãƒˆ";
      nameInput.value = itemName;
      if (fixedName) {
        nameInput.readOnly = true;
        nameInput.style.backgroundColor = "#f3f4f6";
      }
      tdName.appendChild(nameInput);

      const tdPercent = document.createElement("td");
      const percentInput = document.createElement("input");
      percentInput.type = "number";
      percentInput.min = "0";
      percentInput.max = "100";
      percentInput.value = percent;
      if (fixedPercent) {
        percentInput.readOnly = true;
        percentInput.style.backgroundColor = "#f3f4f6";
      } else {
        percentInput.addEventListener("input", updateTotal);
      }
      tdPercent.appendChild(percentInput);

      const tdDelete = document.createElement("td");
      if (allowDelete) {
        const delBtn = document.createElement("button");
        delBtn.className = "btn btn-secondary";
        delBtn.style.fontSize = "12px";
        delBtn.textContent = "å‰Šé™¤";
        delBtn.addEventListener("click", () => {
          tr.remove();
          updateTotal();
        });
        tdDelete.appendChild(delBtn);
      } else {
        tdDelete.textContent = "-";
      }

      tr.appendChild(tdName);
      tr.appendChild(tdPercent);
      tr.appendChild(tdDelete);

      criteriaTbody.appendChild(tr);
    }

    // â˜… è©•ä¾¡æ–¹å¼ã”ã¨ã®è¡Œã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    function setupSchemeExamOnly() {
      currentScheme = "exam_only";
      criteriaTbody.innerHTML = "";
      addRowBtn.disabled = true;
      addCriteriaRow("æœŸæœ«è€ƒæŸ»", 100, {
        fixedName: true,
        fixedPercent: true,
        allowDelete: false
      });
      updateTotal();
    }

    function setupSchemeExamPlusAssignments() {
      currentScheme = "exam_plus_assignments";
      criteriaTbody.innerHTML = "";
      addRowBtn.disabled = false;
      addCriteriaRow("æœŸæœ«è€ƒæŸ»", "", {
        fixedName: true,
        fixedPercent: false,
        allowDelete: false
      });
      updateTotal();
    }

    function setupSchemePracticeOnly() {
      currentScheme = "practice_only";
      criteriaTbody.innerHTML = "";
      addRowBtn.disabled = false;
      addCriteriaRow("", "", {
        fixedName: false,
        fixedPercent: false,
        allowDelete: true
      });
      updateTotal();
    }

    function applyCurrentScheme() {
      const scheme = document.querySelector('input[name="schemeType"]:checked').value;
      if (scheme === "exam_only") setupSchemeExamOnly();
      else if (scheme === "exam_plus_assignments") setupSchemeExamPlusAssignments();
      else setupSchemePracticeOnly();
    }

    function updateTotal() {
      const inputs = criteriaTbody.querySelectorAll("input[type='number']");
      let total = 0;
      inputs.forEach((el) => {
        const val = parseFloat(el.value);
        if (!isNaN(val)) total += val;
      });

      totalArea.textContent = `åˆè¨ˆï¼š${total}%`;

      const lower = 99;
      const upper = 101;

      if (currentScheme === "exam_only") {
        totalArea.style.color = "#111827";
        saveBtn.disabled = false;
        return;
      }

      if (total >= lower && total <= upper) {
        totalArea.style.color = "#111827";
        saveBtn.disabled = false;
      } else {
        totalArea.style.color = "#b91c1c";
        saveBtn.disabled = true;
      }
    }

    // â˜… åŒä¸€ç§‘ç›®ã‚’ç™»éŒ²ã—ã¦ã„ã‚‹æ•™å“¡ã®äººæ•°ã‚’èª¿ã¹ã‚‹
    async function checkMultiTeacher(subjectId) {
      const thisCollection = `teacherSubjects_${currentYear}`;
      const colRef = collection(db, thisCollection);
      const snap = await getDocs(colRef);

      let count = 0;

      snap.forEach((docSnap) => {
        const data = docSnap.data();
        if (!data.subjects) return;

        const has = data.subjects.some(s => s.subjectId === subjectId);
        if (has) count++;
      });

      return count;
    }

    // â˜… è©•ä¾¡æ–¹å¼ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
    schemeRadios.forEach((radio) => {
      radio.addEventListener("change", (e) => {
        if (!e.target.checked) return;

        const value = e.target.value;
        if (value === "exam_only") {
          setupSchemeExamOnly();
        } else if (value === "exam_plus_assignments") {
          setupSchemeExamPlusAssignments();
        } else if (value === "practice_only") {
          setupSchemePracticeOnly();
        }
      });
    });

    // è¡Œè¿½åŠ ãƒœã‚¿ãƒ³ï¼ˆç¾åœ¨ã®æ–¹å¼ã«å¿œã˜ã¦è‡ªç”±è¡Œã‚’è¿½åŠ ï¼‰
    addRowBtn.addEventListener("click", () => {
      addCriteriaRow("", "", {
        fixedName: false,
        fixedPercent: false,
        allowDelete: true
      });
      updateTotal();
    });

    subjectSelect.addEventListener("change", async () => {
      const selectedOption = subjectSelect.options[subjectSelect.selectedIndex];
      const subjectId = selectedOption ? selectedOption.value : "";
      await loadCriteria(subjectId);

      // â˜… è¤‡æ•°æ‹…å½“ãƒã‚§ãƒƒã‚¯
      const multiCount = await checkMultiTeacher(subjectId);
      const warningEl = document.getElementById("multiTeacherWarning");
      if (multiCount > 1) {
        warningEl.style.display = "block";
      } else {
        warningEl.style.display = "none";
      }
    });

    saveBtn.addEventListener("click", async () => {
      const text = totalArea.textContent || "";
      const match = text.match(/åˆè¨ˆï¼š(\d+(\.\d+)?)%/);
      let total = null;
      if (match) {
        total = parseFloat(match[1]);
      }

      if (currentScheme !== "exam_only" && (total === null || total < 99 || total > 101)) {
        alert("åˆè¨ˆãŒ100%ã«ãªã‚‹ã‚ˆã†ã«èª¿æ•´ã—ã¦ãã ã•ã„ã€‚ï¼ˆè¨±å®¹èª¤å·® Â±1%ï¼‰");
        return;
      }

      if (!currentUser) {
        alert("ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const selectedOption = subjectSelect.options[subjectSelect.selectedIndex];
      const subjectId = selectedOption.value;
      const subjectName = selectedOption.textContent;

      if (!subjectId) {
        alert("ç§‘ç›®ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        return;
      }

      const scheme = document.querySelector('input[name="schemeType"]:checked').value;
      const rows = criteriaTbody.querySelectorAll("tr");
      const criteria = [];
      rows.forEach((tr) => {
        const nameInput = tr.querySelector("td:nth-child(1) input");
        const percentInput = tr.querySelector("td:nth-child(2) input");
        const name = nameInput.value.trim();
        const percent = parseFloat(percentInput.value);

        const isFixedName = nameInput.readOnly;
        const isFixedPercent = percentInput.readOnly;

        criteria.push({
          name,
          percent,
          fixedName: isFixedName,
          fixedPercent: isFixedPercent
        });
      });

      const payload = {
        teacherEmail: currentUser.email,
        teacherName: currentTeacherName || "",
        subjectId,
        subjectName,
        schemeType: scheme,
        criteria,
        updatedAt: serverTimestamp(),
        updatedBy: currentUser.email
      };

      const docId = `${currentUser.email}_${subjectId}`;
      await setDoc(doc(db, evalColName, docId), payload, { merge: true });

      alert("è©•ä¾¡åŸºæº–ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "login.html";
    });

    console.log("Referrer:", document.referrer);
    onAuthStateChanged(auth, async (user) => {
      if (user === null) {
        const referrer = document.referrer || "";
        const fromSubjects = referrer.includes("subjects.html");
        if (fromSubjects) {
          return;
        }
        window.location.href = "login.html";
        return;
      }
      currentUser = user;
      await loadTeacherName();
      userInfoDisplay.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${currentTeacherName || user.email}ï¼ˆ${user.email}ï¼‰`;
      await loadTeacherSubjects();

      // â˜… åˆæœŸè©•ä¾¡æ–¹å¼ã®å†é©ç”¨
      applyCurrentScheme();
    });
  </script>
</body>
</html>
