<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" href="kindai.png">
  <title>è¿‘å¤§é«˜å°‚ æˆç¸¾ã‚·ã‚¹ãƒ†ãƒ ï½œè©•ä¾¡åŸºæº–å…¥åŠ›</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: #f3f4f6;
      color: #111827;
    }
    header {
      background: #004A99;
      color: #fff;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 { font-size: 24px; margin: 0; }
    .user-info { font-size: 14px; }

    header button {
      border: none;
      padding: 6px 12px;
      border-radius: 999px;
      cursor: pointer;
    }

    main {
      max-width: 1100px;
      margin: 20px auto;
      background: #fff;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.06);
    }

    h2 {
      font-size: 20px;
      border-left: 4px solid #004A99;
      padding-left: 10px;
      margin-top: 0;
    }

  .btn {
  padding: 10px 18px;   /* â† é«˜ã•ãƒ»æ¨ªå¹…ã‚’å®‰å®šã•ã›ã‚‹ */
  min-height: 44px;     /* â† å…¨ãƒœã‚¿ãƒ³å…±é€šã®é«˜ã• */
  border-radius: 999px;
  border: none;
  cursor: pointer;
  font-size: 15px;      /* â† å…¨ä½“ãƒ•ã‚©ãƒ³ãƒˆã«åˆã‚ã›ã‚‹ */
}

    .btn-primary { background: #004A99; color: white; }
    .btn-secondary { background: #e5e7eb; color: #111; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    thead { background: #f9fafb; }
    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 6px 8px;
      white-space: nowrap;
    }

    .field { margin-bottom: 12px; }
    select, input {
      width: 100%; padding: 6px 8px;
      border-radius: 8px; border: 1px solid #d1d5db;
      font-size: 20px;
      box-sizing: border-box;
    }

    .scheme-tabs {
      display: flex;
      border-bottom: 2px solid #d1d5db;
      margin-bottom: 18px;
    }

    .scheme-note {
      margin-top: 6px;
      font-size: 18px;
      color: #4b5563;
      background: #f9fafb;
      padding: 6px 10px;
      border-radius: 6px;
    }

    .scheme-tab {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 14px;
      border: 2px solid transparent;
      border-bottom: none;
      cursor: pointer;
      
      color: #374151;
      white-space: nowrap;
    }

    .scheme-tab:hover {
      background: #f9fafb;
    }

    .scheme-tab.active {
      background: #ffffff;
      border-color: #004A99;
      border-bottom: 2px solid #ffffff;
      color: #004A99;
      font-weight: 600;
    }

    .scheme-tab input[type="radio"] {
      display: none;
    }

    .scheme-tab .icon {
      font-size: 16px;
    }

    .action-bar {
      margin-top: 24px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
    }

.action-left {
  display: flex;
  align-items: center;
  gap: 12px;          /* â† è¡Œè¿½åŠ ã¨ä¿®æ­£ã®é–“éš” */
}


    .action-primary {
  display: flex;
  flex-direction: column;
  align-items: center;   /* â˜… è¿½åŠ ï¼šä¸­å¤®æƒãˆã®æœ¬ä½“ */
  gap: 6px;
}

   .action-hint {
  font-size: 14px;
  color: #6b7280;
  text-align: center;   /* â˜… è¿½åŠ  */
}

.action-edit-row {
  display: flex;
  align-items: center;
  gap: 12px;
  justify-content: center;
}

    .action-next {
      display: flex;
      align-items: center;
    }

    .action-primary .btn {
  min-width: 220px;   /* å¥½ã¿ã§ 200ã€œ240 */
  text-align: center;
}

     /* ä¿å­˜æ¸ˆã¿çŠ¶æ…‹ã®ä¿å­˜ãƒœã‚¿ãƒ³ */
    #saveBtn:disabled {
      background: #e5e7eb;
      color: #6b7280;
      cursor: default;
      box-shadow: none;
    }

    /* ä¿å­˜æ¸ˆã¿æ™‚ã®ãƒ©ãƒ™ãƒ«ã‚’å¼·èª¿ã—ã™ããªã„ */
    #saveBtn:disabled::after {
      content: "ï¼ˆä¿å­˜æ¸ˆã¿ï¼‰";
      margin-left: 6px;
      font-size: 14px;
      color: #6b7280;
    }

    .total-note { font-size: 18px; color: #dc2626; margin-left: 8px; }

    #multiTeacherWarning {
      background:#fff3cd;
      color:#856404;
      padding:10px 14px;
      border-radius:8px;
      margin-bottom:12px;
      border:1px solid #ffeeba;
      display:none;
    }

    .subject-status-bar {
      margin-top: 8px;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 13px;
      line-height: 1.5;
      color: #1f2937;
      background: #f1f5f9;
      border-left: 6px solid #004A99;
    }

    .subject-status-bar:empty {
      display: none;
    }

    #toastContainer {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }

    /* ä¿®æ­£ç†ç”±ãƒ¢ãƒ¼ãƒ€ãƒ« */
    #editReasonModal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #editReasonModal .box {
      background: #ffffff;
      width: 100%;
      max-width: 420px;
      padding: 20px 24px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
  </style>

</head>
<body>

  <header>
    <img src="kindai.png" alt="æ ¡ç« "
         style="width:32px; height:32px; margin-right:12px;">
    <h1>è¿‘å¤§é«˜å°‚ æˆç¸¾ã‚·ã‚¹ãƒ†ãƒ ï½œè©•ä¾¡åŸºæº–å…¥åŠ›</h1>
    <div class="user-info">
      <button id="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>

  </header>

  <div style="max-width:1100px; margin:10px auto 0; padding:0 20px; display:flex; gap:8px;">
    <button class="btn btn-secondary" style="font-size:18px;" onclick="location.href='start.html'">
      ğŸ  ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹
    </button>
    <button id="backToSubjectsBtn" class="btn btn-secondary" style="font-size:18px;">
      â—€ ç§‘ç›®ç™»éŒ²ã«æˆ»ã‚‹
    </button>
  </div>

  <!-- ãƒ­ã‚°ã‚¤ãƒ³ä¸­è¡¨ç¤º -->
  <div id="userInfoArea" style="max-width:1100px; margin:4px auto 0; padding:0 20px;">
    <div id="userInfoDisplay" style="font-size:16px; font-weight:600; text-align:right;"></div>
  </div>

  <div id="toastContainer"></div>

  <main>

    <div id="multiTeacherWarning">
      â€» ã“ã®ç§‘ç›®ã¯è¤‡æ•°ã®æ•™å“¡ãŒæ‹…å½“ç§‘ç›®ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚èª¤ç™»éŒ²ã®å¯èƒ½æ€§ãŒã‚ã‚‹å ´åˆã€æ•™å‹™ã¸ã”é€£çµ¡ãã ã•ã„ã€‚
    </div>

    <h2>è©•ä¾¡åŸºæº–ã®è¨­å®š</h2>

    <!-- æ‰‹é †ã‚¬ã‚¤ãƒ‰ -->
    <div style="
      margin:12px 0 16px;
      padding:12px 16px;
      background:#f8fafc;
      border:1px solid #e5e7eb;
      border-radius:12px;
      font-size:18px;    
      line-height:1.7;
      color:#211e1e;
    ">
      <strong style="color:#004A99;">ã“ã®ç”»é¢ã§ã®æ“ä½œæ‰‹é †</strong><br>
      â‘  æ‹…å½“ç§‘ç›®ã‚’é¸æŠã—ã¾ã™<br>
      â‘¡ è©•ä¾¡æ–¹å¼ï¼ˆè€ƒæŸ»ã®ã¿ï¼è€ƒæŸ»ï¼‹èª²é¡Œï¼å®Ÿé¨“ãƒ»å®Ÿç¿’ï¼‰ã‚’é¸æŠã—ã¾ã™<br>
      â‘¢ è©•ä¾¡é …ç›®ã¨å‰²åˆï¼ˆåˆè¨ˆ100%ï¼‰ã‚’å…¥åŠ›ã—ã¾ã™<br>
      â‘£ ä¿å­˜å¾Œã€ã€Œæˆç¸¾å…¥åŠ›ã¸ã€ãƒœã‚¿ãƒ³ã‹ã‚‰æˆç¸¾å…¥åŠ›ç”»é¢ã¸é€²ã¿ã¾ã™<br>
      <span style="display:block; margin-top:6px; color:#4b5563;">
        â€»ã€Œè€ƒæŸ»ã®ã¿ï¼ˆ100%ï¼‰ã€ã®å ´åˆã€è©•ä¾¡é …ç›®ã®å…¥åŠ›ã¯ä¸è¦ã§ã™ã€‚<br>
        â€» ä¸€åº¦ä¿å­˜ã—ãŸè©•ä¾¡åŸºæº–ã‚’ä¿®æ­£ã™ã‚‹å ´åˆã¯ã€ä¿®æ­£ç†ç”±ã®å…¥åŠ›ãŒå¿…è¦ã§ã™ã€‚
      </span>
    </div>

    <!-- ç§‘ç›®é¸æŠ -->
    <div class="field">
      <label for="subjectSelect" style="font-size:18px; color:#4b5563;">æ‹…å½“ç§‘ç›®ã‚’é¸æŠ</label>
      <select id="subjectSelect">
        <option value="">ç§‘ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
      </select>
      <div id="subjectStatus" class="subject-status-bar"></div>
    </div>

    <!-- è©•ä¾¡æ–¹å¼ -->
    <div id="schemeBlock" style="margin-bottom:16px;">
      <div style="font-size:18px; color:#4b5563; margin-bottom:4px;">è©•ä¾¡æ–¹å¼ã‚’é¸æŠ</div>
      <div class="scheme-tabs">

        <div class="scheme-tab" data-value="exam_only">
          <input type="radio" name="schemeType" value="exam_only" checked>
          <span class="icon">ğŸ“</span>
          <span class="label">è€ƒæŸ»ã®ã¿ï¼ˆ100%ï¼‰</span>
        </div>

        <div class="scheme-tab" data-value="exam_plus_assignments">
          <input type="radio" name="schemeType" value="exam_plus_assignments">
          <span class="icon">ğŸ“š</span>
          <span class="label">è€ƒæŸ»ï¼‹èª²é¡Œ</span>
        </div>

        <div class="scheme-tab" data-value="practice_only">
          <input type="radio" name="schemeType" value="practice_only">
          <span class="icon">ğŸ§ª</span>
          <span class="label">å®Ÿé¨“ãƒ»å®Ÿç¿’</span>
        </div>

      </div>
      <div class="scheme-note">
        â€» è©•ä¾¡æ–¹å¼ã‚’å¤‰æ›´ã™ã‚‹ã¨ã€ç¾åœ¨å…¥åŠ›ä¸­ã®è©•ä¾¡é …ç›®ã¯åˆæœŸåŒ–ã•ã‚Œã¾ã™ã€‚<br>
        â€» ã€Œè€ƒæŸ»ã®ã¿ï¼ˆ100%ï¼‰ã€ã‚’é¸æŠã—ãŸå ´åˆã€è©•ä¾¡é …ç›®ã®å…¥åŠ›ã¯ä¸è¦ã§ã™ã€‚
      </div>
    </div>

    <!-- è¡¨ -->
    <table id="criteriaTable">
      <thead>
        <tr>
          <th>è©•ä¾¡é …ç›®</th>
          <th>å‰²åˆ (%)</th>
          <th>æº€ç‚¹ï¼ˆç‚¹ï¼‰</th>
          <th>å‰Šé™¤</th>
        </tr>
      </thead>
      <tbody id="criteriaTbody"></tbody>
    </table>

   

    <div id="totalArea" style="margin-top:12px; font-size:16px;">åˆè¨ˆï¼š0%</div>
    <span class="total-note">
      â€» è©•ä¾¡åŸºæº–ã®åˆè¨ˆã¯å¿…ãš100%ã¨ã—ã¦ãã ã•ã„ï¼ˆè¨±å®¹èª¤å·® Â±1%ï¼‰
    </span>

<div class="action-bar">

  <!-- å·¦ï¼šè¡Œè¿½åŠ  -->
<div class="action-left">
  <button id="addRowBtn" class="btn btn-secondary">
    ï¼‹ è¡Œè¿½åŠ 
  </button>

  <button id="editBtn"
          class="btn btn-secondary"
          style="display:none;">
    ä¿®æ­£ã™ã‚‹
  </button>
</div>


  <!-- ä¸­å¤®ï¼šä¿å­˜ãƒ»ä¿®æ­£ -->
<div class="action-primary">
  <button id="saveBtn" class="btn btn-primary">
    ä¿å­˜ã™ã‚‹
  </button>
</div>
 <!-- å³ï¼šæ¬¡ã¸ -->
  <div class="action-next">
    <button id="goScoreBtn"
            class="btn btn-secondary"
            style="display:none;">
      æˆç¸¾å…¥åŠ›ã¸
    </button>
  </div>

</div>

    <!-- ãƒ­ãƒƒã‚¯/ç™»éŒ²æ¸ˆã¿é€šçŸ¥ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
<dialog id="criteriaInfoDialog">
  <h3 id="criteriaInfoTitle" style="margin:0 0 8px 0;"></h3>
  <p id="criteriaInfoMessage" style="white-space:pre-wrap; font-size:13px; margin:0 0 12px 0;"></p>
  <div style="display:flex; gap:8px; justify-content:flex-end;">
    <button id="criteriaInfoGoScoreBtn" class="btn btn-secondary" style="display:none;">æˆç¸¾å…¥åŠ›ã¸é€²ã‚€</button>
    <button id="criteriaInfoCloseBtn" class="btn btn-primary">é–‰ã˜ã‚‹</button>
  </div>
</dialog>
   
    </div>

  </main>

  <!-- ä¿®æ­£ç†ç”±ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="editReasonModal">
    <div class="box">
      <h3 style="margin:0 0 8px 0; color:#004A99;">è©•ä¾¡åŸºæº–ã®ä¿®æ­£ç†ç”±</h3>
      <p style="font-size:13px; margin:0 0 8px 0;">
        ä¿®æ­£ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ï¼ˆå±¥æ­´ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã™ï¼‰
      </p>

      <textarea id="editReasonInput"
        rows="4"
        style="width:100%; padding:8px; border-radius:8px; border:1px solid #d1d5db; font-size:13px;"></textarea>

      <div style="margin-top:16px; text-align:right;">
        <button id="editReasonCancelBtn" class="btn btn-secondary" style="font-size:12px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button id="editReasonOkBtn" class="btn btn-primary" style="font-size:12px;">ä¿®æ­£ã‚’é–‹å§‹ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <script type="module">
      import { initSchoolYear } from "./js/schoolYear.js";

  // å¹´åº¦ã‚’æœ€åˆã«ç¢ºå®šï¼ˆå…¨ãƒšãƒ¼ã‚¸å…±é€šï¼‰
  initSchoolYear();
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      collection,
      getDocs,
      serverTimestamp,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰åˆæœŸ subjectId ã‚’å–å¾—
    const evalParams = new URLSearchParams(window.location.search);
    const initialSubjectId = evalParams.get("subjectId") || "";

    // ================================
    // Firebase è¨­å®š
    // ================================
    const firebaseConfig = {
      apiKey: "AIzaSyB-ykIzRvYbc5osV6WATu6BSOJt_zlHkgM",
      authDomain: "ktc-grade-system.firebaseapp.com",
      projectId: "ktc-grade-system",
      storageBucket: "ktc-grade-system.appspot.com",
      messagingSenderId: "490169300362",
      appId: "1:490169300362:web:7c6e7b47a394d68d514473"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ================================
    // DOM å‚ç…§
    // ================================
    const logoutBtn = document.getElementById("logoutBtn");
    const backToSubjectsBtn = document.getElementById("backToSubjectsBtn");
    const userInfoDisplay = document.getElementById("userInfoDisplay");

    const subjectSelect = document.getElementById("subjectSelect");
    const subjectStatus = document.getElementById("subjectStatus");

    const schemeRadios = document.querySelectorAll('input[name="schemeType"]');
    const criteriaTbody = document.getElementById("criteriaTbody");
    let addRowBtn = document.getElementById("addRowBtn");
    const totalArea = document.getElementById("totalArea");
      const saveBtn = document.getElementById("saveBtn");
      const goScoreBtn = document.getElementById("goScoreBtn");

    const multiTeacherWarning = document.getElementById("multiTeacherWarning");
    const toastContainer = document.getElementById("toastContainer");

    const editReasonModal = document.getElementById("editReasonModal");
    const editReasonInput = document.getElementById("editReasonInput");
    const editReasonCancelBtn = document.getElementById("editReasonCancelBtn");
    const editReasonOkBtn = document.getElementById("editReasonOkBtn");
    const editBtn = document.getElementById("editBtn");

    // ================================
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹
    // ================================
    const currentYear = window.CURRENT_YEAR;
    const evalColName = `evaluationCriteria_${currentYear}`;
    const lockColName = `evaluationLocks_${currentYear}`;

    let currentUser = null;
    let currentTeacherName = "";
    let currentSubjectId = null;
    let currentScheme = "exam_only";
    let isSchemeSwitchDisabled = false;

    // ãƒ­ãƒƒã‚¯æƒ…å ±
    let currentLockSubjectId = null;
    let currentLockOwnerEmail = null;

    // ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰
    let isEditingExistingCriteria = false;
    let currentEditReason = null;
    let historyBeforeCriteriaSnapshot = null;

    // ================================
    // å…±é€š UI ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    // ================================
    function showToast(message, type = "success") {
      if (!toastContainer) return;
      const toast = document.createElement("div");
      toast.textContent = message;
      toast.style.minWidth = "260px";
      toast.style.maxWidth = "360px";
      toast.style.background = type === "success" ? "#16a34a" : "#dc2626";
      toast.style.color = "#fff";
      toast.style.padding = "10px 14px";
      toast.style.marginTop = "8px";
      toast.style.borderRadius = "10px";
      toast.style.boxShadow = "0 4px 14px rgba(0,0,0,0.2)";
      toast.style.fontSize = "13px";
      toast.style.opacity = "0";
      toast.style.transform = "translateY(-10px)";
      toast.style.transition = "all 0.3s ease";
      toastContainer.appendChild(toast);

      requestAnimationFrame(() => {
        toast.style.opacity = "1";
        toast.style.transform = "translateY(0)";
      });

      setTimeout(() => {
        toast.style.opacity = "0";
        toast.style.transform = "translateY(-10px)";
        setTimeout(() => toast.remove(), 300);
      }, 2500);
    }

    if (backToSubjectsBtn) {
      backToSubjectsBtn.addEventListener("click", () => {
        window.location.href = "subjects.html";
      });
    }

    // ================================
    // æ•™å“¡åãƒ»æ‹…å½“ç§‘ç›®
    // ================================
    async function loadTeacherName() {
      if (!currentUser) return;
      const ref = doc(db, "teachers", currentUser.email);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        currentTeacherName = snap.data().name || "";
      } else {
        currentTeacherName = "";
      }
    }

    async function loadTeacherSubjects() {
      if (!currentUser) return;

      subjectSelect.innerHTML =
        '<option value="">ç§‘ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
      subjectStatus.textContent = "";

      const ref = doc(db, `teacherSubjects_${currentYear}`, currentUser.email);
      const snap = await getDoc(ref);

      if (!snap.exists() || !snap.data().subjects || !snap.data().subjects.length) {
        subjectStatus.textContent =
          "æ‹…å½“ç§‘ç›®ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã¾ãšç§‘ç›®ç™»éŒ²ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚";
        return;
      }

      const subjects = snap.data().subjects;
      let hasNormal = false;

subjects.forEach((s) => {
  const sp = Number(s.specialType ?? 0); // 0/1/2 ã«æ­£è¦åŒ–

  // specialType=1/2 ã¯è©•ä¾¡åŸºæº–ç”»é¢ã§ã¯æ‰±ã‚ãªã„
  if (sp !== 0) {
    return; // â† option è‡ªä½“ã‚’ä½œã‚‰ãªã„
  }

  const opt = document.createElement("option");
  opt.value = s.subjectId || "";

  const baseLabel = `${s.grade}å¹´ / ${s.course} / ${s.semester} / ${s.name}`;
  opt.textContent = baseLabel;

  hasNormal = true; // é€šå¸¸ç§‘ç›®ãŒå­˜åœ¨ã™ã‚‹ãƒ•ãƒ©ã‚°

  subjectSelect.appendChild(opt);
});


      if (!hasNormal) {
        subjectStatus.textContent =
          "ã“ã®æ•™å“¡ãŒæ‹…å½“ã™ã‚‹ç§‘ç›®ã¯ã™ã¹ã¦ã€è©•ä¾¡åŸºæº–å…¥åŠ›ä¸è¦ã®ç‰¹åˆ¥ç§‘ç›®ã€ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚æˆç¸¾å…¥åŠ›ç”»é¢ã‹ã‚‰ç›´æ¥å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
      }

      // URL ã® subjectId ãŒæœ‰åŠ¹ãªã‚‰è‡ªå‹•é¸æŠ
      if (initialSubjectId) {
        const opt = Array.from(subjectSelect.options).find(
           (o) => o.value === initialSubjectId
        );
        if (opt) {
          subjectSelect.value = initialSubjectId;
          subjectSelect.dispatchEvent(new Event("change"));
        }
      }

    }

    // ================================
    // ãƒ­ãƒƒã‚¯é–¢é€£
    // ================================
    async function getCurrentLock(subjectId) {
      const lockRef = doc(db, lockColName, subjectId);
      const lockSnap = await getDoc(lockRef);
      if (!lockSnap.exists()) return null;
      const data = lockSnap.data();
      return {
        subjectId: data.subjectId || subjectId,
        lockedBy: data.lockedBy || "",
        lockedName: data.lockedName || "",
        lockedAt: data.lockedAt || null,
        expiresAt: data.expiresAt || null,
      };
    }


    function isLockExpired(lock) {
      if (!lock || !lock.expiresAt) return true;
      const now = new Date();
      const exp = lock.expiresAt.toDate
        ? lock.expiresAt.toDate()
        : new Date(lock.expiresAt);
      return now > exp;
    }

// ================================
// è©•ä¾¡åŸºæº– çŠ¶æ…‹é€šçŸ¥ãƒ€ã‚¤ã‚¢ãƒ­ã‚°
// ================================
function showCriteriaInfoDialog({ title, message, showGoScore, subjectId }) {
  const dlg = document.getElementById("criteriaInfoDialog");
  document.getElementById("criteriaInfoTitle").textContent = title;
  document.getElementById("criteriaInfoMessage").textContent = message;

  const goBtn = document.getElementById("criteriaInfoGoScoreBtn");
  goBtn.style.display = showGoScore ? "inline-flex" : "none";

  if (showGoScore) {
    goBtn.onclick = () => {
      const id = encodeURIComponent(subjectId || "");
      window.location.href = `score_input.html?subjectId=${id}`;
    };
  } else {
    goBtn.onclick = null;
  }

  dlg.showModal();
}

function closeCriteriaInfoDialog() {
  const dlg = document.getElementById("criteriaInfoDialog");
  if (dlg.open) dlg.close();
}

// dialogãƒœã‚¿ãƒ³
document.getElementById("criteriaInfoCloseBtn")?.addEventListener("click", closeCriteriaInfoDialog);


    async function acquireLockForSubject(subjectId, subjectLabelForMessage) {
      if (!currentUser || !subjectId) return false;

      const currentLock = await getCurrentLock(subjectId);
      if (
        currentLock &&
        !isLockExpired(currentLock) &&
        currentLock.lockedBy &&
        currentLock.lockedBy !== currentUser.email
      ) {
       
        return false;
      }

      const now = new Date();
      const expiresAt = new Date(now.getTime() + 10 * 60 * 1000); // 10åˆ†

      const lockRef = doc(db, lockColName, subjectId);
      await setDoc(lockRef, {
        subjectId,
        lockedBy: currentUser.email,
        lockedName: currentTeacherName || currentUser.email,
        lockedAt: serverTimestamp(),
        expiresAt,
      }, { merge: true });

      currentLockSubjectId = subjectId;
      currentLockOwnerEmail = currentUser.email;
      return true;
    }

    async function releaseCurrentLock() {
      if (!currentUser || !currentLockSubjectId) return;
      try {
        const lockRef = doc(db, lockColName, currentLockSubjectId);
        const lockSnap = await getDoc(lockRef);
        if (lockSnap.exists()) {
          const data = lockSnap.data();
          if (data.lockedBy === currentUser.email) {
            await setDoc(lockRef, {
              subjectId: currentLockSubjectId,
              lockedBy: null,
              lockedName: null,
              expiresAt: null,
            }, { merge: true });
          }
        }
      } catch (e) {
        console.error("ãƒ­ãƒƒã‚¯è§£æ”¾ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", e);
      } finally {
        currentLockSubjectId = null;
        currentLockOwnerEmail = null;
      }
    }

    // ================================
    // è¡¨ã®è¡Œãƒ»è©•ä¾¡æ–¹å¼
    // ================================
    function addCriteriaRow(name = "", percent = "", options = {}) {
      const {
        fixedName = false,
        fixedPercent = false,
        allowDelete = true,
        maxScore = 100,
      } = options;

      const tr = document.createElement("tr");

      const tdName = document.createElement("td");
      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.placeholder = "ä¾‹ï¼šãƒ¬ãƒãƒ¼ãƒˆ";
      nameInput.value = name;
      nameInput.dataset.fixed = fixedName ? "true" : "false";
      if (fixedName) {
        nameInput.readOnly = true;
        nameInput.style.backgroundColor = "#f3f4f6";
      }
      tdName.appendChild(nameInput);

      const tdPercent = document.createElement("td");
      const percentInput = document.createElement("input");
      percentInput.type = "number";
      percentInput.min = "0";
      percentInput.max = "100";
      percentInput.value = percent;
      percentInput.dataset.fixed = fixedPercent ? "true" : "false";
      percentInput.classList.add("percent-input");
      if (fixedPercent) {
        percentInput.readOnly = true;
        percentInput.style.backgroundColor = "#f3f4f6";
      } else {
        percentInput.addEventListener("input", updateTotal);
      }
      tdPercent.appendChild(percentInput);

      const tdMax = document.createElement("td");
      const maxScoreSelect = document.createElement("select");
      maxScoreSelect.className = "max-score-select";

      const optionHundred = document.createElement("option");
      optionHundred.value = "100";
      optionHundred.textContent = "100ç‚¹æº€ç‚¹";

      const optionPercent = document.createElement("option");
      optionPercent.value = "percent";
      optionPercent.textContent = "å‰²åˆã¨åŒã˜";

      maxScoreSelect.appendChild(optionHundred);
      maxScoreSelect.appendChild(optionPercent);
      maxScoreSelect.value = maxScore === 100 ? "100" : "percent";

      tdMax.appendChild(maxScoreSelect);

      const tdDel = document.createElement("td");
      if (allowDelete) {
        const delBtn = document.createElement("button");
        delBtn.className = "btn btn-secondary";
        delBtn.style.fontSize = "12px";
        delBtn.textContent = "å‰Šé™¤";
        delBtn.addEventListener("click", () => {
          tr.remove();
          updateTotal();
        });
        tdDel.appendChild(delBtn);
      } else {
        tdDel.textContent = "-";
      }

      tr.appendChild(tdName);
      tr.appendChild(tdPercent);
      tr.appendChild(tdMax);
      tr.appendChild(tdDel);
      criteriaTbody.appendChild(tr);
    }

    function setupSchemeExamOnly() {
      currentScheme = "exam_only";
      criteriaTbody.innerHTML = "";
      addRowBtn.disabled = true;
      addCriteriaRow("æœŸæœ«è€ƒæŸ»", 100, {
        fixedName: true,
        fixedPercent: true,
        allowDelete: false,
      });
      updateTotal();
    }

    function setupSchemeExamPlusAssignments() {
      currentScheme = "exam_plus_assignments";
      criteriaTbody.innerHTML = "";
      addRowBtn.disabled = false;

      addCriteriaRow("æœŸæœ«è€ƒæŸ»", "", {
        fixedName: true,
        fixedPercent: false,
        allowDelete: false,
      });
      addCriteriaRow("", "", {
        fixedName: false,
        fixedPercent: false,
        allowDelete: true,
      });
      updateTotal();
    }

    function setupSchemePracticeOnly() {
      currentScheme = "practice_only";
      criteriaTbody.innerHTML = "";
      addRowBtn.disabled = false;

      addCriteriaRow("", "", {
        fixedName: false,
        fixedPercent: false,
        allowDelete: true,
      });
      updateTotal();
    }

    function applyCurrentScheme() {
      const r = document.querySelector('input[name="schemeType"]:checked');
      const scheme = r ? r.value : "exam_only";
      if (scheme === "exam_only") setupSchemeExamOnly();
      else if (scheme === "exam_plus_assignments") setupSchemeExamPlusAssignments();
      else setupSchemePracticeOnly();
    }

    // åˆè¨ˆè¨ˆç®—
    function updateTotal() {
      const inputs = criteriaTbody.querySelectorAll("input.percent-input");
      let total = 0;
      inputs.forEach((el) => {
        const v = parseFloat(el.value);
        if (!isNaN(v)) total += v;
      });
      totalArea.textContent = `åˆè¨ˆï¼š${total}%`;

      if (currentScheme === "exam_only") {
        totalArea.style.color = "#111827";
        if (saveBtn.dataset.mode !== "locked") saveBtn.disabled = false;
        return;
      }

      if (total >= 99 && total <= 101) {
        totalArea.style.color = "#111827";
        if (saveBtn.dataset.mode !== "locked") saveBtn.disabled = false;
      } else {
        totalArea.style.color = "#b91c1c";
        if (saveBtn.dataset.mode !== "locked") saveBtn.disabled = true;
      }
    }

    function setupAddRowButton() {
      if (!addRowBtn) return;

      const wasDisabled = addRowBtn.disabled;
      const newBtn = addRowBtn.cloneNode(true);
      addRowBtn.parentNode.replaceChild(newBtn, addRowBtn);
      addRowBtn = newBtn;
      addRowBtn.disabled = wasDisabled;

      addRowBtn.addEventListener("click", () => {
        if (currentScheme === "exam_only") {
          return;
        }
        addCriteriaRow("", "", { allowDelete: true });
        updateTotal();
      });
    }

    // å±¥æ­´ç”¨ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
    function captureCurrentCriteriaSnapshot(subjectId) {
      const rows = [];
      criteriaTbody.querySelectorAll("tr").forEach((tr) => {
        const nameInput = tr.querySelector("td:nth-child(1) input");
        const percentInput = tr.querySelector("td:nth-child(2) input");
        if (!nameInput || !percentInput) return;
        const name = nameInput.value.trim();
        const p = parseFloat(percentInput.value);
        rows.push({
          name,
          percent: Number.isNaN(p) ? 0 : p,
        });
      });

      const r = document.querySelector('input[name="schemeType"]:checked');
      const method = r ? r.value : currentScheme;

      const m = totalArea.textContent.match(/åˆè¨ˆï¼š(\d+(\.\d+)?)%/);
      const totalPercent = m ? parseFloat(m[1]) : null;

      return {
        subjectId: subjectId || null,
        method,
        totalPercent,
        items: rows,
      };
    }

    // ================================
    // UIãƒ­ãƒƒã‚¯ï¼ˆä¿å­˜æ¸ˆã¿çŠ¶æ…‹ï¼‰
    // ================================
    function setSavedUI(allowEditButton) {
      criteriaTbody.querySelectorAll("input").forEach((inp) => {
        inp.readOnly = true;
        inp.disabled = true;
        inp.style.backgroundColor = "#f3f4f6";
      });
      criteriaTbody.querySelectorAll("select.max-score-select").forEach((sel) => {
        sel.disabled = true;
      });
      criteriaTbody.querySelectorAll("button").forEach((btn) => {
        btn.style.display = "none";
      });
      addRowBtn.disabled = true;
      schemeRadios.forEach((r) => { r.disabled = true; });

      saveBtn.disabled = true;
      saveBtn.textContent = "ä¿å­˜æ¸ˆã¿";
      saveBtn.dataset.mode = "locked";
      isSchemeSwitchDisabled = true;

      if (!editBtn) return;
      if (!allowEditButton) {
        editBtn.style.display = "none";
        return;
      }

      editBtn.style.display = "inline-flex";
    }

    function unlockUIForEdit() {
      criteriaTbody.querySelectorAll("input").forEach((inp) => {
        inp.readOnly = false;
        inp.disabled = false;
        inp.style.backgroundColor = "";
      });
      criteriaTbody.querySelectorAll("select.max-score-select").forEach((sel) => {
        sel.disabled = false;
      });
      criteriaTbody.querySelectorAll("button").forEach((btn) => {
        btn.style.display = "inline-block";
      });
      addRowBtn.disabled = false;
      schemeRadios.forEach((r) => { r.disabled = false; });

      saveBtn.disabled = false;
      saveBtn.textContent = "ä¿å­˜ã™ã‚‹ï¼ˆä¿®æ­£åæ˜ ï¼‰";
      saveBtn.dataset.mode = "edit";
      isSchemeSwitchDisabled = false;

      if (editBtn) editBtn.style.display = "none";
    }

    function resetEvaluationUI() {
      criteriaTbody.innerHTML = "";
      addRowBtn.disabled = false;
      saveBtn.disabled = false;
      saveBtn.textContent = "ä¿å­˜ã™ã‚‹";
      saveBtn.dataset.mode = "";

      schemeRadios.forEach((r) => { r.disabled = false; });
      multiTeacherWarning.style.display = "none";

      isEditingExistingCriteria = false;
      currentEditReason = null;
      historyBeforeCriteriaSnapshot = null;

      if (editBtn) editBtn.style.display = "none";

      totalArea.textContent = "åˆè¨ˆï¼š0%";
      totalArea.style.color = "#111827";
    }

    // ================================
    // è©•ä¾¡åŸºæº– æ­£è¦åŒ–ï¼ˆãƒ•ã‚§ãƒ¼ã‚º1ï¼‰
    // ================================
    function normalizeEvaluationCriteriaData(rawData) {
      if (!rawData) return null;

      const items = Array.isArray(rawData.items) ? rawData.items : [];

      return {
        ...rawData,
        items: items.map(item => {
          const rawMax = item?.maxScore;
          const maxScore =
            rawMax === undefined || rawMax === null
              ? 100
              : Number(rawMax);

          return {
            ...item,
            maxScore: Number.isFinite(maxScore) ? maxScore : 100,
          };
        }),
      };
    }

    // ================================
    // è©•ä¾¡åŸºæº–èª­ã¿è¾¼ã¿
    // ================================
    async function loadCriteria(subjectId, { editable } = { editable: true }) {
      // â˜… ç§‘ç›®åˆ‡æ›¿æ™‚ã®å®Œå…¨ UI åˆæœŸåŒ–
      resetEvaluationUI();
      criteriaTbody.innerHTML = "";

    // â˜… è©•ä¾¡æ–¹å¼ã‚¿ãƒ–ã® active è¡¨ç¤ºã‚’å®Œå…¨ãƒªã‚»ãƒƒãƒˆ
    function resetSchemeTabs(method) {
      document.querySelectorAll(".scheme-tab").forEach((t) => {
        t.classList.remove("active");
      });
      const tab = document.querySelector(`.scheme-tab[data-value="${method}"]`);
      if (tab) tab.classList.add("active");

      const radio = document.querySelector(`input[name="schemeType"][value="${method}"]`);
      if (radio) radio.checked = true;
    }

      if (!subjectId) return;
      const lockRef = doc(db, lockColName, subjectId);
      const lockSnap = await getDoc(lockRef);
      // â˜… è©•ä¾¡åŸºæº–ãŒå­˜åœ¨ã—ãªã„ãƒ­ãƒƒã‚¯ã¯è‡ªå‹•å‰Šé™¤ï¼ˆå®‰å…¨ç‰ˆï¼‰
      const criteriaRef = doc(db, evalColName, subjectId);
      const criteriaSnap = await getDoc(criteriaRef);
      const criteriaExists = criteriaSnap.exists();

      if (lockSnap.exists() && !criteriaExists) {
        console.log("è©•ä¾¡åŸºæº–ã®ç„¡ã„ãƒ­ãƒƒã‚¯ã‚’å‰Šé™¤:", subjectId);
        await deleteDoc(lockRef);
      }

      const ref = doc(db, evalColName, subjectId);
      const snap = await getDoc(ref);

      const hasCriteria = snap.exists();
      const data = hasCriteria
        ? normalizeEvaluationCriteriaData(snap.data())
        : null;
        

      const method = (data?.method) || "exam_only";
      currentScheme = method;
      // â˜… è©•ä¾¡æ–¹å¼ã‚¿ãƒ–ã¨UIã‚’æ­£ã—ãåˆæœŸåŒ–
      resetSchemeTabs(method);
      applyCurrentScheme();

      if (!hasCriteria) {
        setupSchemeExamOnly();
      }

     
      // ä¸­èº«ã‚’ä¸Šæ›¸ã
      if (hasCriteria) {
        criteriaTbody.innerHTML = "";
        (data.items || []).forEach((item) => {
          const normalizedMaxScore =
            typeof item.maxScore === "number" && Number.isFinite(item.maxScore)
              ? item.maxScore
              : 100;
          addCriteriaRow(item.name, item.percent, {
            fixedName: false,
            fixedPercent: false,
            allowDelete: true,
            maxScore: normalizedMaxScore,
          });
        });
      }


      // totalPercent ãŒæœªä¿å­˜ã®å¤ã„ãƒ‡ãƒ¼ã‚¿ã«ã‚‚å¯¾å¿œã™ã‚‹
      let totalPercent;

      if (hasCriteria) {
        if (typeof data.totalPercent === "number") {
          totalPercent = data.totalPercent;
        } else {
          totalPercent = (data.items || []).reduce((sum, item) => {
            const raw = item?.percent;
            const p =
              typeof raw === "number"
                ? raw
                : parseFloat(raw ?? "");
            return sum + (Number.isNaN(p) ? 0 : p);
          }, 0);
        }
      } else {
        totalPercent = currentScheme === "exam_only" ? 100 : 0;
      }

      totalArea.textContent = `åˆè¨ˆï¼š${totalPercent}%`;
      updateTotal();
      // â˜… è¡Œè¿½åŠ ãƒœã‚¿ãƒ³ã‚’ç§‘ç›®åˆ‡æ›¿ã”ã¨ã«å†ãƒã‚¤ãƒ³ãƒ‰
      setupAddRowButton();

      // è©•ä¾¡åŸºæº–ãŒã€Œæœ‰åŠ¹ã€ã¨åˆ¤æ–­ã§ãã‚‹ã‹
      // â˜… åˆè¨ˆå‰²åˆã¨è©•ä¾¡æ–¹å¼ãŒæƒã£ã¦ã„ã‚Œã°æˆç¸¾å…¥åŠ›ç”»é¢ã¸é€²ã‚ã‚‹
      const ready =
        !!data?.method &&
        totalPercent >= 99 &&
        totalPercent <= 101;

      if (goScoreBtn) {
        goScoreBtn.style.display = ready ? "inline-flex" : "none";
        goScoreBtn.onclick = () => {
          const id = encodeURIComponent(subjectId);
          window.location.href = `score_input.html?subjectId=${id}`;
        };
      }
    }

    // ================================
    // è¤‡æ•°æ‹…å½“ãƒã‚§ãƒƒã‚¯
    // ================================
  async function checkMultiTeacher(subjectId) {
  if (!subjectId) return 0;

  try {
    const ref = doc(db, "subjectStats", subjectId);
    const snap = await getDoc(ref);

    if (!snap.exists()) return 0;

    const count = snap.data().teacherCount || 0;
    return count;
  } catch (e) {
    console.warn("checkMultiTeacher error:", e);
    return 0;
  }
}


    // ================================
    // ã‚¤ãƒ™ãƒ³ãƒˆï¼šè©•ä¾¡æ–¹å¼åˆ‡æ›¿ãƒ»è¡Œè¿½åŠ 
    // ================================
    schemeRadios.forEach((radio) => {
      radio.addEventListener("change", (e) => {
        if (isSchemeSwitchDisabled || !e.target.checked) return;

        const value = e.target.value;
        if (value === "exam_only") {
          setupSchemeExamOnly();
        } else if (value === "exam_plus_assignments") {
          setupSchemeExamPlusAssignments();
        } else if (value === "practice_only") {
          setupSchemePracticeOnly();
        }
      });
    });

    document.querySelectorAll(".scheme-tab").forEach((tab) => {
      tab.addEventListener("click", () => {
        if (isSchemeSwitchDisabled) return;
        const value = tab.dataset.value;

        const radio = tab.querySelector("input[type='radio']");
        if (radio) {
          radio.checked = true;
        }

        document
          .querySelectorAll(".scheme-tab")
          .forEach((t) => t.classList.remove("active"));
        tab.classList.add("active");

        applyCurrentScheme();
      });
    });

    document
      .querySelector(".scheme-tab[data-value='exam_only']")
      ?.classList.add("active");
    // ================================
    if (editReasonCancelBtn) {
      editReasonCancelBtn.addEventListener("click", () => {
        isEditingExistingCriteria = false;
        currentEditReason = null;
        historyBeforeCriteriaSnapshot = null;
        if (editReasonModal) editReasonModal.style.display = "none";
      });
    }

    if (editBtn) {
      editBtn.addEventListener("click", () => {
        if (!currentSubjectId) {
          alert("ç§‘ç›®ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
          return;
        }
        if (editReasonInput) editReasonInput.value = "";
        if (editReasonModal) editReasonModal.style.display = "flex";
      });
    }

    if (editReasonOkBtn) {
      editReasonOkBtn.addEventListener("click", () => {
        const reason = (editReasonInput?.value || "").trim();
        if (!reason) {
          alert("ä¿®æ­£ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
          return;
        }
        if (!currentSubjectId) {
          alert("ç§‘ç›®ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
          return;
        }

        currentEditReason = reason;
        historyBeforeCriteriaSnapshot =
          captureCurrentCriteriaSnapshot(currentSubjectId);
        isEditingExistingCriteria = true;
        if (editReasonModal) editReasonModal.style.display = "none";

        // ã“ã“ã§åˆã‚ã¦ç·¨é›†å¯èƒ½ã«ã™ã‚‹
        unlockUIForEdit();
      });
    }
// dialog ãƒœã‚¿ãƒ³å‹•ä½œ
document.getElementById("criteriaInfoCloseBtn")?.addEventListener("click", closeCriteriaInfoDialog);
document.getElementById("criteriaInfoGoScoreBtn")?.addEventListener("click", () => {
  // æ—¢å­˜ã® subjectId å¼•ãç¶™ãã¯ URL ã§çµ±ä¸€
  const id = encodeURIComponent(currentSubjectId || "");
  window.location.href = `score_input.html?subjectId=${id}`;
});

    // ================================
    // ç§‘ç›®é¸æŠæ™‚
    // ================================
subjectSelect.addEventListener("change", async () => {
  await releaseCurrentLock();
  resetEvaluationUI();
  if (goScoreBtn) goScoreBtn.style.display = "none";

  const opt = subjectSelect.options[subjectSelect.selectedIndex];
  const subjectId = opt ? opt.value : "";
  const subjectLabel = opt ? opt.textContent : "";
  currentSubjectId = subjectId;

  if (!subjectId) return;
  // ===== specialType=1/2 ã¯è©•ä¾¡åŸºæº–ç”»é¢ã‚’ä½¿ã‚ãªã„ â†’ æˆç¸¾å…¥åŠ›ã¸è‡ªå‹•é·ç§» =====
  const sp = Number(opt?.dataset?.specialType ?? 0);
  if (sp !== 0) {
    window.location.href = `score_input.html?subjectId=${encodeURIComponent(subjectId)}`;
    return;
  }
  // â˜…â‘  è©•ä¾¡åŸºæº–ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€å„ªå…ˆï¼‰
  const criteriaRef = doc(db, evalColName, subjectId);
  const criteriaSnap = await getDoc(criteriaRef);

  if (criteriaSnap.exists()) {
    // ä¿å­˜æ¸ˆã¿UIã§è¡¨ç¤º
    await loadCriteria(subjectId, { editable: false });
    setSavedUI(true);

    showCriteriaInfoDialog({
      title: "è©•ä¾¡åŸºæº–ã¯ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™",
      message:
        "ã“ã®ç§‘ç›®ã¯ã€ã™ã§ã«è©•ä¾¡åŸºæº–ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚\n" +
        "å¤‰æ›´ãŒãªã‘ã‚Œã°ã€ãã®ã¾ã¾æˆç¸¾å…¥åŠ›ã«é€²ã‚“ã§ãã ã•ã„ã€‚\n" +
        "è©•ä¾¡åŸºæº–ã‚’å¤‰æ›´ã™ã‚‹å ´åˆã¯ã€ä¿®æ­£ãƒœã‚¿ãƒ³ã‚ˆã‚Šç†ç”±ã‚’æ˜è¨˜ã®ä¸Šã€ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚",
      showGoScore: true,
      subjectId
    });
    return; // â˜…ã“ã“ã§çµ‚äº†
  }

  // â˜…â‘¡ æ–°è¦ä½œæˆæ™‚ã®ã¿ãƒ­ãƒƒã‚¯å–å¾—
  const lockAcquired = await acquireLockForSubject(subjectId, subjectLabel);

  if (!lockAcquired) {
    showCriteriaInfoDialog({
      title: "è©•ä¾¡åŸºæº–ã‚’ä½œæˆä¸­ã§ã™",
      message:
        "ç¾åœ¨ã€ä»–ã®æ•™å“¡ãŒè©•ä¾¡åŸºæº–ã‚’ä½œæˆä¸­ã§ã™ã€‚\n" +
        "ã—ã°ã‚‰ãå¾…ã¤ã‹ã€å¿…è¦ã«å¿œã˜ã¦æ•™å‹™ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚",
      showGoScore: false
    });
    setSavedUI(false);
    return;
  }

  // â˜…â‘¢ æ–°è¦ä½œæˆUI
  await loadCriteria(subjectId, { editable: true });
});


    // ================================
    // ä¿å­˜ãƒœã‚¿ãƒ³
    // ================================
    saveBtn.addEventListener("click", async () => {
      const m = totalArea.textContent.match(/åˆè¨ˆï¼š(\d+(\.\d+)?)%/);
      const total = m ? parseFloat(m[1]) : null;

      if (
        currentScheme !== "exam_only" &&
        (total === null || total < 99 || total > 101)
      ) {
        alert("åˆè¨ˆãŒ100%ã«ãªã‚‹ã‚ˆã†ã«èª¿æ•´ã—ã¦ãã ã•ã„ã€‚ï¼ˆè¨±å®¹èª¤å·® Â±1%ï¼‰");
        return;
      }

      if (!currentUser) {
        alert("ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      if (!currentSubjectId) {
        alert("ç§‘ç›®ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        return;
      }
 
      const rows = criteriaTbody.querySelectorAll("tr");
      const items = [];

      for (const tr of rows) {
        const nameInput = tr.querySelector("td:nth-child(1) input");
        const percentInput = tr.querySelector("td:nth-child(2) input");
        const maxScoreSelect = tr.querySelector("select.max-score-select");

        const name = nameInput.value.trim();
        const percentStr = percentInput.value.trim();
        const percent = parseFloat(percentStr);

        if (!name) {
          alert("è©•ä¾¡é …ç›®åãŒç©ºæ¬„ã®è¡ŒãŒã‚ã‚Šã¾ã™ã€‚");
          nameInput.focus();
          return;
        }
        if (!percentStr) {
          alert(`ã€Œ${name}ã€ã®å‰²åˆ(%)ãŒæœªå…¥åŠ›ã§ã™ã€‚`);
          percentInput.focus();
          return;
        }
        if (isNaN(percent)) {
          alert(`ã€Œ${name}ã€ã®å‰²åˆ(%)ã¯æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
          percentInput.focus();
          return;
        }
        if (percent < 0 || percent > 100) {
          alert(`ã€Œ${name}ã€ã®å‰²åˆ(%)ã¯ 0ï½100 ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
          percentInput.focus();
          return;
        }

        const item = { name, percent };
        if (maxScoreSelect?.value === "percent") {
          item.maxScore = percent;
        }
        items.push(item);
      }

      const r = document.querySelector('input[name="schemeType"]:checked');
      const scheme = r ? r.value : currentScheme;

      try {
        console.log("EVAL HISTORY TRY", {
  isEditingExistingCriteria,
  hasBefore: !!historyBeforeCriteriaSnapshot,
  reason: currentEditReason,
  year: currentYear,
});

        const payload = {
          subjectId: currentSubjectId,
          method: scheme,
          totalPercent: total,
          items,
          isSaved: true,
          savedAt: serverTimestamp(),
          savedBy: currentUser.email,
        };

await setDoc(doc(db, evalColName, currentSubjectId), payload, { merge: true });

// ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ãªã‚‰å±¥æ­´ã‚’è¨˜éŒ²ï¼ˆUIã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹å‰ã«å¿…ãšå®Ÿè¡Œï¼‰
if (
  isEditingExistingCriteria &&
  currentEditReason &&
  historyBeforeCriteriaSnapshot
) {
  try {
    const histCol = collection(db, `evaluationHistory_${currentYear}`);
    const histRef = doc(histCol);
    const afterSnapshot =
      captureCurrentCriteriaSnapshot(currentSubjectId);

    await setDoc(histRef, {
      subjectId: currentSubjectId,
      teacherEmail: currentUser.email,
      teacherName: currentTeacherName || null,
      reason: currentEditReason,
      before: historyBeforeCriteriaSnapshot,
      after: afterSnapshot,
      editedAt: serverTimestamp(),
    });
  } catch (e) {
    alert("è©•ä¾¡åŸºæº–ã®å±¥æ­´ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n" + e.message);
    console.error("å±¥æ­´ä¿å­˜ã‚¨ãƒ©ãƒ¼:", e);
  }
}

// â˜… æœ€å¾Œã«UIã‚’å†æ§‹ç¯‰
await loadCriteria(currentSubjectId, { editable: false });


        isEditingExistingCriteria = false;
        currentEditReason = null;
        historyBeforeCriteriaSnapshot = null;

        showToast("è©•ä¾¡åŸºæº–ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚", "success");
        setSavedUI(true);
      } catch (e) {
        alert("è©•ä¾¡åŸºæº–ãƒ­ã‚°ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:\n" + e.message);
        console.error(e);
        showToast("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚", "error");
      }
    });

    // ================================
    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ & ãƒšãƒ¼ã‚¸é›¢è„±
    // ================================
    logoutBtn.addEventListener("click", async () => {
      await releaseCurrentLock();
      await signOut(auth);
      window.location.href = "index.html";
    });

    window.addEventListener("beforeunload", () => {
      // ãƒ™ã‚¹ãƒˆã‚¨ãƒ•ã‚©ãƒ¼ãƒˆã§ãƒ­ãƒƒã‚¯è§£æ”¾ï¼ˆéåŒæœŸã ãŒOKï¼‰
      releaseCurrentLock();
    });

    // ================================
    // èªè¨¼ç›£è¦–
    // ================================
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }
      currentUser = user;
      await loadTeacherName();
      userInfoDisplay.textContent =
        `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${currentTeacherName || user.email}ï¼ˆ${user.email}ï¼‰`;

      await loadTeacherSubjects();
      applyCurrentScheme();
    });
  </script>
</body>
</html>
