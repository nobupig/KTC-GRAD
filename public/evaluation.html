<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" href="kindai.png">
  <title>è¿‘å¤§é«˜å°‚ æˆç¸¾ã‚·ã‚¹ãƒ†ãƒ ï½œè©•ä¾¡åŸºæº–å…¥åŠ›</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: #f3f4f6;
      color: #111827;
    }
    header {
      background: #004A99;
      color: #fff;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 { font-size: 18px; margin: 0; }
    header .user-info { font-size: 12px; text-align: right; }
    header button {
      border: none;
      padding: 6px 12px;
      border-radius: 999px;
      cursor: pointer;
    }

    main {
      max-width: 1100px;
      margin: 20px auto;
      background: #fff;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.06);
    }
    h2 {
      font-size: 20px;
      border-left: 4px solid #004A99;
      padding-left: 10px;
      margin-top: 0;
    }

    .btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-primary { background: #004A99; color: white; }
    .btn-secondary { background: #e5e7eb; color: #111; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 13px; }
    thead { background: #f9fafb; }
    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 6px 8px; white-space: nowrap;
    }
    th:first-child, td:first-child { text-align: left; }
    tbody tr:hover { background: #f3f4f6; }

    .field { margin-bottom: 12px; }
    select, input {
      width: 100%; padding: 6px 8px;
      border-radius: 8px; border: 1px solid #d1d5db;
      font-size: 14px;
      box-sizing: border-box;
    }

    .total-area { margin-top: 12px; font-size: 14px; }

    .actions { margin-top: 16px; display: flex; gap: 8px; }

    /* â˜… è©•ä¾¡æ–¹å¼ã‚«ãƒ¼ãƒ‰UIï¼ˆæ¨ªä¸¦ã³ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰ */
    #schemeBlock {
      margin-top: 20px;
      margin-bottom: 20px;
      padding: 16px;
      background: #f8fafc;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
    }

    /* è©•ä¾¡æ–¹å¼ï¼šæ¨ªä¸¦ã³ã®æœ€çµ‚èª¿æ•´ */
    .scheme-row {
      display: flex;
      align-items: center;
      gap: 24px;
      margin-top: 10px;
    }

    .scheme-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      white-space: nowrap;
      min-width: 180px;
      cursor: pointer;
    }

    .scheme-item .icon {
      font-size: 16px;
      position: relative;
      top: 1px;
    }

    .scheme-item input[type="radio"] {
      transform: scale(1.1);
    }

    .scheme-item input[type="radio"]:checked + .icon + .text {
      font-weight: 600;
      color: #1e3a8a;
    }

    /* â–¼ ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š ã®è¡¨ç¤º */
    #userInfoArea {
      max-width: 1100px;
      margin: 4px auto 0;
      padding: 0 20px;
    }
    #userInfoDisplay {
      font-size: 14px;
      font-weight: 600;
      color: #1e3a8a;
      text-align: right;
    }

    /* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
    #toastContainer {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }
    
    .total-note {
      font-size: 12px;
      color: #dc2626;
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <header>
    <img src="kindai.png" alt="æ ¡ç« "
         style="width:32px; height:32px; margin-right:12px;">

    <h1>è¿‘å¤§é«˜å°‚ æˆç¸¾ã‚·ã‚¹ãƒ†ãƒ ï½œè©•ä¾¡åŸºæº–å…¥åŠ›</h1>

    <div class="user-info" style="display:flex; align-items:center; gap:10px;">
      <button id="viewModeBtn" class="btn btn-secondary" style="font-size:12px;"
        onclick="location.href='view.html'">
        ğŸ“„ é–²è¦§ãƒ¢ãƒ¼ãƒ‰
      </button>
      <button id="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </header>

  <div id="backArea"
    style="max-width:1100px; margin:10px auto 0; padding:0 20px;">
    <button id="backToSubjectsBtn" class="btn btn-secondary" style="font-size:12px;">
      â—€ ç§‘ç›®ç™»éŒ²ã«æˆ»ã‚‹
    </button>
  </div>

  <!-- â˜… ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼šè¡¨ç¤ºï¼ˆå¸¯ã®å¤–ãƒ»ã‚«ãƒ¼ãƒ‰ã¨åŒã˜å¹…ï¼å³å¯„ã›ï¼‰ -->
  <div id="userInfoArea">
    <div id="userInfoDisplay"></div>
  </div>

  <!-- ãƒˆãƒ¼ã‚¹ãƒˆ -->
  <div id="toastContainer"></div>

  <main>
    <div id="multiTeacherWarning" 
         style="display:none; 
                background:#fff3cd; 
                color:#856404; 
                padding:10px 14px; 
                border-radius:8px; 
                margin-bottom:12px;
                border:1px solid #ffeeba;">
      â€» ã“ã®ç§‘ç›®ã¯è¤‡æ•°ã®æ•™å“¡ãŒæ‹…å½“ç§‘ç›®ã«ç™»éŒ²ã—ã¦ã„ã¾ã™ã€‚èª¤ç™»éŒ²ã®å¯èƒ½æ€§ãŒã‚ã‚‹å ´åˆã€æ•™å‹™ã¸ã”é€£çµ¡ãã ã•ã„ã€‚
    </div>

    <h2>è©•ä¾¡åŸºæº–ã®è¨­å®š</h2>

    <div class="field" id="subjectSelectorArea">
      <label for="subjectSelect" style="font-size:13px; color:#4b5563;">æ‹…å½“ç§‘ç›®ã‚’é¸æŠ</label>
      <select id="subjectSelect">
        <option value="">ç§‘ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
      </select>
      <div id="subjectStatus" style="margin-top:6px; font-size:12px; color:#6b7280;"></div>
    </div>

    <div id="schemeBlock">
      <!-- â˜… è©•ä¾¡æ–¹å¼ã®é¸æŠ -->
      <div class="field" id="schemeSelectorArea" style="margin-bottom:16px;">
        <div style="font-size:13px; color:#4b5563; margin-bottom:4px;">è©•ä¾¡æ–¹å¼ã‚’é¸æŠ</div>
        <div class="scheme-row">
          <label class="scheme-item">
            <input type="radio" name="schemeType" value="exam_only" checked>
            <span class="icon">ğŸ“</span>
            <span class="text">è€ƒæŸ»ã®ã¿ã§è©•ä¾¡ï¼ˆæœŸæœ«è€ƒæŸ»100%ï¼‰</span>
          </label>
          <label class="scheme-item">
            <input type="radio" name="schemeType" value="exam_plus_assignments">
            <span class="icon">ğŸ“š</span>
            <span class="text">è€ƒæŸ»ï¼‹èª²é¡Œç­‰ã§è©•ä¾¡</span>
          </label>
          <label class="scheme-item">
            <input type="radio" name="schemeType" value="practice_only">
            <span class="icon">ğŸ§ª</span>
            <span class="text">å®Ÿé¨“ãƒ»å®Ÿç¿’ç³»ã®èª²é¡Œä½œå“ã§è©•ä¾¡</span>
          </label>
        </div>
      </div>
    </div>

    <table id="criteriaTable">
      <thead>
        <tr>
          <th>è©•ä¾¡é …ç›®</th>
          <th>å‰²åˆ (%)</th>
          <th>å‰Šé™¤</th>
        </tr>
      </thead>
      <tbody id="criteriaTbody"></tbody>
    </table>

    <div class="actions">
      <button id="addRowBtn" class="btn btn-secondary">+ è¡Œè¿½åŠ </button>
    </div>

    <div id="totalArea" class="total-area">åˆè¨ˆï¼š0%</div>
    <span id="totalNote" class="total-note">
      â€» è©•ä¾¡åŸºæº–ã®åˆè¨ˆã¯å¿…ãš100%ã¨ã—ã¦ãã ã•ã„ï¼ˆè¨±å®¹èª¤å·® Â±1%ï¼‰
    </span>

    <div class="actions" style="margin-top:20px;">
      <button id="saveBtn" class="btn btn-primary">ä¿å­˜ã™ã‚‹</button>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      getDocs,
      setDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // Firebase è¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyB-ykIzRvYbc5osV6WATu6BSOJt_zlHkgM",
      authDomain: "ktc-grade-system.firebaseapp.com",
      projectId: "ktc-grade-system",
      storageBucket: "ktc-grade-system.appspot.com",
      messagingSenderId: "490169300362",
      appId: "1:490169300362:web:7c6e7b47a394d68d514473"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM å‚ç…§
    const userInfoDisplay = document.getElementById("userInfoDisplay");
    const logoutBtn = document.getElementById("logoutBtn");
    const subjectSelect = document.getElementById("subjectSelect");
    const backToSubjectsBtn = document.getElementById("backToSubjectsBtn");
    const subjectStatus = document.getElementById("subjectStatus");
    const addRowBtn = document.getElementById("addRowBtn");
    const criteriaTbody = document.getElementById("criteriaTbody");
    const totalArea = document.getElementById("totalArea");
    const saveBtn = document.getElementById("saveBtn");
    const schemeRadios = document.querySelectorAll('input[name="schemeType"]');
    const toastContainer = document.getElementById("toastContainer");

    // ç§‘ç›®ç™»éŒ²ã¸æˆ»ã‚‹
    if (backToSubjectsBtn) {
      backToSubjectsBtn.addEventListener("click", () => {
        window.location.href = "subjects.html";
      });
    }

    const currentYear = new Date().getFullYear();
    const evalColName = `evaluationCriteria_${currentYear}`;

    let currentUser = null;
    let currentTeacherName = "";
    let currentScheme = "exam_only";

    // ãƒˆãƒ¼ã‚¹ãƒˆ
    function showToast(message, type = "success") {
      if (!toastContainer) return;

      const toast = document.createElement("div");
      toast.textContent = message;
      toast.style.minWidth = "260px";
      toast.style.maxWidth = "360px";
      toast.style.background = type === "success" ? "#16a34a" : "#dc2626";
      toast.style.color = "#fff";
      toast.style.padding = "12px 18px";
      toast.style.marginTop = "10px";
      toast.style.borderRadius = "10px";
      toast.style.boxShadow = "0 4px 14px rgba(0,0,0,0.2)";
      toast.style.fontSize = "14px";
      toast.style.opacity = "0";
      toast.style.transform = "translateY(-10px)";
      toast.style.transition = "all 0.3s ease";

      toastContainer.appendChild(toast);

      requestAnimationFrame(() => {
        toast.style.opacity = "1";
        toast.style.transform = "translateY(0)";
      });

      setTimeout(() => {
        toast.style.opacity = "0";
        toast.style.transform = "translateY(-10px)";
        setTimeout(() => toast.remove(), 300);
      }, 2500);
    }

    // æ•™å“¡åå–å¾—
    async function loadTeacherName() {
      if (!currentUser) return;
      const ref = doc(db, "teachers", currentUser.email);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        currentTeacherName = snap.data().name || "";
      } else {
        currentTeacherName = "";
      }
    }

    // æ‹…å½“ç§‘ç›®å–å¾—
    async function loadTeacherSubjects() {
      if (!currentUser) return;
      subjectSelect.innerHTML = '<option value="">ç§‘ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
      subjectStatus.textContent = "";

      const year = new Date().getFullYear();
      const ref = doc(db, `teacherSubjects_${year}`, currentUser.email);
      const snap = await getDoc(ref);

      if (!snap.exists() || !snap.data().subjects || !snap.data().subjects.length) {
        subjectStatus.textContent =
          "æ‹…å½“ç§‘ç›®ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã¾ãšç§‘ç›®ç™»éŒ²ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚";
        return;
      }

      const subjects = snap.data().subjects;
      let hasNormal = false;

      subjects.forEach((s) => {
        const opt = document.createElement("option");
        opt.value = s.subjectId || "";

        const baseLabel = `${s.grade}å¹´ / ${s.course} / ${s.semester} / ${s.name}`;

        if (s.specialType === true) {
          opt.textContent = `${baseLabel}ï¼ˆè©•ä¾¡åŸºæº–å…¥åŠ›ä¸è¦ï¼‰`;
          opt.disabled = true;
        } else {
          opt.textContent = baseLabel;
          hasNormal = true;
        }

        subjectSelect.appendChild(opt);
      });

      if (!hasNormal) {
        subjectStatus.textContent =
          "ã“ã®æ•™å“¡ãŒæ‹…å½“ã™ã‚‹ç§‘ç›®ã¯ã€ã™ã¹ã¦ã€è©•ä¾¡åŸºæº–å…¥åŠ›ä¸è¦ã®ç‰¹åˆ¥ç§‘ç›®ã€ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚æˆç¸¾å…¥åŠ›ç”»é¢ã‹ã‚‰ç›´æ¥å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
      }
    }

    // è©•ä¾¡åŸºæº–ã®èª­ã¿è¾¼ã¿
    async function loadCriteria(subjectId) {
      if (!currentUser || !subjectId) {
        criteriaTbody.innerHTML = "";
        applyCurrentScheme();
        return;
      }

      const docId = `${currentUser.email}_${subjectId}`;
      const ref = doc(db, evalColName, docId);
      const snap = await getDoc(ref);

      if (!snap.exists()) {
        applyCurrentScheme();
        return;
      }

      const data = snap.data();

      const method = data.method || "exam_only";
      currentScheme = method;
      const radio = document.querySelector(
        `input[name="schemeType"][value="${method}"]`
      );
      if (radio) radio.checked = true;

      applyCurrentScheme();

      criteriaTbody.innerHTML = "";
      (data.items || []).forEach((item) => {
        addCriteriaRow(item.name, item.percent, {
          fixedName: false,
          fixedPercent: false,
          allowDelete: true
        });
      });

      const totalPercent = data.totalPercent || 0;
      totalArea.textContent = `åˆè¨ˆï¼š${totalPercent}%`;

      updateTotal();

      if (data.isSaved === true) {
        lockUI();
      }
    }

    // è¡Œè¿½åŠ 
    function addCriteriaRow(itemName = "", percent = "", options = {}) {
      const {
        fixedName = false,
        fixedPercent = false,
        allowDelete = true
      } = options;

      const tr = document.createElement("tr");

      const tdName = document.createElement("td");
      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.placeholder = "ä¾‹ï¼šãƒ¬ãƒãƒ¼ãƒˆ";
      nameInput.value = itemName;
      nameInput.dataset.fixed = fixedName ? "true" : "false";
      if (fixedName) {
        nameInput.readOnly = true;
        nameInput.style.backgroundColor = "#f3f4f6";
      }
      tdName.appendChild(nameInput);

      const tdPercent = document.createElement("td");
      const percentInput = document.createElement("input");
      percentInput.type = "number";
      percentInput.min = "0";
      percentInput.max = "100";
      percentInput.value = percent;
      percentInput.dataset.fixed = fixedPercent ? "true" : "false";
      if (fixedPercent) {
        percentInput.readOnly = true;
        percentInput.style.backgroundColor = "#f3f4f6";
      } else {
        percentInput.addEventListener("input", updateTotal);
      }
      tdPercent.appendChild(percentInput);

      const tdDelete = document.createElement("td");
      if (allowDelete) {
        const delBtn = document.createElement("button");
        delBtn.className = "btn btn-secondary";
        delBtn.style.fontSize = "12px";
        delBtn.textContent = "å‰Šé™¤";
        delBtn.addEventListener("click", () => {
          tr.remove();
          updateTotal();
        });
        tdDelete.appendChild(delBtn);
      } else {
        tdDelete.textContent = "-";
      }

      tr.appendChild(tdName);
      tr.appendChild(tdPercent);
      tr.appendChild(tdDelete);

      criteriaTbody.appendChild(tr);
    }

    // â˜… è©•ä¾¡æ–¹å¼ã”ã¨ã®è¡Œã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    function setupSchemeExamOnly() {
      currentScheme = "exam_only";
      criteriaTbody.innerHTML = "";
      addRowBtn.disabled = true;
      addCriteriaRow("æœŸæœ«è€ƒæŸ»", 100, {
        fixedName: true,
        fixedPercent: true,
        allowDelete: false
      });
      updateTotal();
    }

   function setupSchemeExamPlusAssignments() {
  currentScheme = "exam_plus_assignments";
  criteriaTbody.innerHTML = "";
  addRowBtn.disabled = false;

  // â˜… æœŸæœ«è€ƒæŸ»ï¼ˆå›ºå®šï¼‰
  addCriteriaRow("æœŸæœ«è€ƒæŸ»", "", {
    fixedName: true,
    fixedPercent: false,
    allowDelete: false
  });

  // â˜… ç©ºæ¬„ã®è‡ªç”±å…¥åŠ›è¡Œã‚’1ã¤è¿½åŠ ï¼ˆâ†ã“ã‚ŒãŒä»Šå›ã®è¿½åŠ ï¼‰
  addCriteriaRow("", "", {
    fixedName: false,
    fixedPercent: false,
    allowDelete: true
  });

  updateTotal();
}


    function setupSchemePracticeOnly() {
      currentScheme = "practice_only";
      criteriaTbody.innerHTML = "";
      addRowBtn.disabled = false;
      addCriteriaRow("", "", {
        fixedName: false,
        fixedPercent: false,
        allowDelete: true
      });
      updateTotal();
    }

    // â˜… ç§‘ç›®åˆ‡ã‚Šæ›¿ãˆæ™‚ã«è©•ä¾¡åŸºæº–UIå…¨ä½“ã‚’åˆæœŸçŠ¶æ…‹ã¸ãƒªã‚»ãƒƒãƒˆ
    function resetEvaluationUI() {
      saveBtn.textContent = "ä¿å­˜ã™ã‚‹";
      saveBtn.disabled = false;
      saveBtn.style.opacity = "1";

      const editBtn = document.getElementById("editBtn");
      if (editBtn) {
        editBtn.remove();
      }

      if (schemeRadios && schemeRadios.forEach) {
        schemeRadios.forEach((radio) => {
          radio.disabled = false;
        });
      }

      criteriaTbody.innerHTML = "";
      addRowBtn.disabled = false;

      totalArea.textContent = "åˆè¨ˆï¼š0%";
      totalArea.style.color = "#111827";
    }

    function applyCurrentScheme() {
      const scheme = document.querySelector(
        'input[name="schemeType"]:checked'
      ).value;
      if (scheme === "exam_only") setupSchemeExamOnly();
      else if (scheme === "exam_plus_assignments") setupSchemeExamPlusAssignments();
      else setupSchemePracticeOnly();
    }

    // åˆè¨ˆè¨ˆç®—
    function updateTotal() {
      const inputs = criteriaTbody.querySelectorAll("input[type='number']");
      let total = 0;
      inputs.forEach((el) => {
        const val = parseFloat(el.value);
        if (!isNaN(val)) total += val;
      });

      totalArea.textContent = `åˆè¨ˆï¼š${total}%`;

      const lower = 99;
      const upper = 101;

      if (currentScheme === "exam_only") {
        totalArea.style.color = "#111827";
        // exam_only ã¯å¸¸ã«OK
        saveBtn.disabled = false;
        return;
      }

      if (total >= lower && total <= upper) {
        totalArea.style.color = "#111827";
        if (saveBtn.dataset.mode !== "locked") {
          saveBtn.disabled = false;
        }
      } else {
        totalArea.style.color = "#b91c1c";
        if (saveBtn.dataset.mode !== "locked") {
          saveBtn.disabled = true;
        }
      }
    }

    function lockUI() {
      criteriaTbody.querySelectorAll("input").forEach((inp) => {
        inp.readOnly = true;
        inp.disabled = true;
        inp.style.backgroundColor = "#f3f4f6";
      });

      criteriaTbody.querySelectorAll("button").forEach((btn) => {
        btn.style.display = "none";
      });

      addRowBtn.disabled = true;
      schemeRadios.forEach((r) => {
        r.disabled = true;
      });

      saveBtn.disabled = true;
      saveBtn.textContent = "ä¿å­˜æ¸ˆã¿";
      saveBtn.dataset.mode = "locked";

      let editBtn = document.getElementById("editBtn");
      if (!editBtn) {
        const btn = document.createElement("button");
        btn.id = "editBtn";
        btn.className = "btn btn-secondary";
        btn.style.marginLeft = "8px";
        btn.textContent = "ä¿®æ­£ã™ã‚‹";
        saveBtn.parentNode.appendChild(btn);
        btn.addEventListener("click", unlockUI);
        editBtn = btn;
      }
      editBtn.style.display = "inline-block";
    }

    function unlockUI() {
      criteriaTbody.querySelectorAll("input").forEach((inp) => {
        inp.readOnly = false;
        inp.disabled = false;
        inp.style.backgroundColor = "";
      });

      criteriaTbody.querySelectorAll("button").forEach((btn) => {
        btn.style.display = "inline-block";
      });

      addRowBtn.disabled = false;
      schemeRadios.forEach((r) => {
        r.disabled = false;
      });

      saveBtn.disabled = false;
      saveBtn.textContent = "ä¿å­˜ã™ã‚‹ï¼ˆä¿®æ­£åæ˜ ï¼‰";
      saveBtn.dataset.mode = "edit";

      const editBtn = document.getElementById("editBtn");
      if (editBtn) {
        editBtn.style.display = "none";
      }
    }

    // â˜… åŒä¸€ç§‘ç›®ã‚’ç™»éŒ²ã—ã¦ã„ã‚‹æ•™å“¡ã®äººæ•°ã‚’èª¿ã¹ã‚‹
    async function checkMultiTeacher(subjectId) {
      const thisCollection = `teacherSubjects_${currentYear}`;
      const colRef = collection(db, thisCollection);
      const snap = await getDocs(colRef);

      let count = 0;

      snap.forEach((docSnap) => {
        const data = docSnap.data();
        if (!data.subjects) return;

        const has = data.subjects.some((s) => s.subjectId === subjectId);
        if (has) count++;
      });

      return count;
    }

    // è©•ä¾¡æ–¹å¼å¤‰æ›´
    schemeRadios.forEach((radio) => {
      radio.addEventListener("change", (e) => {
        if (!e.target.checked) return;

        const value = e.target.value;
        if (value === "exam_only") {
          setupSchemeExamOnly();
        } else if (value === "exam_plus_assignments") {
          setupSchemeExamPlusAssignments();
        } else if (value === "practice_only") {
          setupSchemePracticeOnly();
        }
      });
    });

    // è¡Œè¿½åŠ ãƒœã‚¿ãƒ³
    addRowBtn.addEventListener("click", () => {
      addCriteriaRow("", "", {
        fixedName: false,
        fixedPercent: false,
        allowDelete: true
      });
      updateTotal();
    });

    // ç§‘ç›®é¸æŠ
    subjectSelect.addEventListener("change", async () => {
      // â˜… ç§‘ç›®åˆ‡æ›¿æ™‚ã« UI ã‚’å¿…ãšåˆæœŸåŒ–ï¼ˆãƒ­ãƒƒã‚¯çŠ¶æ…‹ã‚’è§£é™¤ï¼‰
      resetEvaluationUI();

      const selectedOption =
        subjectSelect.options[subjectSelect.selectedIndex];
      const subjectId = selectedOption ? selectedOption.value : "";

      // â˜… åˆæœŸè©•ä¾¡æ–¹å¼ã‚’è‡ªå‹•ã‚»ãƒƒãƒˆï¼ˆæœªä¿å­˜ç§‘ç›®ã®åˆæœŸçŠ¶æ…‹å‘ã‘ï¼‰
      applyCurrentScheme();

      await loadCriteria(subjectId);

      // â˜… è¤‡æ•°æ‹…å½“ãƒã‚§ãƒƒã‚¯ï¼ˆæ—¢å­˜å‡¦ç†ã‚’ç¶­æŒï¼‰
      const multiCount = await checkMultiTeacher(subjectId);
      const warningEl = document.getElementById("multiTeacherWarning");
      if (multiCount > 1) {
        warningEl.style.display = "block";
      } else {
        warningEl.style.display = "none";
      }
    });

    // ä¿å­˜ãƒœã‚¿ãƒ³
    saveBtn.addEventListener("click", async () => {
      const text = totalArea.textContent || "";
      const match = text.match(/åˆè¨ˆï¼š(\d+(\.\d+)?)%/);
      const total = match ? parseFloat(match[1]) : null;

      if (
        currentScheme !== "exam_only" &&
        (total === null || total < 99 || total > 101)
      ) {
        alert("åˆè¨ˆãŒ100%ã«ãªã‚‹ã‚ˆã†ã«èª¿æ•´ã—ã¦ãã ã•ã„ã€‚ï¼ˆè¨±å®¹èª¤å·® Â±1%ï¼‰");
        return;
      }

      if (!currentUser) {
        alert("ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const selectedOption =
        subjectSelect.options[subjectSelect.selectedIndex];
      const subjectId = selectedOption ? selectedOption.value : "";
      const subjectName = selectedOption ? selectedOption.textContent : "";

      if (!subjectId) {
        alert("ç§‘ç›®ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        return;
      }

      const scheme = document.querySelector(
        'input[name="schemeType"]:checked'
      ).value;

      const rows = criteriaTbody.querySelectorAll("tr");
      const criteria = [];

      for (const tr of rows) {
        const nameInput = tr.querySelector("td:nth-child(1) input");
        const percentInput = tr.querySelector("td:nth-child(2) input");

        const name = nameInput.value.trim();
        const percentValue = percentInput.value.trim();
        const percent = parseFloat(percentValue);

        if (name === "") {
          alert("è©•ä¾¡é …ç›®åãŒç©ºæ¬„ã®è¡ŒãŒã‚ã‚Šã¾ã™ã€‚å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
          nameInput.focus();
          return;
        }

        if (percentValue === "") {
          alert(`ã€Œ${name}ã€ã®å‰²åˆ(%)ãŒæœªå…¥åŠ›ã§ã™ã€‚`);
          percentInput.focus();
          return;
        }

        if (isNaN(percent)) {
          alert(`ã€Œ${name}ã€ã®å‰²åˆ(%)ã¯æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
          percentInput.focus();
          return;
        }

        if (percent < 0 || percent > 100) {
          alert(`ã€Œ${name}ã€ã®å‰²åˆ(%)ã¯ 0ï½100 ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
          percentInput.focus();
          return;
        }

        const isFixedName = nameInput.dataset.fixed === "true";
        const isFixedPercent = percentInput.dataset.fixed === "true";

        criteria.push({
          name,
          percent,
          fixedName: isFixedName,
          fixedPercent: isFixedPercent
        });
      }

      try {
        const payload = {
          teacherEmail: currentUser.email,
          subjectId,
          items: criteria.map((c) => ({
            name: c.name,
            percent: c.percent
          })),
          totalPercent: total,
          method: scheme,
          isSaved: true,
          savedAt: serverTimestamp(),
          savedBy: currentUser.email
        };

        const docId = `${currentUser.email}_${subjectId}`;

        await setDoc(doc(db, evalColName, docId), payload, { merge: true });

        showToast("è©•ä¾¡åŸºæº–ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚", "success");
        lockUI();
      } catch (e) {
        console.error(e);
        showToast("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚", "error");
      }
    });

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "login.html";
    });

    // èªè¨¼ç›£è¦–
    console.log("Referrer:", document.referrer);
    onAuthStateChanged(auth, async (user) => {
      if (user === null) {
        const referrer = document.referrer || "";
        const fromSubjects = referrer.includes("subjects.html");
        if (fromSubjects) {
          return;
        }
        window.location.href = "login.html";
        return;
      }
      currentUser = user;
      await loadTeacherName();
      userInfoDisplay.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${currentTeacherName || user.email}ï¼ˆ${user.email}ï¼‰`;
      await loadTeacherSubjects();

      // åˆæœŸè©•ä¾¡æ–¹å¼ã®é©ç”¨ï¼ˆæ–°è¦æ™‚ã¯ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼‰
      applyCurrentScheme();
    });
  </script>
</body>
</html>
