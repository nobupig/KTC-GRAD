<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" href="kindai.png">
  <title>æˆç¸¾å…¥åŠ›ï½œè¿‘å¤§é«˜å°‚</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: "Yu Gothic UI", system-ui, sans-serif;
      background: #f5f5f7;
      color: #111;
    }

    header {
      background: #004a99;
      color: #fff;
      padding: 16px 24px;
    }
    header .header-inner {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
    }
    .home-btn {
      background: #0066cc;
      color: white;
      padding: 6px 14px;
      border-radius: 6px;
      text-decoration: none;
      font-size: 14px;
    }

    main {
      max-width: 1100px;
      margin: 24px auto;
      padding: 0 16px 32px;
    }

    .subject-box {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.06);
      margin-bottom: 22px;
    }

    .subject-title {
      font-weight: 700;
      margin-bottom: 10px;
      font-size: 16px;
    }

    .subject-links {
      margin-top: 10px;
      display: flex;
      gap: 16px;
    }
    .subject-link-btn {
      color: #004a99;
      font-size: 14px;
      text-decoration: underline;
      cursor: pointer;
    }

    .table-wrapper {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.06);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 10px 12px;
    }
    th {
      text-align: left;
      color: #4b5563;
      font-weight: 600;
      background: #f9fafb;
    }

    .actions {
      margin-top: 16px;
      display: flex;
      justify-content: flex-end;
    }

    .btn-save {
      background: #004a99;
      color: #fff;
      border: none;
      border-radius: 999px;
      padding: 10px 20px;
      font-size: 14px;
      cursor: pointer;
    }
    .btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      background: #e5e7eb;
      color: #111;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111;
    }
  </style>
</head>
<body>

<header>
  <div class="header-inner">
    <h1>è¿‘å¤§é«˜å°‚ æˆç¸¾ã‚·ã‚¹ãƒ†ãƒ ï½œæˆç¸¾å…¥åŠ›</h1>
    <button id="logoutBtn" class="home-btn" style="background:#d97706;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
</header>

<div id="userInfoArea" style="max-width:1100px; margin:4px auto 0; padding:0 20px;">
  <div id="userInfoDisplay" style="font-size:14px; font-weight:600; color:#1e3a8a; text-align:right;"></div>
</div>

<main>

  <div style="max-width:1100px; margin:8px auto; padding:0 16px;">
    <button class="btn btn-secondary" onclick="location.href='start.html'" style="font-size:13px;">
      ğŸ  ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹
    </button>
  </div>

  <!-- ===== å¯¾è±¡ç§‘ç›®ãƒœãƒƒã‚¯ã‚¹ ===== -->
  <section class="subject-box">
    <div class="subject-title">
      å¯¾è±¡ç§‘ç›®ï¼š <span id="subjectName">ç§‘ç›®æœªé¸æŠ</span>
    </div>

    <!-- ç§‘ç›®åˆ‡ã‚Šæ›¿ãˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ -->
    <select id="subjectSelector"
      style="padding:6px 10px; border-radius:8px; border:1px solid #d1d5db; font-size:13px; display:none;">
    </select>

    <!-- è©•ä¾¡åŸºæº–ã¸ / ç§‘ç›®ç™»éŒ²ã¸ -->
    <div class="subject-links">
      <span id="btnEvaluation" class="subject-link-btn">è©•ä¾¡åŸºæº–ã¸</span>
      <span id="btnSubjects" class="subject-link-btn">ç§‘ç›®ç™»éŒ²ã¸</span>
    </div>
  </section>

  <!-- ===== æˆç¸¾ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« ===== -->
  <section class="table-wrapper">
    <div style="margin-bottom:12px; font-size:14px; color:#374151;">æˆç¸¾ä¸€è¦§</div>

    <table id="scoreTable">
      <thead>
        <tr id="scoreHeaderRow">
          <!-- JS ã§å‹•çš„ã«ãƒ˜ãƒƒãƒ€ã‚’åŸ‹ã‚ã‚‹ -->
        </tr>
      </thead>
      <tbody id="scoreTableBody">
        <!-- å­¦ç”Ÿè¡ŒãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
      </tbody>
    </table>

    <div class="actions">
      <button class="btn-save">ä¿å­˜ã™ã‚‹</button>
    </div>
  </section>

</main>

<!-- ============================== -->
<!-- Firebase scripts -->
<!-- ============================== -->
<script type="module">
  // â˜… é‡ã¿ï¼ˆå‰²åˆï¼‰ã‚’æ­£è¦åŒ–ã™ã‚‹é–¢æ•°ï¼ˆåˆè¨ˆ99ã€œ101% â†’ 100%ã«ä¸¸ã‚ã‚‹ï¼‰
  function normalizeWeights(weights) {
    const safe = weights.map((w) => {
      const n = typeof w === "number" ? w : parseFloat(w || "0");
      return Number.isNaN(n) ? 0 : n;
    });

    const sum = safe.reduce((a, b) => a + b, 0);

    if (sum >= 99 && sum <= 101 && sum > 0) {
      return safe.map((w) => (w / sum) * 100);
    }

    return safe;
  }

  // â˜… 1è¡Œåˆ†ã®åˆè¨ˆç‚¹ã‚’è¨ˆç®—ã™ã‚‹ï¼ˆç´ ç‚¹ãƒ¢ãƒ¼ãƒ‰ï¼‰
  function calculateTotalForRow(rowElem, normalizedWeights) {
    const inputs = rowElem.querySelectorAll("input.score-input");
    let total = 0;

    inputs.forEach((inp, idx) => {
      const raw = parseFloat(inp.value || "0");
      if (Number.isNaN(raw)) return;

      const weight = normalizedWeights[idx] || 0;
      total += raw * (weight / 100);
    });

    // å°æ•°ç‚¹1æ¡ã¾ã§
    total = Math.round(total * 10) / 10;

    // æœ€çµ‚æˆç¸¾ã‚»ãƒ«ã¸åæ˜ 
    const totalCell = rowElem.querySelector(".final-score");
    if (totalCell) {
      totalCell.textContent = total || "";
    }
  }
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    getDocs,
    doc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  /* ===== Firebase åˆæœŸåŒ– ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyB-ykIzRvYbc5osV6WATu6BSOJt_zlHkgM",
    authDomain: "ktc-grade-system.firebaseapp.com",
    projectId: "ktc-grade-system",
    storageBucket: "ktc-grade-system.appspot.com",
    messagingSenderId: "490169300362",
    appId: "1:490169300362:web:7c6e7b47a394d68d514473",
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  /* ===== DOM ===== */
  const subjectNameEl = document.getElementById("subjectName");
  const subjectSelector = document.getElementById("subjectSelector");
  const scoreTableBody = document.getElementById("scoreTableBody");
  const logoutBtn = document.getElementById("logoutBtn");
  const userInfoDisplay = document.getElementById("userInfoDisplay");

  const btnEvaluation = document.getElementById("btnEvaluation");
  const btnSubjects = document.getElementById("btnSubjects");

  if (logoutBtn) {
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "index.html";
    });
  }

  const params = new URLSearchParams(window.location.search);
  let currentSubjectId = params.get("subjectId") || null;
  
    subjectSelector.addEventListener("change", async (e) => {
      const newId = e.target.value;
      currentSubjectId = newId;
      const url = new URL(window.location.href);
      url.searchParams.set("subjectId", newId);
      window.history.replaceState(null, "", url.toString());
      updateSubjectHeader();
      // A-2-3: è©•ä¾¡åŸºæº–â†’å­¦ç”Ÿåç°¿â†’ãƒ˜ãƒƒãƒ€â†’è¡Œæç”»ã®é †ã§å¿…ãšå†æç”»
      await loadCriteriaForSubject(currentSubjectId);
      await loadStudents();
      renderScoreHeader();
      renderStudentRows();
    });

  const year = new Date().getFullYear();
  const criteriaCollection = `evaluationCriteria_${year}`;
  const teacherSubjectsCollection = `teacherSubjects_${year}`;

  let teacherSubjects = [];
  let currentUser = null;
  let criteriaItems = [];
  let normalizedWeights = [];
  let cachedStudents = [];

  function updateSubjectHeader() {
    if (!subjectNameEl) return;

    const target = Array.isArray(teacherSubjects)
      ? teacherSubjects.find((s) => s.subjectId === currentSubjectId)
      : null;

    if (target) {
      const label = `${target.grade ?? ""}å¹´ / ${target.course ?? ""} / ${target.semester ?? ""} / ${target.name ?? ""}`;
      subjectNameEl.textContent = label;
    } else {
      subjectNameEl.textContent = "ç§‘ç›®æœªé¸æŠ";
    }

    if (subjectSelector) {
      if (Array.isArray(teacherSubjects) && teacherSubjects.length > 1) {
        subjectSelector.style.display = "inline-block";
      } else {
        subjectSelector.style.display = "none";
      }
    }
  }

  async function loadTeacherSubjects() {
    if (!currentUser) return;

    teacherSubjects = [];

    const tsRef = doc(db, teacherSubjectsCollection, currentUser.email);
    const tsSnap = await getDoc(tsRef);

    if (!tsSnap.exists()) {
      teacherSubjects = [];
      if (subjectSelector) {
        subjectSelector.innerHTML = "";
        subjectSelector.style.display = "none";
      }
      updateSubjectHeader();
      return;
    }

    const data = tsSnap.data() || {};
    const subjects = Array.isArray(data.subjects) ? data.subjects : [];

    const uniqueMap = new Map();
    for (const s of subjects) {
      if (!s || !s.subjectId) continue;
      if (!uniqueMap.has(s.subjectId)) {
        uniqueMap.set(s.subjectId, s);
      }
    }

    const uniqueSubjects = Array.from(uniqueMap.values());
    teacherSubjects = uniqueSubjects;

    if (subjectSelector) {
      subjectSelector.innerHTML = "";

      uniqueSubjects.forEach((s) => {
        const opt = document.createElement("option");
        opt.value = s.subjectId;
        opt.textContent = `${s.grade ?? ""}å¹´ / ${s.course ?? ""} / ${s.semester ?? ""} / ${s.name ?? ""}`;
        subjectSelector.appendChild(opt);
      });

      const existsInList = uniqueSubjects.some((s) => s.subjectId === currentSubjectId);
      if (!existsInList) {
        currentSubjectId = uniqueSubjects.length > 0 ? uniqueSubjects[0].subjectId : null;
      }

      if (currentSubjectId) {
        subjectSelector.value = currentSubjectId;
      }

      if (uniqueSubjects.length > 1) {
        subjectSelector.style.display = "inline-block";
      } else {
        subjectSelector.style.display = "none";
      }
    }

    updateSubjectHeader();
  }
  function renderStudentRows() {
    if (!scoreTableBody || !Array.isArray(cachedStudents)) return;

    scoreTableBody.innerHTML = "";

    if (cachedStudents.length === 0) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 20;
      td.style.textAlign = "center";
      td.textContent = "å­¦ç”Ÿæƒ…å ±ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
      tr.appendChild(td);
      scoreTableBody.appendChild(tr);
      return;
    }

    const frag = document.createDocumentFragment();

    cachedStudents.forEach((s, index) => {
      const tr = document.createElement("tr");

      const studentId = s.studentId ?? "";
      const grade = s.grade ?? "";
      const courseClass = s.courseClass ?? s.course ?? "";
      const number = (s.number ?? "").toString();
      const name = s.name ?? s.studentName ?? "";

      const addCell = (text) => {
        const td = document.createElement("td");
        td.textContent = text;
        tr.appendChild(td);
      };

      addCell(studentId);
      addCell(grade);
      addCell(courseClass);
      addCell(number);
      addCell(name);

      // A-2-2: è©•ä¾¡åŸºæº–ã«é€£å‹•ã—ãŸå…¥åŠ›æ¬„
      if (criteriaItems && criteriaItems.length > 0) {
        criteriaItems.forEach((item, idx) => {
          const td = document.createElement("td");
          const input = document.createElement("input");
          input.type = "number";
          input.min = "0";
          input.max = "100";
          input.step = "0.1";
          input.classList.add("score-input");
          input.dataset.rowIndex = String(index);
          input.dataset.criteriaIndex = String(idx);
          td.appendChild(input);
          tr.appendChild(td);
        });
      }

      // æœ€çµ‚æˆç¸¾æ¬„ï¼ˆç·¨é›†ä¸å¯ï¼‰
      const finalTd = document.createElement("td");
      const finalSpan = document.createElement("span");
      finalSpan.classList.add("final-score");
      finalSpan.textContent = "";
      finalTd.appendChild(finalSpan);
      tr.appendChild(finalTd);

      frag.appendChild(tr);
    });

    scoreTableBody.appendChild(frag);
  }

  /* ===== è©•ä¾¡åŸºæº–ã¸ ===== */
  btnEvaluation.addEventListener("click", () => {
    if (currentSubjectId) {
      const sid = encodeURIComponent(currentSubjectId);
      window.location.href = `evaluation.html?subjectId=${sid}`;
    }
  });

  /* ===== ç§‘ç›®ç™»éŒ²ã¸ ===== */
  btnSubjects.addEventListener("click", () => {
    window.location.href = "subjects.html";
  });

  /* ===== è©•ä¾¡åŸºæº–å–å¾— ===== */
  async function loadCriteriaForSubject(subjectId) {
    criteriaItems = [];
    normalizedWeights = [];

    if (!subjectId) {
      renderScoreHeader();
      return;
    }

    const year = new Date().getFullYear();
    const colName = `evaluationCriteria_${year}`;
    const ref = doc(db, colName, subjectId);
    const snap = await getDoc(ref);

    if (!snap.exists()) {
      renderScoreHeader();
      return;
    }

    const data = snap.data();
    criteriaItems = Array.isArray(data.items) ? data.items : [];

    const rawWeights = criteriaItems.map((item) =>
      typeof item.percent === "number"
        ? item.percent
        : parseFloat(item.percent ?? "0")
    );

    normalizedWeights = rawWeights;

    renderScoreHeader();
  }

  function renderScoreHeader() {
    const headerRow = document.getElementById("scoreHeaderRow");
    if (!headerRow) return;
    // A-2-1: ã¾ãšåˆæœŸåŒ–
    headerRow.innerHTML = "";

    // å›ºå®šåˆ—
    const addTh = (text) => {
      const th = document.createElement("th");
      th.textContent = text;
      headerRow.appendChild(th);
    };
    addTh("å­¦ç±ç•ªå·");
    addTh("å­¦å¹´");
    addTh("çµ„ãƒ»ã‚³ãƒ¼ã‚¹");
    addTh("ç•ªå·");
    addTh("æ°å");

    // è©•ä¾¡åŸºæº–ã«é€£å‹•ã—ãŸåˆ—
    if (criteriaItems && criteriaItems.length > 0) {
      for (const item of criteriaItems) {
        const name = item.name ?? "";
        const percent = item.percent ?? "";
        const label = percent !== "" ? `${name} (${percent}%)` : name;
        addTh(label);
      }
    }

    // æœ€çµ‚æˆç¸¾åˆ—
    addTh("æœ€çµ‚æˆç¸¾");
  }

  /* ===== å­¦ç”Ÿä¸€è¦§ ===== */
  async function loadStudents() {
    const snap = await getDocs(collection(db, "students"));
    const list = [];
    snap.forEach((d) => list.push(d.data()));

    list.sort((a, b) => {
      if (a.grade !== b.grade) return (a.grade || 0) - (b.grade || 0);

      const courseA = a.courseClass || a.course || "";
      const courseB = b.courseClass || b.course || "";
      if (courseA !== courseB) return courseA.localeCompare(courseB);

      return (a.number || 0) - (b.number || 0);
    });

    cachedStudents = list;
  }

  /* ===== ãƒ¡ã‚¤ãƒ³åˆæœŸåŒ– ===== */
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "index.html";
      return;
    }
    currentUser = user;

    const teacherRef = doc(db, "teachers", user.email);
    const teacherSnap = await getDoc(teacherRef);
    if (!teacherSnap.exists()) {
      alert("æ•™å“¡æƒ…å ±ãŒç¢ºèªã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„ã€‚");
      await signOut(auth);
      window.location.href = "index.html";
      return;
    }
    const teacherName = teacherSnap.data()?.name || "";
    if (userInfoDisplay) {
      userInfoDisplay.textContent =
        `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${teacherName || user.email}ï¼ˆ${user.email}ï¼‰`;
    }

    await loadTeacherSubjects();
    await loadCriteriaForSubject(currentSubjectId);
    await loadStudents();
    renderStudentRows();
  });

</script>

</body>
<!-- è©•ä¾¡åŸºæº–æœªç™»éŒ²ã‚¨ãƒ©ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="criteriaErrorModal" style="
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.4);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
">
  <div style="
    background: white;
    padding: 24px 32px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.25);
    max-width: 360px;
    text-align: center;
  ">
    <div style="font-size: 32px; color: #dc2626; margin-bottom: 10px;">âš ï¸</div>
    <div style="font-size: 16px; font-weight: 600; margin-bottom: 20px;">
      è©•ä¾¡åŸºæº–ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
    </div>
    <button id="criteriaErrorOkBtn" class="btn btn-primary" style="width: 120px;">
      OK
    </button>
  </div>
</div>
</html>
