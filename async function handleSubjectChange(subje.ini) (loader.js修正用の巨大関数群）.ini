  async function handleSubjectChange(subjectId) {
 
    
    const submissionContext = window.__submissionContext;

    window.isSubjectChanging = true;

    // =====================================================
    // â˜… å‰ç§‘ç›®ã®ã€Œå…¨å“¡è¡¨ç¤ºãƒ­ãƒƒã‚¯ã€æ®‹ç•™ã‚’æœ€å„ªå…ˆã§æƒé™¤ã™ã‚‹
    //  - __currentFilterKey ãŒ "all" ã®ã¾ã¾
    //  - __submissionContext.requiredUnits ãŒè¤‡æ•°ã®ã¾ã¾
    //  ãŒæ®‹ã‚‹ã¨ã€å˜ä¸€ç§‘ç›®ã§ã‚‚ applyReadOnlyState("all") ãŒèª¤ç™ºç«ã™ã‚‹
    // =====================================================
    window.__currentFilterKey = null;
    window.__lastAppliedUnitKey = null;
     if (!window.__isEditMode) {
   window.__submissionContext = { requiredUnits: [], unitKey: null };
 }

    // â˜… å‰ç§‘ç›®ã® scoresDoc(completionç­‰) ã‚’å…ˆã«ç ´æ£„ï¼ˆunlock ã®èª¤åˆ¤å®šã‚’é˜²ãï¼‰
    window.__latestScoresDocData = null;

    // â˜… è¡¨ç¤ºãƒ»ãƒ­ãƒƒã‚¯æ®‹ç•™ã®æƒé™¤ï¼ˆå‰ç§‘ç›®DOMãŒæ®‹ã£ã¦ã„ã¦ã‚‚è§£é™¤ã™ã‚‹ï¼‰
    hideAllReadOnlyNotice();
   

    lastAutoAppliedCommonFilterSubjectId = null;

    if (!window.__isEditMode) {
  setUnsavedChanges(false);
}

    // â˜… Step D-â‘¡â‘¢
    window.currentUnitKey = null;
    hasSavedSnapshot = false; // â˜…ç§‘ç›®åˆ‡æ›¿ç›´å¾Œã¯ã„ã£ãŸã‚“æœªä¿å­˜æ‰±ã„ï¼ˆå¾©å…ƒã§trueã«ã™ã‚‹ï¼‰
  
    const subject = findSubjectById(subjectId);
    // ================================
// â˜… ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ï¼šedit-target modal çŠ¶æ…‹ã®ãƒªã‚»ãƒƒãƒˆ
// - ç§‘ç›®ãŒå¤‰ã‚ã£ãŸæ™‚ã ã‘ãƒªã‚»ãƒƒãƒˆã™ã‚‹ï¼ˆåŒä¸€ç§‘ç›®ã®å†æç”»ã§ã¯ä¿æŒã™ã‚‹ï¼‰
// ================================
// ================================
// â˜… edit-target çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆåˆ¶å¾¡ï¼ˆæœ€çµ‚ç‰ˆï¼‰
// ================================
const isSubjectActuallyChanging = subjectId !== currentSubjectId;
const isElectiveSubject = !!subject?.isElective; // â† æ—¢å­˜ãƒ•ãƒ©ã‚°ã‚’ä½¿ç”¨

if (window.__isEditMode === true) {
  // ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰
  if (isSubjectActuallyChanging) {
    window.__editTargetModalOpened = false;
    window.__editTargetStudentIds = null;
  }
} else {
  // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰
  window.__editTargetModalOpened = false;
  window.__editTargetStudentIds = null;
}

// â˜… é¸æŠç§‘ç›®ã¯å¸¸ã«ãƒªã‚»ãƒƒãƒˆï¼ˆä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚ä¾‹å¤–ãªã—ï¼‰
if (isElectiveSubject === true) {
  window.__editTargetModalOpened = false;
  window.__editTargetStudentIds = null;
}
          // â˜… ã‚¬ãƒ¼ãƒ‰ï¼šsubject ãŒ null ã®ã¾ã¾è§¦ã‚‰ãªã„
      if (!subject) {
        console.error("[handleSubjectChange] subject not found:", subjectId);
        setInfoMessage("ç§‘ç›®æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ç§‘ç›®ã‚’é¸ã³ç›´ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      // â˜… ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚ meta ã‚’å¿…ãšç¢ºå®š
      currentSubjectMeta = subject;


    try { window.currentSubject = subject; } catch (e) { /* noop */ }

    if (!subjectId) {
      cleanupScoresSnapshotListener();
      infoMessageEl?.classList.remove("warning-message");
      scoreVersionBaseMap.clear();
      setInfoMessage("ç§‘ç›®ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
      headerRow.innerHTML = "";
      tbody.innerHTML = `
        <tr>
          <td class="no-data" colspan="6">ç§‘ç›®ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</td>
        </tr>
      `;
        currentSubjectId = null;
      currentSubjectMeta = {
        subjectId: null,
        isCommon: false,
        isSkillLevel: false,
        usesAdjustPoint: false,
        passRule: null,
        required: false,
        specialType: 0,
      };

      // â˜… é‡è¦ï¼šwindow å´ã‚‚å¿…ãšæœ€æ–°å‚ç…§ã«æ›´æ–°
      window.currentSubjectMeta = currentSubjectMeta;
      window.isSubjectChanging = false;
      // â˜… ä»»æ„â‘ ï¼šdataset ã«ã‚‚åæ˜ ï¼ˆmode å´ã®æœ€å„ªå…ˆå‚ç…§ï¼‰
  try {
    document.body.dataset.subjectType = "unknown";
  } catch (e) {}
      window.__currentSubjectMeta = currentSubjectMeta;

      return;

    }

    // â˜… ç¿’ç†Ÿåº¦ç§‘ç›®ï¼šåŒä¸€ç§‘ç›®ã§ã‚‚åˆå›ã¯å¿…ãšå…¨å“¡ãƒ­ãƒƒã‚¯ã‚’é©ç”¨
  if (
    subjectId === currentSubjectId &&
    window.currentSubjectMeta?.isSkillLevel &&
    window.currentSkillFilter == null
  ) {
    applySkillLevelFilter(window.currentSubject, "all");
  }

    // â–¼ åŒä¸€ç§‘ç›®ã®å†èª­è¾¼é˜²æ­¢ï¼ˆReadså‰Šæ¸›ã®æ ¸å¿ƒï¼‰
 if (
   subjectId === currentSubjectId &&
   !(window.__isEditMode && window.__editTargetStudentIds)
 ) {
   return;
 }
 
    currentSubjectId = subjectId;
    setupScoresSnapshotListener(subjectId);
    const grade = String(subject?.grade ?? "");
    console.log("[GRADE CACHE] grade=", grade,
      "hasCache=", studentState.gradeStudentsCache?.has?.(grade),
      "cacheSize=", studentState.gradeStudentsCache?.size);

    let subjectMaster;
    if (subjectCache.has(subjectId)) {
      subjectMaster = subjectCache.get(subjectId);
    } else {
      subjectMaster = await loadSubjectMaster(subjectId);
      subjectCache.set(subjectId, subjectMaster);
    }

    let isSkillLevel;
    if (skillCache.has(subjectId)) {
      isSkillLevel = skillCache.get(subjectId);
    } else {
      isSkillLevel = await fetchIsSkillLevelFromSubjects(subjectId);
      skillCache.set(subjectId, isSkillLevel);
    }

    const passRule = subjectMaster?.passRule ?? subject?.passRule ?? null;
    const required = subjectMaster?.required ?? subject?.required ?? false;
    const usesAdjustPoint = passRule === "adjustment" || required === true;
    const specialType = Number(subjectMaster?.specialType ?? subject?.specialType ?? 0);

  // â˜… å…±é€šåˆ¤å®šã¯ã€Œã“ã“ã§1å›ã ã‘ã€
  const isCommon =
    subjectMaster?.required === true &&
    String(subjectId).includes("_G_");

  // â˜…ã€ã“ã“ãŒä¸è¶³ã—ã¦ã„ãŸã€‘ç§‘ç›®ãƒ¡ã‚¿ã‚’ã“ã“ã§ç¢ºå®šã•ã›ã‚‹
  currentSubjectMeta = {
    subjectId,
    isCommon,
    isSkillLevel,
    usesAdjustPoint,
    passRule,
    required,
    specialType,
  };
// ================================
// â˜… ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ï¼šunitKey ã¯ URL ç”±æ¥ã‚’ã€Œçµ¶å¯¾ã«ç¶­æŒã€ã™ã‚‹
//  - Firestore submittedSnapshot ã¯ units[unitKey] ã«å…¥ã£ã¦ã„ã‚‹ãŸã‚
//  - "__SINGLE__" ã¸ä¸Šæ›¸ãã™ã‚‹ã¨èª­ã¿å–ã‚Šä¸èƒ½ã«ãªã‚‹
// ================================
if (window.__isEditMode === true) {
  window.__submissionContext = window.__submissionContext || {};

  // âœ… URL ç”±æ¥ï¼ˆåˆæœŸåŒ–æ™‚ã«ã‚»ãƒƒãƒˆæ¸ˆã¿ï¼‰ã® unitKey ã‚’å°Šé‡
  const fixed = window.__submissionContext.unitKey;

  // unitKey ãŒç„¡ã„ã®ã¯ç•°å¸¸ï¼ˆä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ã®å‰æé•åï¼‰
  if (!fixed) {
    console.error("[FATAL] edit mode but submissionContext.unitKey is null", window.__submissionContext);
    throw new Error("edit mode requires fixed unitKey");
  }

  // è¡¨ç¤ºã¯å¸¸ã« all ã‹ã‚‰ï¼ˆUIéƒ½åˆï¼‰
  window.__currentFilterKey = "all";
  window.currentUnitKey = fixed;

  // requiredUnits ã¯ã€Œå›ºå®š unit ã®ã¿ã€ã‚’æƒ³å®šï¼ˆcompletion åˆ¤å®šã®æ•´åˆã‚‚å–ã‚Šã‚„ã™ã„ï¼‰
  window.__submissionContext.requiredUnits = [String(fixed)];
}


  // â˜… mode / èµ¤ç‚¹ / è²¼ã‚Šä»˜ã‘ã®æ­£æœ¬ã‚’ã“ã“ã§åŒæœŸ
  window.currentSubjectMeta = currentSubjectMeta;
  window.__currentSubjectMeta = currentSubjectMeta;

  // â˜… ä»»æ„â‘ ï¼šdataset ã«ã‚‚åæ˜ ï¼ˆæœ€å„ªå…ˆå‚ç…§ï¼‰
  try {
    document.body.dataset.subjectType = getSubjectType(currentSubjectMeta);
  } catch (e) {}


  // renderStudentRows å´ãŒå‚ç…§ã§ãã‚‹ã‚ˆã†ã« subject ã«ã‚‚è¼‰ã›ã‚‹
   


    if (subject?.required === false) {
      await ensureElectiveRegistrationLoaded(subject);
    }

    if (currentSubjectMeta.isSkillLevel) {
      await ensureSkillLevelsLoaded(subject);
    }
    if (currentSubjectMeta.isSkillLevel) {
      // skill level mode enabled (debug logs removed)
    } else {
      // skill level mode disabled (debug logs removed)
      window.currentSkillFilter = null; // â˜…é€šå¸¸ç§‘ç›®ã§ã¯ç¿’ç†Ÿåº¦ãƒ•ã‚£ãƒ«ã‚¿ã‚’å¿…ãšãƒªã‚»ãƒƒãƒˆ
    }
    // NOTE: call moved below to ensure students (sourceStudents) are determined first
    if (!subject) {
      infoMessageEl?.classList.remove("warning-message");
      scoreVersionBaseMap.clear();
      setInfoMessage("é¸æŠã•ã‚ŒãŸç§‘ç›®æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
      headerRow.innerHTML = "";
      tbody.innerHTML = `
        <tr>
          <td class="no-data" colspan="6">ç§‘ç›®æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</td>
        </tr>
      `;
      currentSubjectId = null;
      cleanupScoresSnapshotListener();
      return;
    }

    currentSubjectId = subjectId;
    tempScoresMap.clear(); // ç§‘ç›®åˆ‡æ›¿æ™‚ã®ã¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ãƒªã‚»ãƒƒãƒˆ
    studentState.finalScores.clear();

    infoMessageEl?.classList.remove("warning-message");
    setInfoMessage("è©•ä¾¡åŸºæº–ã¨åç°¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™â€¦");
    // ===== ç§‘ç›®åˆ‡æ›¿ï¼šUIå®Œå…¨åˆæœŸåŒ–ï¼ˆDOMã®ã¿ / Firestore reads 0ï¼‰=====
  // ===== ç§‘ç›®åˆ‡æ›¿æ™‚ï¼šUIã‚’å¿…ãšå®Œå…¨åˆæœŸåŒ–ï¼ˆDOMã®ã¿ï¼‰=====
  headerRow.innerHTML = "";
  tbody.innerHTML = "";

  const filterArea = document.getElementById("groupFilterArea");
  if (filterArea) filterArea.innerHTML = "";

 // ===== subjectMeta ã‚’å¿…ãšç¢ºå®šã•ã›ã‚‹ï¼ˆEDIT/é€šå¸¸ å…±é€šã‚¬ãƒ¼ãƒ‰ï¼‰=====
if (!currentSubjectMeta) {
  currentSubjectMeta = subject; // â† Firestore ã‹ã‚‰å–å¾—ã—ãŸ subject
}

// ===== specialType åˆ¤å®š =====
const isSpecial =
  currentSubjectMeta && currentSubjectMeta.specialType === 1 ||
  currentSubjectMeta && currentSubjectMeta.specialType === 2;


  if (isSpecial) {
    console.log(
      "[INFO] specialType subject -> skip criteria flow:",
      currentSubjectMeta && currentSubjectMeta.specialType
    );

    // è©•ä¾¡åŸºæº–ã¯ä½¿ã‚ãªã„
    criteriaState.items = [];

    // â˜…ã“ã“ãŒä¸€ç•ªé‡è¦ï¼ˆã“ã‚ŒãŒç„¡ã‹ã£ãŸï¼‰
    renderSpecialTableHeader(headerRow, currentSubjectMeta);

    
    // â˜… è¿½åŠ â‘ ï¼šè©•ä¾¡åŸºæº–UIã‚’å®Œå…¨ã«éš ã™
    document
      .querySelectorAll(".evaluation-related")
      .forEach(el => el.style.display = "none");
    updateAdjustPointDisplay();

  } else {
    // â˜… å°†æ¥äº‹æ•…é˜²æ­¢ï¼šé€šå¸¸ç§‘ç›®ã§ã¯è©•ä¾¡åŸºæº–UIã‚’å¿…ãšå¾©å¸°
  document
    .querySelectorAll(".evaluation-related")
    .forEach(el => el.style.display = "");

    // ===== é€šå¸¸ç§‘ç›® =====
    if (criteriaCache.has(subjectId)) {
      Object.assign(criteriaState, structuredClone(criteriaCache.get(subjectId)));
    } else {
      await loadCriteria(db, currentYear, subjectId, criteriaState);
      criteriaCache.set(subjectId, structuredClone(criteriaState));
    }
  // â˜… é€šå¸¸ç§‘ç›®ã®è©•ä¾¡åŸºæº–ãƒ˜ãƒƒãƒ€ãƒ¼æç”»ï¼ˆã“ã‚ŒãŒç„¡ã„ã¨ãƒ˜ãƒƒãƒ€ãƒ¼ãŒå‡ºãªã„ï¼‰
    renderTableHeader(headerRow, criteriaState, subject);
    updateAdjustPointDisplay();
    

    if (currentSubjectMeta.isSkillLevel) {
      const th = document.createElement("th");
      th.textContent = "ç¿’ç†Ÿåº¦";
      headerRow.insertBefore(th, headerRow.firstChild);
    }

  
  }


  
    // å­¦å¹´åç°¿ã¯ã€Œå­¦å¹´ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€ã‹ã‚‰ã®ã¿ä¾›çµ¦ã™ã‚‹ï¼ˆsubjectRosterã¯æ··ãœãªã„ï¼‰
    const targetGrade = String(subject?.grade ?? "");

    // === â‘  å­¦å¹´åç°¿ï¼ˆæ­£æœ¬ï¼‰ã‚’ç¢ºä¿ï¼šgradeStudentsCache â†’ ãªã‘ã‚Œã° Firestoreï¼ˆå­¦å¹´ã‚¯ã‚¨ãƒªï¼‰ ===
    try {
      const cachedGradeStudents = studentState.gradeStudentsCache?.get(targetGrade);

      if (Array.isArray(cachedGradeStudents) && cachedGradeStudents.length > 0) {
        // cache-hit debug log removed

        // å‚ç…§æ±šæŸ“é˜²æ­¢ï¼šå¿…ãšã‚³ãƒ”ãƒ¼ã§æŒã¤
        studentState.allStudents = cachedGradeStudents.slice();
        
      } else {
        console.log("[GRADE CACHE] FETCH students for grade=", targetGrade);

        // â˜… å­¦å¹´åç°¿ã¯ã€Œå­¦å¹´ã§å–å¾—ã€ã™ã‚‹ï¼ˆsubjectRosterã§ä»£ç”¨ã—ãªã„ï¼‰
        // loadStudentsForGrade ã¯ studentState.allStudents ã«æ­£è¦åŒ–æ¸ˆã¿é…åˆ—ã‚’å…¥ã‚Œã¦ãã‚Œã‚‹
await loadStudentsForGrade(db, targetGrade, studentState);

console.log(
  "[CHECK allStudents]",
  "grade=", studentState.allStudentsGrade,
  "len=", studentState.allStudents.length,
  "grades=", [...new Set(studentState.allStudents.map(s => s.grade))]
);

// ================================
// Step3.5ï¼ˆæœ€çµ‚ï¼‰ï¼šä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ã®å­¦ç”Ÿãƒ•ã‚£ãƒ«ã‚¿
// ãƒ»å…±é€šç§‘ç›®ã®ã¿ unitKey ã§çµã‚‹
// ãƒ»é¸æŠç§‘ç›®ï¼ˆrequired=falseï¼‰ã¯ unitKey ã‚’çµ¶å¯¾ã«ä½¿ã‚ãªã„
// ================================
if (window.__isEditMode === true) {
  const editUnitKey = submissionContext?.unitKey;

  if (currentSubjectMeta?.isCommon === true && editUnitKey) {
    if (Number(currentSubjectMeta.grade) <= 2) {
      studentState.allStudents = studentState.allStudents.filter(
        (s) => String(s.class) === String(editUnitKey)
      );
    } else {
      studentState.allStudents = studentState.allStudents.filter(
        (s) => String(s.course) === String(editUnitKey)
      );
    }
  }

  // â˜… é¸æŠç§‘ç›®(required=false)ã¯ã“ã“ã§ã¯ä¸€åˆ‡ãƒ•ã‚£ãƒ«ã‚¿ã—ãªã„
}


try {
  studentState.gradeStudentsCache.set(
    targetGrade,
    studentState.allStudents.slice()
  );
} catch (e) { /* noop */ }

            }
    } catch (e) {
      throw e;
    }

    // === â‘¡ subjectRoster ã¯ã€ŒenrolledStudentIdsã€ç”¨ã«ã ã‘èª­ã‚€ï¼ˆå­¦å¹´ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã¯ä¿å­˜ã—ãªã„ï¼‰ ===
    let rosterIds = null;
    try {
      rosterIds = await loadSubjectRoster(db, currentYear, subjectId);
    } catch (e) {
      // subjectRoster å–å¾—ã‚¨ãƒ©ãƒ¼ã¯ã“ã“ã§ã¯æ¡ã‚Šã¤ã¶ã•ãšä¸Šã«æŠ•ã’ã‚‹é‹ç”¨ã«åˆã‚ã›ã‚‹
      throw e;
    }

 if (!Array.isArray(rosterIds) || rosterIds.length === 0) {
  const isSpecialType = Number(currentSubjectMeta?.specialType ?? 0) > 0;

 // â˜… ç‰¹åˆ¥ç§‘ç›®ï¼šã¾ãš submittedSnapshot ã‚’æ­£æœ¬ã¨ã—ã¦ä½¿ã†
  if (isSpecialType) {
    const doc = window.__latestScoresDocData;
    const unitKeyForSnap =
      window.__submissionContext?.unitKey ?? window.currentUnitKey;

    const submittedStudents = getSubmittedStudents(
      doc,
      currentSubjectMeta,
      unitKeyForSnap
    );

    if (submittedStudents && Object.keys(submittedStudents).length > 0) {
      rosterIds = Object.keys(submittedStudents).map(String);
      console.log(
        "[SPECIAL] rosterIds from submittedSnapshot:",
        rosterIds
      );
    } else {
      // submittedSnapshot ã™ã‚‰ç„¡ã„å ´åˆã®ã¿å­¦å¹´åç°¿ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      rosterIds = (studentState.allStudents || []).map(s =>
        String(s.studentId)
      );
      console.warn(
        "[SPECIAL] fallback to allStudents (no snapshot)"
      );
    }
  } else {
    alert("åç°¿ãƒ‡ãƒ¼ã‚¿ãŒæœªç”Ÿæˆã§ã™ã€‚æ•™å‹™ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚");
    throw new Error("subjectRoster missing");
  }
}


    enrolledStudentIds = Array.from(
      new Set(
        rosterIds
          .map((id) => String(id ?? "").trim())
          .filter((id) => id.length > 0)
      )
    );

    // ç§‘ç›®ã«å¿œã˜ã¦å­¦ç”Ÿãƒ•ã‚£ãƒ«ã‚¿ï¼†ã‚½ãƒ¼ãƒˆ
    const students = filterAndSortStudentsForSubject(subject, studentState);

    
// â–¼ è¡¨ç¤ºå¯¾è±¡å­¦ç”Ÿã®æ±ºå®š
let displayStudents = students;

// â˜… é¸æŠç§‘ç›®ã¯ã€å¸¸ã«ã€‘ç™»éŒ²åç°¿ã‚’æ­£æœ¬ã«ã™ã‚‹ï¼ˆä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚ä¾‹å¤–ãªã—ï¼‰
if (subject.required === false) {
  const list = studentState.electiveStudents || [];
  displayStudents = list.slice();
}


  // â˜… STEP C ãƒ•ã‚£ãƒ«ã‚¿ç”¨ï¼šç¾åœ¨ã®è¡¨ç¤ºå­¦ç”Ÿã‚’ä¿æŒ
  studentState.baseStudents = displayStudents.slice();
  studentState.currentStudents = displayStudents.slice();

  if (currentSubjectMeta.isSkillLevel) {
    renderSkillLevelFilter(subject);
    window.currentSkillFilter = "all"; // åˆæœŸçŠ¶æ…‹ã‚’å…¨å“¡ã«å›ºå®š
  }

    // é¸æŠç§‘ç›®ãƒ¢ãƒ¼ãƒ€ãƒ«ã¯ students ãŒç¢ºå®šã—ãŸå¾Œã«è¡¨ç¤ºï¼ˆReads0 æ–¹é‡ï¼‰
    if (subject && subject.required === false) {
      // ===== elective modal: grade boundary reset (Reads0) =====
      if (studentState.lastElectiveGrade !== grade) {
        console.log("[elective modal] grade changed -> reset modal state", {
          from: studentState.lastElectiveGrade,
          to: grade,
        });

        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºã«ä½¿ã†å€™è£œãƒ‡ãƒ¼ã‚¿ã‚„ä¸€æ™‚çŠ¶æ…‹ã‚’å¿…ãšç ´æ£„
        if (studentState.electiveCandidates) studentState.electiveCandidates = [];
        if (studentState.electiveSelected) studentState.electiveSelected = [];
        // ã‚‚ã— allStudents ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«å´ãŒå‚ç…§ã—ã¦ã„ã¦æ±šæŸ“ã—ã¦ã„ã‚‹ãªã‚‰ã€ã“ã“ã¯ãƒªã‚»ãƒƒãƒˆã—ãªã„ï¼ˆå…¨ç”»é¢ã§ä½¿ã†ãŸã‚ï¼‰
        // ä»£ã‚ã‚Šã«ã€Œãƒ¢ãƒ¼ãƒ€ãƒ«å†…éƒ¨ã§ä½¿ã†é…åˆ—ã€ã ã‘ã‚’æ¶ˆã™

        studentState.lastElectiveGrade = grade;
      }

      await openElectiveRegistrationModal(subject);
    }

    // debug render logs removed
    // ç¿’ç†Ÿåº¦ã‚½ãƒ¼ãƒˆï¼ˆisSkillLevel===trueæ™‚ã®ã¿ï¼‰
    if (currentSubjectMeta.isSkillLevel) {
      displayStudents = sortStudentsBySkillLevel(displayStudents, studentState.skillLevelsMap);
      // debug render logs removed
    }
    await loadScoreVersionBase(subjectId, displayStudents);
    // debug render logs removed



  // ================================
  // æå‡ºæ¸ˆãƒ¦ãƒ‹ãƒƒãƒˆåˆ¤å®šï¼ˆUIç”¨ï¼‰
  // ================================

  // â˜… snapshot listener ãŒä¿å­˜ã—ã¦ã„ã‚‹æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã†
  const subjectDocData = window.__latestScoresDocData || {};

const unitsMap =
  subjectDocData.submittedByUnit ||
  subjectDocData.submittedSnapshot?.units ||
  {};


  // æå‡ºæ¸ˆã¿ãƒ¦ãƒ‹ãƒƒãƒˆï¼ˆæå‡ºï¼ãƒ­ãƒƒã‚¯ï¼‰
  const lockedUnits = new Set(Object.keys(unitsMap));
  // â˜… STEP3-1 æ–¹é‡ï¼š
  // æˆç¸¾å…¥åŠ›ç”»é¢ã§ã¯å†æå‡ºã—ãªã„ãŸã‚ã€editableUnits ã¯å¸¸ã«ç©º
    const editableUnits = new Set();

  // UI ç”¨ã«ã¾ã¨ã‚ã¦ students.js ã«æ¸¡ã™
  studentState.lockedUnitInfo = {
    lockedUnits,      // ã™ã¹ã¦ã®æå‡ºæ¸ˆãƒ¦ãƒ‹ãƒƒãƒˆ
    editableUnits     // å¸¸ã«ç©ºï¼ˆãƒˆãƒƒãƒ—ç”»é¢ã‹ã‚‰ã®è§£é™¤ãƒ»å†æå‡ºãƒ•ã‚§ãƒ¼ã‚ºã§æ‹¡å¼µï¼‰
  };


    // å­¦ç”Ÿè¡Œæç”»ï¼ˆå…¥åŠ›æ™‚ã«ãã®è¡Œã®æœ€çµ‚æˆç¸¾ã‚’è¨ˆç®—ï¼‰
    isRenderingTable = true;
    const handleScoreInputChange = (tr) => {
      if (!tr) return;
      recalcFinalScoresAfterRestore(tbody);
      syncFinalScoreForRow(tr);
        const finalCell = tr.querySelector(".final-score");
        if (finalCell) {
          const flags = computeRiskFlags(finalCell.textContent, buildRiskContext());
          applyRiskClassesToCell(finalCell, flags);
        }
      applyRiskClassForRow(tr);
      if (avgUpdateRafId) cancelAnimationFrame(avgUpdateRafId);
      avgUpdateRafId = requestAnimationFrame(() => {
        updateAveragePointDisplay();
      });
    };
    try {

  // â˜… ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼šè¡¨ç¤ºå¯¾è±¡ students ã‚’æ±ºå®šï¼ˆâ†ã“ã“ï¼‰
  let renderStudents = displayStudents;

// __editTargetStudentIds ã¯ã€Œé…åˆ—ã€ã§ã‚‚ã€ŒSetã€ã§ã‚‚å—ã‘ã‚‹
const _sel = window.__editTargetStudentIds;
const selectedIdSet =
  _sel instanceof Set
    ? new Set([..._sel].map(v => String(v)))
    : Array.isArray(_sel)
      ? new Set(_sel.map(v => String(v)))
      : null;

// âœ… ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€ç§‘ç›®ç¨®åˆ¥ã«é–¢ä¿‚ãªãã€Œé¸æŠãŒã‚ã‚Œã°å¿…ãšçµã‚Šè¾¼ã‚€ã€
if (window.__isEditMode === true && selectedIdSet && selectedIdSet.size > 0) {
  renderStudents = displayStudents.filter(stu =>
    selectedIdSet.has(String(stu.studentId))
  );

  console.log(
    "[EDIT MODE] renderStudents filtered by edit-target:",
    [...selectedIdSet]
  );
}



      renderStudentRows(
        tbody,
        subject,
        renderStudents,
        criteriaState.items,
        handleScoreInputChange,
        studentState,
        window.__latestScoresDocData?.completion
      );
 
// ================================
// â˜… ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ï¼šæç”»ç›´å¾Œã«ä¿å­˜æ¸ˆã¿æˆç¸¾ã‚’åæ˜ ï¼ˆé¸æŠç§‘ç›®å¯¾å¿œãƒ»æœ€çµ‚ï¼‰
// ================================
if (window.__isEditMode === true) {
  const doc = window.__latestScoresDocData;
  const meta = window.__currentSubjectMeta;

  let submittedStudents = null;

if (meta?.required === false) {
  // â˜… é¸æŠç§‘ç›®ï¼š
  // submittedSnapshot.units ã¯ unit ãŒè¤‡æ•°ï¼ˆE/M ãªã©ï¼‰ã«ãªã‚‹ã®ã§ã€Œå…¨ unit ã‚’ãƒãƒ¼ã‚¸ã€ã™ã‚‹
  const units = doc?.submittedSnapshot?.units;

  if (units && Object.keys(units).length > 0) {
    submittedStudents = {};

    // units = { E: {students:{...}}, M:{students:{...}} } ã‚’å…¨éƒ¨çµåˆ
    Object.values(units).forEach((unit) => {
      const st = unit?.students;
      if (!st) return;

      // st ã¯ { studentId: {scores...}, ... } ã® Object æƒ³å®š
      Object.entries(st).forEach(([sid, data]) => {
        submittedStudents[String(sid)] = data;
      });
    });
  } else {
    // â‘¡ å¾Œæ–¹äº’æ›ï¼šæ—§ä»•æ§˜ studentsï¼ˆObjectï¼‰
    submittedStudents = doc?.students || {};
  }
} else {
  // å…±é€šãƒ»å˜ä¸€ç§‘ç›®ï¼ˆå¾“æ¥é€šã‚Šï¼‰
  const unitKey = window.__submissionContext?.unitKey;
  submittedStudents = getSubmittedStudents(doc, meta, unitKey);
}


  console.log(
    "[EDIT MODE] applySavedScoresToTable (final-fixed)",
    submittedStudents && Object.keys(submittedStudents)
  );



// ================================
// Step.2.5: ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ã§ã¯ submit ã‚’å¼·åˆ¶è¡¨ç¤ºï¼ˆâ˜…ã“ã“ï¼‰
// ================================
// ================================
// EDIT MODE: å°‚ç”¨é€ä¿¡ãƒœã‚¿ãƒ³è¡¨ç¤º
// ================================
if (window.__isEditMode === true) {
  const editBtn = document.getElementById("editSubmitBtn");
  const normalBtn = document.getElementById("submitScoresBtn");

  if (editBtn) {
    editBtn.style.display = "inline-block";
    console.log("[EDIT MODE] editSubmitBtn visible");
  }

  // é€šå¸¸ submit ã¯è¦‹ã›ãªã„ï¼ˆæ··ç·šé˜²æ­¢ï¼‰
  if (normalBtn) {
    normalBtn.style.display = "none";
  }
}
// ================================
// â‘¡-2 EDIT MODE: å°‚ç”¨ click handler
// ================================
(function setupEditSubmitHandler() {
  if (window.__isEditMode !== true) return;

  const editBtn = document.getElementById("editSubmitBtn");
  if (!editBtn) return;

  // å¿µã®ãŸã‚ handler å…¨æ¶ˆã—
  const cleanBtn = editBtn.cloneNode(true);
  editBtn.parentNode.replaceChild(cleanBtn, editBtn);

  cleanBtn.addEventListener("click", () => {
    const modal = document.getElementById("submitConfirmModal");
    if (!modal) {
      console.error("[EDIT MODE] submitConfirmModal not found");
      return;
    }

    modal.classList.remove("hidden");

    const okBtn = modal.querySelector(".ok-btn");
    if (!okBtn) {
      console.error("[EDIT MODE] ok-btn not found");
      return;
    }

    // OK ãƒœã‚¿ãƒ³ã‚‚ handler å·®ã—æ›¿ãˆ
    const okClean = okBtn.cloneNode(true);
    okBtn.parentNode.replaceChild(okClean, okBtn);

    okClean.addEventListener("click", async () => {
      modal.classList.add("hidden");
      console.log("[EDIT MODE] submitScoresInEditMode called");
      await submitScoresInEditMode();
    });
  });

  console.log("[EDIT MODE] editSubmitBtn handler ready");
})();



  if (submittedStudents && Object.keys(submittedStudents).length > 0) {
    applySavedScoresToTable(submittedStudents, tbody);
  }
}


 
      // â˜…â˜…â˜…â˜…â˜… ã“ã“ã«ç§»ã™ â˜…â˜…â˜…â˜…â˜…
if (window.__isEditMode && !window.__editTargetModalOpened) {
  console.log("[DEBUG] about to open edit target modal (displayStudents)");
  // ================================
// â˜… ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ï¼šå˜ä¸€ç§‘ç›® / ç‰¹åˆ¥ç§‘ç›®ã§ã¯
//   æå‡ºæ¸ˆã¿ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆç”±æ¥ã®å­¦ç”Ÿã®ã¿
//   edit-target modal ã«æ¸¡ã™
// ================================
let modalStudents = displayStudents;

if (window.__isEditMode === true) {
  const meta = window.__currentSubjectMeta;
  const isSpecialType = Number(meta?.specialType ?? 0) > 0;
  const isSingleLike =
    (!meta?.isCommon && !meta?.isSkillLevel) || isSpecialType;

  if (isSingleLike) {
    const unitKey = window.currentUnitKey;
    const doc = window.__latestScoresDocData;

    const snapshotStudents =
  doc?.submittedSnapshot?.students ||
  null;


    if (snapshotStudents && studentState.allStudents) {
      const ids = Object.keys(snapshotStudents);
      modalStudents = studentState.allStudents.filter(stu =>
        ids.includes(String(stu.studentId))
      );

      console.warn(
        "[EDIT MODE] modal students derived from snapshot",
        modalStudents.map(s => s.studentId)
      );
    }
  }
}

window.__pendingEditTargetModal = modalStudents;
}
      renderRightActionAreaEditMode();
      

  // ================================
  // â˜… ä¿®æ­£â‘¢ï¼šãƒ•ã‚£ãƒ«ã‚¿çŠ¶æ…‹ã®æ­£æœ¬ã‚’åˆæœŸåŒ–
  // ç§‘ç›®åˆ‡æ›¿æ™‚ã¯å¿…ãšã€Œå…¨å“¡è¡¨ç¤ºã€ã‹ã‚‰é–‹å§‹ã™ã‚‹
  // ================================
  window.__currentFilterKey =
    (currentSubjectMeta.isCommon || currentSubjectMeta.isSkillLevel)
      ? "all"
      : null;

  // â˜… åˆå›æç”»ç›´å¾Œã«çŠ¶æ…‹ã‚’ç¢ºå®šã•ã›ã‚‹ï¼ˆè¶…é‡è¦ï¼‰
      requestAnimationFrame(() => {
        recalcFinalScoresAfterRestore(tbody);
        syncFinalScoresFromTbody(tbody);
        applyRiskClassesToAllRows();
        updateAveragePointDisplay();
          });

  // ================================
  // STEP1: æå‡ºå˜ä½ãƒ»å®Œäº†æ¡ä»¶ã®ç¢ºå®š
  // ï¼ˆåç°¿æç”»ãŒå®Œäº†ã—ãŸç›´å¾Œï¼‰
  // ================================
 if (window.__isEditMode === true && !window.__submissionContext.unitKey) {
  console.error(
    "[FATAL] edit mode but submissionContext.unitKey is null",
    window.__submissionContext
  );
  throw new Error("edit mode requires fixed unitKey");
}

  const resolvedUnitKey =
     window.__isEditMode === true
    ? window.__submissionContext.unitKey
    : resolveCurrentUnitKey({
         grade,
         subjectMeta: currentSubjectMeta,
         visibleStudents: displayStudents
       });
  window.currentUnitKey = resolvedUnitKey;

  // â˜… Step D-â‘¡â‘¡ï¼šé€šå¸¸ï¼å…±é€šç§‘ç›® unit ã® UI çŠ¶æ…‹ã‚’åˆæœŸåŒ–
  ensureUIStateForUnit(resolvedUnitKey);

window.__submissionContext.requiredUnits =
  resolveRequiredUnits({
    grade,
    subjectMeta: currentSubjectMeta
  });

// unitKey ã¯ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ã§ã¯çµ¶å¯¾ã«è§¦ã‚‰ãªã„
if (!window.__isEditMode) {
  window.__submissionContext.unitKey = resolvedUnitKey;
}

  // =====================================================
  // â˜… ä¿®æ­£â‘¢ï¼ˆå¿µæŠ¼ã—ï¼‰ï¼šé¸æŠç§‘ç›®ã¯å¸¸ã«å˜ä¸€ãƒ¦ãƒ‹ãƒƒãƒˆ
  // =====================================================
  if (subject?.required === false) {
    window.currentUnitKey = "__SINGLE__";
    window.__currentFilterKey = "all";
    window.__submissionContext = {
      requiredUnits: ["__SINGLE__"],
      unitKey: "__SINGLE__",
    };
  }

  // ================================
  // â˜… ç—‡çŠ¶â‘ å¯¾ç­–ï¼šunit åˆ‡æ›¿æ™‚ã«é€ä¿¡å¯å¦ã®æ­£æœ¬ã‚’ãƒªã‚»ãƒƒãƒˆ
  // ================================
  hasSavedSnapshot = false;
  hasUnsavedChanges = false;
  isSavedAfterLastEdit = false;

  // Unit-state ã‚‚åˆæœŸåŒ–ï¼ˆç¾åœ¨ã® unit ã«å¯¾ã—ã¦ï¼‰
  try {
    const st = getCurrentUnitState();
    if (st) {
      st.hasUnsavedChanges = false;
      st.isSavedAfterLastEdit = false;
    }
  } catch (e) {}



  // ================================
  // â˜… ä¿®æ­£â‘¢ï¼šunitKey åˆ‡æ›¿æ™‚ã® UI çŠ¶æ…‹å†è©•ä¾¡
  // ================================
  const unitKey = window.__submissionContext?.unitKey;
  if (unitKey) {
    ensureUIStateForUnit(unitKey);

    const ui = window.uiStateByUnit[unitKey];
    // ğŸ”’ æå‡ºæ¸ˆã¿ unit ã¯å¸¸ã«å…¥åŠ›ãªã—æ‰±ã„
    const submitted = isUnitSubmittedByUI(window.__latestScoresDocData, unitKey);
 if (submitted && !window.__isEditMode) {
  ui.hasInput = false;
  ui.hasSaved = false;
} else {
      // ğŸ†• æœªæå‡º unit ã¯ã€Œæœªå…¥åŠ›ã€ã‹ã‚‰å¿…ãšå§‹ã‚ã‚‹
      ui.hasInput = false;
      ui.hasSaved = false;
    }
  }



  console.log("[STEP1] submissionContext", window.__submissionContext);

    } finally {
      isRenderingTable = false;
    }
    restoreStashedScores(tbody);
    // --- â˜… STEP D: ä¿å­˜æ¸ˆã¿ scores ã¯å–å¾—ã™ã‚‹ãŒã€ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ã§ã¯ draft/é€”ä¸­å†é–‹ã‚’é©ç”¨ã—ãªã„ ---
    try {
      let savedData = null;
      if (scoresCache.has(subjectId)) {
        savedData = scoresCache.get(subjectId);
      } else {
        // still perform Firestore read to satisfy loader responsibilities
        savedData = await loadSavedScoresForSubject(currentYear, subjectId);
        scoresCache.set(subjectId, savedData);
      }

      // In edit-only mode we DO NOT apply saved/draft scores to the input table.
      // Keep temp structures empty and mark that no draft was applied.
      didApplySavedScores = false;
      tempScoresMap.clear();
      excessStudentsState = {};
      excessDirty = false;
      hasSavedSnapshot = false;
      setUnsavedChanges(false);
    } catch (e) {
      console.warn("[WARN] failed to fetch saved scores (ignored in edit mode)", e);
    }


  if (!unsavedListenerInitialized && tbody) {
    // ==========================================
    // â˜… æ•°å€¤æ¬„ã«ã€Œeã€ã€Œ-ã€ã€Œ+ã€ãªã©ãŒå…¥ã‚‹ã®ã‚’äº‹å‰ã«ãƒ–ãƒ­ãƒƒã‚¯
    //   type="number" ã¯ value ã¨è¡¨ç¤ºãŒã‚ºãƒ¬ã‚‹ã“ã¨ãŒã‚ã‚‹ãŸã‚
    //   beforeinput ã§ã€Œå…¥ã‚‹å‰ã€ã«æ­¢ã‚ã‚‹ã®ãŒç¢ºå®Ÿ
    // ==========================================
    tbody.addEventListener("beforeinput", (ev) => {
      const t = ev.target;
      if (!(t instanceof HTMLInputElement)) return;
      
      if (!t.dataset.index) return; // ç‚¹æ•°æ¬„ã ã‘å¯¾è±¡

      // IMEç³»ã‚„å‰Šé™¤ç³»ã¯é€šã™
      const it = ev.inputType || "";
      if (it.startsWith("delete") || it === "historyUndo" || it === "historyRedo") return;

      const data = ev.data ?? "";
      // 1æ–‡å­—å…¥åŠ›ï¼ˆinsertTextï¼‰ã§ã€æ•°å­—ã¨ . ä»¥å¤–ã¯æ‹’å¦
      if (it === "insertText") {
        if (!/^[0-9.]$/.test(data)) {
          ev.preventDefault();
          return;
        }
        // å°æ•°ç‚¹ã¯1ã¤ã ã‘
        if (data === "." && (t.value || "").includes(".")) {
          ev.preventDefault();
          return;
        }
      }
    }, true);

    tbody.addEventListener("keydown", (ev) => {
      const t = ev.target;
      if (!(t instanceof HTMLInputElement)) return;
      if (t.type !== "number") return;
      if (!t.dataset.index) return;

      // æ“ä½œã‚­ãƒ¼ã¯è¨±å¯
      if (
        ev.key === "Backspace" || ev.key === "Delete" ||
        ev.key === "Tab" || ev.key === "Enter" ||
        ev.key === "ArrowLeft" || ev.key === "ArrowRight" ||
        ev.key === "Home" || ev.key === "End"
      ) return;

      // ç¦æ­¢ã‚­ãƒ¼
      if (ev.key === "e" || ev.key === "E" || ev.key === "+" || ev.key === "-") {
        ev.preventDefault();
        return;
      }
    }, true);



  // ================================
  // â˜… STEP3-â‘¢ï¼šç¢ºå®šæ™‚ï¼ˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚¢ã‚¦ãƒˆï¼‰ã®æœ€çµ‚ã‚¬ãƒ¼ãƒ‰
  // ================================
  tbody.addEventListener(
    "focusout",
    (ev) => {
      const t = ev.target;
      if (!(t instanceof HTMLInputElement)) return;
      if (t.classList.contains("skill-level-input")) return;
      if (!t.dataset.index) return; // ç‚¹æ•°ã‚»ãƒ«ã ã‘å¯¾è±¡

      const raw = t.value;
      if (raw === "") return;

      const v = Number(raw);
      if (!Number.isFinite(v)) {
        t.value = "";
        return;
      }

      const idx = Number(t.dataset.index);
      const max = criteriaState.maxByIndex?.[idx];

      // â˜… max è¶…éã¯ã€Œç¢ºå®šæ™‚ã€ã«å¼·åˆ¶ä¿®æ­£
      if (Number.isFinite(max) && v > max) {
        t.value = String(max);
        t.classList.add("ktc-input-error");
        showScoreInputErrorToast(`ã“ã®é …ç›®ã®ä¸Šé™ã¯ ${max} ç‚¹ã§ã™`);

        // å³æ™‚å†è¨ˆç®—ã‚’ä¿è¨¼
        t.dispatchEvent(new Event("input", { bubbles: true }));
      }
    },
    true // â† capture ã§ç¢ºå®Ÿã«æ‹¾ã†
  );

  tbody.addEventListener("input", (ev) => {
    const ui = window.getCurrentUIState?.();
      if (isCurrentUnitSubmitted() && !window.__isEditMode) return;
      if (isRenderingTable) return;
      if (isProgrammaticInput) return;

      const target = ev.target;

      // ================================
      // â˜… æ•°å€¤å…¥åŠ›ã®æ­£è¦åŒ–ï¼ˆe / - / -- é˜²æ­¢ï¼‰
      // ================================
      if (
        target instanceof HTMLInputElement &&
      
        target.dataset.index
      ) {
        let v = target.value ?? "";

        // æ•°å­—ã¨å°æ•°ç‚¹ä»¥å¤–ã‚’é™¤å»
        v = v.replace(/[^0-9.]/g, "");

        // å°æ•°ç‚¹ã¯1ã¤ã¾ã§
        const parts = v.split(".");
        if (parts.length > 2) {
          v = parts[0] + "." + parts.slice(1).join("");
        }

        if (target.value !== v) {
          target.value = v;
        }
      }

      if (
        criteriaState.ready &&
        target instanceof HTMLInputElement &&
        
        target.dataset.index &&
        !target.classList.contains("skill-level-input")
      ) {
        const idx = Number(target.dataset.index);
        const max = criteriaState.maxByIndex?.[idx];

        const v = Number(target.value);
        if (Number.isFinite(max) && Number.isFinite(v) && v > max) {
          target.value = "";
          showScoreInputErrorToast(`ã“ã®é …ç›®ã®ä¸Šé™ã¯ ${max} ç‚¹ã§ã™`);
          return;
        }
      }

      if (
        target instanceof HTMLInputElement &&
        target.classList.contains("skill-level-input")
      ) {
        return;
      }

      const isNumberScoreInput =
        target instanceof HTMLInputElement &&
        
        !!target.dataset.index;

      const isSpecialSelect =
        target instanceof HTMLSelectElement &&
        (target.classList.contains("pass-fail-select") ||
        target.classList.contains("cert-select"));

      if (!isNumberScoreInput && !isSpecialSelect) return;
    
      if (ui && !isCurrentUnitSubmitted()) {
        ui.hasInput = true;
      }

      // â˜… Step D-â‘¢â‘¢ï¼šæå‡ºæ¸ˆã¿ãªã‚‰ç·¨é›†ç¦æ­¢

      setUnsavedChanges(true);
      isSavedAfterLastEdit = false;

  recalcFinalScoresAfterRestore(tbody);
    // â˜…â˜…â˜… ã“ã“ã«è¿½åŠ  â˜…â˜…â˜…
    const tr = target.closest("tr");
    if (tr) {
      handleScoreInputChange(tr);
    }

    });
  // â˜… å…¥åŠ›ã—ãŸè¡Œã ã‘å³æ™‚å†è¨ˆç®—ï¼ˆã‚½ãƒ¼ãƒˆã—ãªãã¦ã‚‚åæ˜ ã•ã‚Œã‚‹ï¼‰

    unsavedListenerInitialized = true;
  }

    // --- æ–°è¦è¿½åŠ : ç¿’ç†Ÿåº¦å€¤ã®åæ˜  ---
    if (currentSubjectMeta.isSkillLevel && studentState.skillLevelsMap) {
      const inputs = tbody.querySelectorAll('input.skill-level-input');
      inputs.forEach(input => {
        const sid = input.dataset.studentId;
        input.value = studentState.skillLevelsMap[sid] || "";
      });
    }
    updateStudentCountDisplay(displayStudents.length);
    updateAveragePointDisplay();

    // â–¼ è²¼ã‚Šä»˜ã‘å‡¦ç†ã®æ¥ç¶šï¼ˆåˆå›ã ã‘ï¼‰
    if (!pasteInitialized) {
      tbody.addEventListener("paste", (ev) => {
        ev.preventDefault();
        const text = ev.clipboardData?.getData("text/plain") ?? "";
        if (!text) return;

        // skill-level-inputã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ä¸­ãªã‚‰ç¸¦è²¼ã‚Š
        const active = document.activeElement;
        if (active && active.classList && active.classList.contains("skill-level-input")) {
          const lines = text.split(/\r?\n/);
          const allow = ["", "S", "A1", "A2", "A3"];
          // tbodyå†…ã®ã™ã¹ã¦ã®skill-level-inputã‚’é…åˆ—ã§å–å¾—
          const inputs = Array.from(tbody.querySelectorAll(".skill-level-input"));
          // ç¾åœ¨ã®inputã®indexã‚’ç‰¹å®š
          const startIdx = inputs.indexOf(active);
          let i = 0;
          for (; i < lines.length && (startIdx + i) < inputs.length; i++) {
            let v = lines[i].toUpperCase();
            if (!allow.includes(v)) v = "";
            inputs[startIdx + i].value = v;
            // inputã‚¤ãƒ™ãƒ³ãƒˆã‚‚ç™ºç«ã•ã›ã‚‹ï¼ˆä»–ãƒ­ã‚¸ãƒƒã‚¯é€£å‹•ç”¨ï¼‰
            const event = new Event("input", { bubbles: true });
            inputs[startIdx + i].dispatchEvent(event);
          }
          return;
        }

        // ãã‚Œä»¥å¤–ã¯æ—¢å­˜ã®ç‚¹æ•°è²¼ã‚Šä»˜ã‘ãƒ­ã‚¸ãƒƒã‚¯
        if (
          applyPastedScores(
            text,
            tbody,
            criteriaState,
            
            (msg) => window.alert(msg)
          )
        ) {
          setUnsavedChanges(true);
          enforceMaxForAllScoreInputs(tbody);
          // â˜… è²¼ã‚Šä»˜ã‘ç›´å¾Œã«å¿…ãšå†è©•ä¾¡
          recalcFinalScoresAfterRestore(tbody);
          applyRiskClassesToAllRows();
        }
      });
      pasteInitialized = true;
    }

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼ˆspecialType ã¯è©•ä¾¡åŸºæº–ã‚’ä½¿ã‚ãªã„ï¼‰
  if (currentSubjectMeta?.specialType === 1) {
    infoMessageEl?.classList.remove("warning-message");
    setInfoMessage("ç‰¹åˆ¥ç§‘ç›®ï¼šåˆï¼å¦ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
  } else if (currentSubjectMeta?.specialType === 2) {
    infoMessageEl?.classList.remove("warning-message");
    setInfoMessage("ç‰¹åˆ¥ç§‘ç›®ï¼šèªå®š(1)ï¼èªå®š(2)ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
  } 
  // â˜… ç‰¹åˆ¥ç§‘ç›®ã¯åˆæœŸå€¤ãŒç¢ºå®šå€¤ãªã®ã§ã€åˆå›è¡¨ç¤ºæ™‚ç‚¹ã§ä¿å­˜å¯èƒ½ã«ã™ã‚‹
  if (currentSubjectMeta?.specialType === 1 || currentSubjectMeta?.specialType === 2) {
    setUnsavedChanges(true);
  }
  else if (!criteriaState.items.length) {
    setInfoMessage(
      "ã“ã®ç§‘ç›®ã«ã¯è©•ä¾¡åŸºæº–ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚è©•ä¾¡åŸºæº–ç”»é¢ã§ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚"
    );
    infoMessageEl?.classList.add("warning-message");
  } else {
    infoMessageEl?.classList.remove("warning-message");
    setInfoMessage("æˆç¸¾ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ï¼ˆ0ã€œ100ç‚¹ã§å…¥åŠ›ï¼‰");

  }


    // è©•ä¾¡åŸºæº–ç”»é¢ã¸ã®ãƒªãƒ³ã‚¯ã‚’ subjectId ä»˜ãã«æ›´æ–°
    if (toEvaluationLink) {
      toEvaluationLink.href = `evaluation.html?subjectId=${encodeURIComponent(
        subjectId
      )}`;
    }

  ;
  if (
  window.__isEditMode === true ||   
    isSpecial ||
    currentSubjectMeta.isSkillLevel ||
  subject?.required === false   // â˜… é¸æŠç§‘ç›®ã¯å˜ä¸€
  ) {
    // ãƒ¦ãƒ‹ãƒƒãƒˆUIãªã—
  } else {
    renderGroupOrCourseFilter(subject);
  }


  if (
    !isSpecial &&
    !currentSubjectMeta.isSkillLevel &&
    subject?.required !== false &&   // â˜… é¸æŠç§‘ç›®ã¯é™¤å¤–
    currentSubjectMeta?.isCommon === true &&
    lastAutoAppliedCommonFilterSubjectId !== subjectId
  ) {
  if (!window.__isEditMode) {
    lastAutoAppliedCommonFilterSubjectId = subjectId;
    applyGroupOrCourseFilter(subject, "all");
  }
  }

    recalcFinalScoresAfterRestore(tbody);

    // â˜…é€”ä¸­å†é–‹ç›´å¾Œãƒ»æç”»ç›´å¾Œã«ä¸€æ‹¬é©ç”¨ï¼ˆFirestore readãªã—ï¼‰
  applyRiskClassesToAllRows();
  // removed dev logs: FINAL META / test marker
  // ãƒ˜ãƒƒãƒ€å´ã®å—è¬›è€…ç™»éŒ²ãƒœã‚¿ãƒ³è¡¨ç¤ºåˆ¶å¾¡ï¼ˆç§‘ç›®å¤‰æ›´æ™‚ã®æœ€å¾Œã«1å›ã ã‘ï¼‰
    // âœ… Excelãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ï¼šç§‘ç›®ãŒæˆç«‹ã—ãŸã‚‰æœ‰åŠ¹åŒ–ï¼ˆFirestore read ã¯ã—ãªã„ï¼‰
  const excelBtn = document.getElementById("excelDownloadBtn");
  if (excelBtn) {
    const isNormal = Number(subject?.specialType ?? currentSubjectMeta?.specialType ?? 0) === 0;

    // è¡¨ç¤ºï¼éè¡¨ç¤º
    excelBtn.style.display = isNormal ? "" : "none";

    // å¿µã®ãŸã‚ disable ã‚‚åŒæœŸ
    excelBtn.disabled = !isNormal;
  }
  updateElectiveRegistrationButtons(subject);
  // å¿µã®ãŸã‚ï¼šæå‡ºæ¸ˆãƒ­ãƒƒã‚¯ä¸­ã¯æœªä¿å­˜è­¦å‘Šã‚’å‡ºã•ãªã„
  const isScoreLocked = document.body.classList.contains("score-locked");
  // â€» ã“ã“ã§ handleSubjectChange ã‚’çµ‚äº†ã—ãªã„ï¼ˆä¸‹ã®ã€Œæå‡ºæ¸ˆã¿æ–‡è¨€å†è¡¨ç¤ºã€ã¾ã§å¿…ãšåˆ°é”ã•ã›ã‚‹ï¼‰

  const isSkillAllView =
    window.currentSubjectMeta?.isSkillLevel &&
    String(window.currentSkillFilter || "").toLowerCase() === "all";

  // ================================
  // â˜…æœ€çµ‚ï¼šãƒ­ãƒƒã‚¯çŠ¶æ…‹ã¯ applyReadOnlyState ã«çµ±ä¸€
  // ================================
  const filterKeyForReadOnly = (() => {
    if (window.currentSubjectMeta?.isSkillLevel) {
      return String(window.currentSkillFilter ?? "all").toLowerCase();
    }
    // é€šå¸¸ç§‘ç›®ã¯ "all" ã§ã‚‚ applyReadOnlyState ãŒ unlock ã—ã¦ãã‚Œã‚‹
    return "all";
  })();



  window.isSubjectChanging = false;

  }