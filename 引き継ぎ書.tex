🟦🔥【完全引き継ぎ書（次チャット貼り付け用｜最新版）】

📘 Firebase 成績入力システム（score_input）
STEP A〜C 完了 → STEP D（追加実装フェーズ）引き継ぎ書

✅ 1. 現在までに完全実装済み（STEP A〜C）
● STEP A：基礎機能

教員ログイン（Firebase Auth）

教員の担当科目ロード（teacherSubjects_YYYY）

評価基準ロード（evaluationCriteria_YYYY）

全学生ロード（students コレクション）

科目選択 → 対象学生をフィルタ＆ソートして表示

● STEP B：成績入力ロジック

raw/scaled（素点/自動換算）モード個別切替

エラーセルは赤枠（.ktc-input-error）

不正値は入力禁止＆警告

updateFinalScoreForRow() による個別再計算

updateAllFinalScores() による全体再計算

A方式（自動補正しない、安全重視方式）

● STEP C：組・コースフィルタ UI ✨完成

フィルタボタン（全員 / 1〜5組 または 全員 / M / E / I / CA）

KTCブルーのスタイリッシュ UI に刷新

active クラスで「選択中」が明確に視認可能

フィルタ切替 → 即テーブル再描画 → 成績再計算

subjects.html と UI 統一感あり

🔵 **現時点でのコード状態は完全に問題なし。

動作も UI も安定しており、次フェーズへ進む準備完了。**

🟦🚀 2. 次に実装する内容（STEP D：追加実装フェーズ）

以下の 4 つの新規機能を次チャットで順に実装します。
どれも現行構造と矛盾なく追加可能です。

✅ 追加実装１：選択科目の受講者登録モーダル（最重要）
■ 背景

選択科目は “必修ではない” ため、
全学生を表示するのではなく、
教員が受講者を登録してから成績入力を行う必要がある。

■ 実装内容

科目選択時、subject.course が "S"（選択科目）などの場合

モーダルウインドウを表示

その中に「全員分の名簿」を表示（学籍番号 / 学年 / 組 / 番号 / 氏名）

チェックボックスで「この学生は受講する」を選択

登録ボタン押下 → Firestore に保存（受講者リスト）

courseStudents_{year}/{subjectId} ドキュメント

保存形式：studentId の配列

成績入力画面には 登録された学生のみ 表示される

■ 追加ポイント

再表示時は既に登録したチェックを ON にした状態で表示

フィルタ（組/コース切替）時も登録済みだけが対象

名簿ソート、検索（学籍番号・名前）も拡張可能

✅ 追加実装２：評価基準の値（割合）を画面上部に常時表示
■ 目的

現在は評価基準がヘッダーにのみ表示されるが、
科目横（成績一覧のタイトル付近）にも常時表示させたい。

■ 表示例（スクショイメージ）
成績一覧　｜ 評価基準：期末考査 100%（自動換算）

■ 実装案

criteriaState.items を使い、
科目選択後 handleSubjectChange() 内で表示領域に書き出す。

✅ 追加実装３：受講者人数の表示（動的変更対応）
■ 仕様

成績一覧の横（タイトル付近）に「受講者人数：◯名」と表示

組・コースフィルタ切替時にも動的に更新

選択科目の場合は 登録済み受講者数、
通常科目の場合は フィルタ後学生数 を表示

■ 実装ポイント

renderStudentRows の直後または applyGroupOrCourseFilter の後で
studentState.currentStudents.length を参照して更新

✅ 追加実装４：評価基準＋平均点＋調整点の表示
■ 表示内容

評価基準（追加実装２の横に表示）

平均点：最終成績の平均値

調整点：平均点 × 0.7 → 切り上げ

最終成績が空欄の学生は平均点の計算に含めない

■ 表示例
評価基準：期末 100%
平均点：72.8点
調整点：51点（平均 × 0.7 → 切り上げ）

■ 計算タイミング

科目選択後

各学生の成績入力後

フィルタ切替後（「全員 → M」など）

■ 使用関数

updateAllFinalScores 内のロジックを拡張

または別関数 computeAverageScore(tbody)

🟦📘 3. 次チャットで作業開始するための「貼るだけ引き継ぎ文」

次のチャットを開いたら、以下をそのまま貼ってください👇

🟠【貼り付け用（次チャット開始文）】
【引き継ぎ】

Firebase 成績入力システム（score_input）は STEP A〜C まで実装済みです。

● STEP C までの実装状態
・組・コースフィルタを完全に実装（UI＋ロジック＋KTCブルーUI）
・updateAllFinalScores の import 修正済み
・students コレクションは courseClass に組番号が入る仕様（修正②は不要）
・score_input_loader / students / modes の全体構造は安定して動作中

● ここから追加実装したい内容（STEP D〜）

追加実装１：
　選択科目の場合、成績入力前に受講者登録モーダルを出す。
　全学生名簿＋チェックボックス → 登録 → 登録者のみ成績入力欄に表示。

追加実装２：
　科目名横・成績一覧上部に「評価基準（％）」を常時表示したい。

追加実装３：
　成績一覧タイトル横に「受講者人数：◯名」を表示。
　組・コースフィルタ切替時も動的に更新。

追加実装４：
　評価基準の横に「平均点」「調整点（平均×0.7 切り上げ）」を表示。
　平均点は最終成績が入っている学生のみで計算。

以上の４つを、既存構造を壊さず、安全に追加実装したい。